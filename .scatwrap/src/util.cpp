<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>src/util.cpp</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
#include &#20;&quot;util.h&quot;<br>
#include &#20;&lt;filesystem&gt;<br>
#include &#20;&lt;fstream&gt;<br>
#include &#20;&lt;iostream&gt; &#20;// &#20;у &#20;тебя &#20;уже &#20;есть &#20;для &#20;std::cerr<br>
#include &#20;&lt;sstream&gt;<br>
<br>
namespace &#20;fs &#20;= &#20;std::filesystem;<br>
<br>
extern &#20;bool &#20;g_use_absolute_paths;<br>
<br>
bool &#20;starts_with(const &#20;std::string &#20;&amp;s, &#20;const &#20;std::string &#20;&amp;prefix)<br>
{<br>
 &#20; &#20; &#20; &#20;return &#20;s.size() &#20;&gt;= &#20;prefix.size() &#20;&amp;&amp;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s.compare(0, &#20;prefix.size(), &#20;prefix) &#20;== &#20;0;<br>
}<br>
<br>
bool &#20;ends_with(const &#20;std::string &#20;&amp;s, &#20;const &#20;std::string &#20;&amp;suffix)<br>
{<br>
 &#20; &#20; &#20; &#20;return &#20;s.size() &#20;&gt;= &#20;suffix.size() &#20;&amp;&amp;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s.compare(s.size() &#20;- &#20;suffix.size(), &#20;suffix.size(), &#20;suffix) &#20;== &#20;0;<br>
}<br>
<br>
std::string &#20;make_display_path(const &#20;fs::path &#20;&amp;p)<br>
{<br>
 &#20; &#20; &#20; &#20;if &#20;(g_use_absolute_paths)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return &#20;fs::absolute(p).string();<br>
<br>
 &#20; &#20; &#20; &#20;std::error_code &#20;ec;<br>
 &#20; &#20; &#20; &#20;fs::path &#20;rel &#20;= &#20;fs::relative(p, &#20;fs::current_path(), &#20;ec);<br>
 &#20; &#20; &#20; &#20;if &#20;(!ec)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return &#20;rel.string();<br>
<br>
 &#20; &#20; &#20; &#20;return &#20;p.string();<br>
}<br>
<br>
void &#20;dump_file(const &#20;fs::path &#20;&amp;p, &#20;bool &#20;first, &#20;const &#20;Options &#20;&amp;opt)<br>
{<br>
 &#20; &#20; &#20; &#20;std::ifstream &#20;in(p, &#20;std::ios::binary);<br>
 &#20; &#20; &#20; &#20;if &#20;(!in)<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::cerr &#20;&lt;&lt; &#20;&quot;Cannot &#20;open: &#20;&quot; &#20;&lt;&lt; &#20;p &#20;&lt;&lt; &#20;&quot;\n&quot;;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return;<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;if &#20;(!first)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::cout &#20;&lt;&lt; &#20;&quot;\n&quot;;<br>
<br>
 &#20; &#20; &#20; &#20;std::cout &#20;&lt;&lt; &#20;&quot;===== &#20;&quot; &#20;&lt;&lt; &#20;make_display_path(p) &#20;&lt;&lt; &#20;&quot; &#20;=====\n&quot;;<br>
 &#20; &#20; &#20; &#20;// &#20;std::cout &#20;&lt;&lt; &#20;in.rdbuf() &#20;&lt;&lt; &#20;&quot;=EOF=\n&quot;;<br>
<br>
 &#20; &#20; &#20; &#20;std::string &#20;line;<br>
 &#20; &#20; &#20; &#20;size_t &#20;line_no &#20;= &#20;0;<br>
 &#20; &#20; &#20; &#20;while &#20;(std::getline(in, &#20;line))<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(opt.line_numbers)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::cout &#20;&lt;&lt; &#20;line_no &#20;&lt;&lt; &#20;&quot;: &#20;&quot; &#20;&lt;&lt; &#20;line &#20;&lt;&lt; &#20;&quot;\n&quot;;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;else<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::cout &#20;&lt;&lt; &#20;line &#20;&lt;&lt; &#20;&quot;\n&quot;;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;++line_no;<br>
 &#20; &#20; &#20; &#20;}<br>
}<br>
std::uintmax_t &#20;get_file_size(const &#20;fs::path &#20;&amp;p)<br>
{<br>
 &#20; &#20; &#20; &#20;std::error_code &#20;ec;<br>
 &#20; &#20; &#20; &#20;auto &#20;sz &#20;= &#20;fs::file_size(p, &#20;ec);<br>
 &#20; &#20; &#20; &#20;if &#20;(ec)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return &#20;0;<br>
 &#20; &#20; &#20; &#20;return &#20;sz;<br>
}<br>
<br>
bool &#20;match_simple(const &#20;fs::path &#20;&amp;p, &#20;const &#20;std::string &#20;&amp;pat)<br>
{<br>
 &#20; &#20; &#20; &#20;std::string &#20;name &#20;= &#20;p.filename().string();<br>
<br>
 &#20; &#20; &#20; &#20;if &#20;(pat &#20;== &#20;&quot;*&quot;)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return &#20;true;<br>
<br>
 &#20; &#20; &#20; &#20;auto &#20;pos &#20;= &#20;pat.find('*');<br>
 &#20; &#20; &#20; &#20;if &#20;(pos &#20;== &#20;std::string::npos)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return &#20;name &#20;== &#20;pat;<br>
<br>
 &#20; &#20; &#20; &#20;std::string &#20;a &#20;= &#20;pat.substr(0, &#20;pos);<br>
 &#20; &#20; &#20; &#20;std::string &#20;b &#20;= &#20;pat.substr(pos &#20;+ &#20;1);<br>
<br>
 &#20; &#20; &#20; &#20;return &#20;starts_with(name, &#20;a) &#20;&amp;&amp; &#20;ends_with(name, &#20;b);<br>
}<br>
<br>
std::string &#20;html_escape(std::string_view &#20;src)<br>
{<br>
 &#20; &#20; &#20; &#20;std::string &#20;out;<br>
 &#20; &#20; &#20; &#20;out.reserve(src.size() &#20;* &#20;11 &#20;/ &#20;10 &#20;+ &#20;16); &#20;// &#20;чуть &#20;с &#20;запасом<br>
<br>
 &#20; &#20; &#20; &#20;for &#20;(char &#20;ch &#20;: &#20;src)<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;switch &#20;(ch)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;case &#20;'&amp;':<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;out &#20;+= &#20;&quot;&amp;amp;&quot;;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;break;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;case &#20;'&lt;':<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;out &#20;+= &#20;&quot;&amp;lt;&quot;;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;break;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;case &#20;'&gt;':<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;out &#20;+= &#20;&quot;&amp;gt;&quot;;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;break;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;case &#20;'&quot;':<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;out &#20;+= &#20;&quot;&amp;quot;&quot;;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;break;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;default:<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;out.push_back(ch);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;break;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;return &#20;out;<br>
}<br>
<br>
std::string &#20;wrap_cpp_as_html(std::string_view &#20;cpp_code,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::string_view &#20;title)<br>
{<br>
 &#20; &#20; &#20; &#20;std::string &#20;html;<br>
 &#20; &#20; &#20; &#20;html.reserve(cpp_code.size() &#20;* &#20;11 &#20;/ &#20;10 &#20;+ &#20;256);<br>
<br>
 &#20; &#20; &#20; &#20;html &#20;+= &#20;&quot;&lt;!DOCTYPE &#20;html&gt;\n&quot;;<br>
 &#20; &#20; &#20; &#20;html &#20;+= &#20;&quot;&lt;html &#20;lang=\&quot;en\&quot;&gt;\n&quot;;<br>
 &#20; &#20; &#20; &#20;html &#20;+= &#20;&quot;&lt;head&gt;\n&quot;;<br>
 &#20; &#20; &#20; &#20;html &#20;+= &#20;&quot; &#20; &#20;&lt;meta &#20;charset=\&quot;UTF-8\&quot;&gt;\n&quot;;<br>
 &#20; &#20; &#20; &#20;html &#20;+= &#20;&quot; &#20; &#20;&lt;title&gt;&quot;;<br>
 &#20; &#20; &#20; &#20;html &#20;+= &#20;html_escape(title); &#20; &#20; &#20; &#20; &#20; &#20;// &#20;title &#20;экранируем, &#20;пробелы &#20;оставляем &#20;обычными<br>
 &#20; &#20; &#20; &#20;html &#20;+= &#20;&quot;&lt;/title&gt;\n&quot;;<br>
 &#20; &#20; &#20; &#20;html &#20;+= &#20;&quot;&lt;/head&gt;\n&quot;;<br>
 &#20; &#20; &#20; &#20;html &#20;+= &#20;&quot;&lt;body&gt;\n&quot;;<br>
<br>
 &#20; &#20; &#20; &#20;html &#20;+= &#20;&quot;&lt;!-- &#20;BEGIN &#20;SCAT &#20;CODE &#20;--&gt;\n&quot;;<br>
<br>
 &#20; &#20; &#20; &#20;std::size_t &#20;pos &#20;= &#20;0;<br>
 &#20; &#20; &#20; &#20;const &#20;std::size_t &#20;n &#20;= &#20;cpp_code.size();<br>
<br>
 &#20; &#20; &#20; &#20;while &#20;(pos &#20;&lt; &#20;n)<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::size_t &#20;nl &#20;= &#20;cpp_code.find('\n', &#20;pos);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(nl &#20;== &#20;std::string_view::npos)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;nl &#20;= &#20;n;<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::string_view &#20;line &#20;= &#20;cpp_code.substr(pos, &#20;nl &#20;- &#20;pos);<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;1) &#20;экранируем &#20;спецсимволы &#20;(&amp;, &#20;&lt;, &#20;&gt;, &#20;&quot;)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::string &#20;escaped &#20;= &#20;html_escape(line);<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;2) &#20;превращаем &#20;каждый &#20;пробел &#20;в &#20;&amp;nbsp;, &#20;чтобы &#20;отступы &#20;не &#20;схлопывались<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;for &#20;(char &#20;ch &#20;: &#20;escaped)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(ch &#20;== &#20;' &#20;')<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;html &#20;+= &#20;&quot; &#20;&amp;#20;&quot;;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;else<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;html.push_back(ch);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;html &#20;+= &#20;&quot;&lt;br&gt;\n&quot;;<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;pos &#20;= &#20;nl &#20;+ &#20;1;<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;html &#20;+= &#20;&quot;&lt;!-- &#20;END &#20;SCAT &#20;CODE &#20;--&gt;\n&quot;;<br>
<br>
 &#20; &#20; &#20; &#20;html &#20;+= &#20;&quot;&lt;/body&gt;\n&quot;;<br>
 &#20; &#20; &#20; &#20;html &#20;+= &#20;&quot;&lt;/html&gt;\n&quot;;<br>
<br>
 &#20; &#20; &#20; &#20;return &#20;html;<br>
}<br>
<br>
<br>
<!-- END SCAT CODE -->
</body>
</html>
