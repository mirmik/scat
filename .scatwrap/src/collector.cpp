<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>src/collector.cpp</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
#include&#32;&quot;collector.h&quot;<br>
#include&#32;&quot;glob.h&quot;<br>
#include&#32;&quot;util.h&quot;<br>
#include&#32;&lt;algorithm&gt;<br>
#include&#32;&lt;filesystem&gt;<br>
#include&#32;&lt;functional&gt;<br>
#include&#32;&lt;iostream&gt;<br>
#include&#32;&lt;sstream&gt;<br>
#include&#32;&lt;unordered_set&gt;<br>
<br>
namespace&#32;fs&#32;=&#32;std::filesystem;<br>
<br>
//&#32;---------------------------------------------------------------<br>
//&#32;Вспомогалки&#32;для&#32;glob<br>
//&#32;---------------------------------------------------------------<br>
<br>
//&#32;pattern&#32;like:&#32;&#32;&quot;src/*&quot;&#32;&#32;or&#32;&#32;&quot;datas/**&quot;<br>
static&#32;bool&#32;has_double_star(const&#32;std::string&#32;&amp;s)<br>
{<br>
&#32;&#32;&#32;&#32;return&#32;s.find(&quot;**&quot;)&#32;!=&#32;std::string::npos;<br>
}<br>
<br>
static&#32;bool&#32;has_single_star(const&#32;std::string&#32;&amp;s)<br>
{<br>
&#32;&#32;&#32;&#32;return&#32;s.find('*')&#32;!=&#32;std::string::npos&#32;&amp;&amp;&#32;!has_double_star(s);<br>
}<br>
<br>
//&#32;Расширение&#32;одного&#32;правила<br>
static&#32;void&#32;expand_rule(const&#32;Rule&#32;&amp;r,&#32;std::vector&lt;fs::path&gt;&#32;&amp;out)<br>
{<br>
&#32;&#32;&#32;&#32;const&#32;std::string&#32;&amp;pat&#32;=&#32;r.pattern;<br>
&#32;&#32;&#32;&#32;std::error_code&#32;ec;<br>
<br>
&#32;&#32;&#32;&#32;//&#32;------------------------------------------------------------------<br>
&#32;&#32;&#32;&#32;//&#32;новый&#32;glob&#32;—&#32;вынесен&#32;в&#32;glob.cpp<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;auto&#32;v&#32;=&#32;expand_glob(pat);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out.insert(out.end(),&#32;v.begin(),&#32;v.end());<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;//&#32;====&#32;*&#32;(one&#32;level)&#32;====<br>
&#32;&#32;&#32;&#32;if&#32;(has_single_star(pat))<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;fs::path&#32;dir&#32;=&#32;fs::path(pat).parent_path();<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::string&#32;mask&#32;=&#32;fs::path(pat).filename().string();<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(!fs::exists(dir,&#32;ec)&#32;||&#32;!fs::is_directory(dir,&#32;ec))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return;<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;for&#32;(auto&#32;&amp;e&#32;:&#32;fs::directory_iterator(dir,&#32;ec))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(e.is_regular_file()&#32;&amp;&amp;&#32;match_simple(e.path(),&#32;mask))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out.push_back(e.path());<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;//&#32;====&#32;Прямой&#32;путь&#32;====<br>
&#32;&#32;&#32;&#32;fs::path&#32;p&#32;=&#32;pat;<br>
<br>
&#32;&#32;&#32;&#32;if&#32;(fs::is_regular_file(p,&#32;ec))<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out.push_back(fs::canonical(p,&#32;ec));<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;if&#32;(fs::is_directory(p,&#32;ec))<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;for&#32;(auto&#32;&amp;e&#32;:&#32;fs::directory_iterator(p,&#32;ec))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(e.is_regular_file())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out.push_back(e.path());<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return;<br>
&#32;&#32;&#32;&#32;}<br>
}<br>
<br>
//&#32;---------------------------------------------------------------<br>
//&#32;collect_from_rules()<br>
//&#32;---------------------------------------------------------------<br>
<br>
std::vector&lt;fs::path&gt;&#32;collect_from_rules(const&#32;std::vector&lt;Rule&gt;&#32;&amp;rules,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;const&#32;Options&#32;&amp;opt)<br>
{<br>
&#32;&#32;&#32;&#32;std::vector&lt;fs::path&gt;&#32;tmp;<br>
&#32;&#32;&#32;&#32;std::error_code&#32;ec;<br>
<br>
&#32;&#32;&#32;&#32;//&#32;1.&#32;Собираем&#32;все&#32;include-рулы<br>
&#32;&#32;&#32;&#32;for&#32;(const&#32;auto&#32;&amp;r&#32;:&#32;rules)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(!r.exclude)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;expand_rule(r,&#32;tmp);<br>
<br>
&#32;&#32;&#32;&#32;//&#32;2.&#32;Применяем&#32;exclude-рулы&#32;через&#32;нормальный&#32;glob<br>
&#32;&#32;&#32;&#32;for&#32;(const&#32;auto&#32;&amp;r&#32;:&#32;rules)<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(!r.exclude)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;continue;<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;auto&#32;bad&#32;=&#32;expand_glob(r.pattern);<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::unordered_set&lt;std::string&gt;&#32;bad_abs;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;bad_abs.reserve(bad.size());<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;for&#32;(auto&#32;&amp;b&#32;:&#32;bad)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::error_code&#32;ec;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;auto&#32;absb&#32;=&#32;fs::absolute(b,&#32;ec);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;bad_abs.insert(absb.string());<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;tmp.erase(std::remove_if(tmp.begin(),<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;tmp.end(),<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;[&amp;](const&#32;fs::path&#32;&amp;p)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::error_code&#32;ec;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;auto&#32;absp&#32;=&#32;fs::absolute(p,&#32;ec);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return&#32;bad_abs.find(absp.string())&#32;!=<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;bad_abs.end();<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}),<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;tmp.end());<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;//&#32;3.&#32;Убираем&#32;дубликаты<br>
&#32;&#32;&#32;&#32;std::sort(tmp.begin(),&#32;tmp.end());<br>
&#32;&#32;&#32;&#32;tmp.erase(std::unique(tmp.begin(),&#32;tmp.end()),&#32;tmp.end());<br>
<br>
&#32;&#32;&#32;&#32;return&#32;tmp;<br>
}<br>
<br>
//&#32;---------------------------------------------------------------<br>
//&#32;collect_from_paths()<br>
//&#32;---------------------------------------------------------------<br>
<br>
std::vector&lt;fs::path&gt;&#32;collect_from_paths(const&#32;std::vector&lt;std::string&gt;&#32;&amp;paths,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;const&#32;Options&#32;&amp;opt)<br>
{<br>
&#32;&#32;&#32;&#32;std::vector&lt;fs::path&gt;&#32;out;<br>
<br>
&#32;&#32;&#32;&#32;for&#32;(auto&#32;&amp;s&#32;:&#32;paths)<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;fs::path&#32;p&#32;=&#32;s;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::error_code&#32;ec;<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(!fs::exists(p,&#32;ec))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::cerr&#32;&lt;&lt;&#32;&quot;Not&#32;found:&#32;&quot;&#32;&lt;&lt;&#32;p&#32;&lt;&lt;&#32;&quot;\n&quot;;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;continue;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(fs::is_regular_file(p,&#32;ec))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out.push_back(fs::canonical(p,&#32;ec));<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;continue;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(fs::is_directory(p,&#32;ec))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(opt.recursive)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;for&#32;(auto&#32;&amp;e&#32;:&#32;fs::recursive_directory_iterator(p,&#32;ec))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(e.is_regular_file())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out.push_back(e.path());<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;else<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;for&#32;(auto&#32;&amp;e&#32;:&#32;fs::directory_iterator(p,&#32;ec))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(e.is_regular_file())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out.push_back(e.path());<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;//&#32;Убираем&#32;дубликаты<br>
&#32;&#32;&#32;&#32;std::sort(out.begin(),&#32;out.end());<br>
&#32;&#32;&#32;&#32;out.erase(std::unique(out.begin(),&#32;out.end()),&#32;out.end());<br>
<br>
&#32;&#32;&#32;&#32;return&#32;out;<br>
}<br>
<!-- END SCAT CODE -->
</body>
</html>
