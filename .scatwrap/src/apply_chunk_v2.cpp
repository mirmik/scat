<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>src/apply_chunk_v2.cpp</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
#include &#20;&quot;symbols.h&quot;<br>
#include &#20;&lt;algorithm&gt;<br>
#include &#20;&lt;cctype&gt;<br>
#include &#20;&lt;filesystem&gt;<br>
#include &#20;&lt;fstream&gt;<br>
#include &#20;&lt;iostream&gt;<br>
#include &#20;&lt;map&gt;<br>
#include &#20;&lt;sstream&gt;<br>
#include &#20;&lt;stdexcept&gt;<br>
#include &#20;&lt;string&gt;<br>
#include &#20;&lt;string_view&gt;<br>
#include &#20;&lt;vector&gt;<br>
<br>
namespace &#20;fs &#20;= &#20;std::filesystem;<br>
<br>
struct &#20;Section<br>
{<br>
 &#20; &#20; &#20; &#20;std::string &#20;filepath;<br>
 &#20; &#20; &#20; &#20;std::string &#20;command;<br>
 &#20; &#20; &#20; &#20;int &#20;a &#20;= &#20;-1;<br>
 &#20; &#20; &#20; &#20;int &#20;b &#20;= &#20;-1;<br>
 &#20; &#20; &#20; &#20;std::vector&lt;std::string&gt; &#20;payload;<br>
 &#20; &#20; &#20; &#20;std::vector&lt;std::string&gt; &#20;marker;<br>
 &#20; &#20; &#20; &#20;std::vector&lt;std::string&gt; &#20;before; &#20;// &#20;контекст &#20;до &#20;маркера &#20;(BEFORE:)<br>
 &#20; &#20; &#20; &#20;std::vector&lt;std::string&gt; &#20;after; &#20;// &#20;контекст &#20;после &#20;маркера &#20;(AFTER:)<br>
 &#20; &#20; &#20; &#20;int &#20;seq &#20;= &#20;0;<br>
 &#20; &#20; &#20; &#20;std::string &#20;arg1; &#20;// &#20;доп. &#20;аргументы &#20;команды &#20;(например, &#20;имя &#20;класса)<br>
 &#20; &#20; &#20; &#20;std::string &#20;arg2; &#20;// &#20;второй &#20;аргумент &#20;(например, &#20;имя &#20;метода)<br>
};<br>
<br>
static &#20;std::vector&lt;std::string&gt; &#20;read_file_lines(const &#20;fs::path &#20;&amp;p)<br>
{<br>
 &#20; &#20; &#20; &#20;std::ifstream &#20;in(p);<br>
 &#20; &#20; &#20; &#20;if &#20;(!in)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(&quot;cannot &#20;open &#20;file: &#20;&quot; &#20;+ &#20;p.string());<br>
<br>
 &#20; &#20; &#20; &#20;std::vector&lt;std::string&gt; &#20;out;<br>
 &#20; &#20; &#20; &#20;std::string &#20;line;<br>
 &#20; &#20; &#20; &#20;while &#20;(std::getline(in, &#20;line))<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;out.push_back(line);<br>
<br>
 &#20; &#20; &#20; &#20;return &#20;out;<br>
}<br>
<br>
static &#20;void &#20;write_file_lines(const &#20;fs::path &#20;&amp;p,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;const &#20;std::vector&lt;std::string&gt; &#20;&amp;lines)<br>
{<br>
 &#20; &#20; &#20; &#20;std::ofstream &#20;out(p, &#20;std::ios::trunc);<br>
 &#20; &#20; &#20; &#20;if &#20;(!out)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(&quot;cannot &#20;write &#20;file: &#20;&quot; &#20;+ &#20;p.string());<br>
<br>
 &#20; &#20; &#20; &#20;for &#20;(const &#20;auto &#20;&amp;s &#20;: &#20;lines)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;out &#20;&lt;&lt; &#20;s &#20;&lt;&lt; &#20;&quot;\n&quot;;<br>
}<br>
<br>
std::string &#20;trim(const &#20;std::string_view &#20;&amp;view)<br>
{<br>
 &#20; &#20; &#20; &#20;if &#20;(view.size() &#20;== &#20;0)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return &#20;&quot;&quot;;<br>
<br>
 &#20; &#20; &#20; &#20;const &#20;char &#20;*left &#20;= &#20;view.data();<br>
 &#20; &#20; &#20; &#20;const &#20;char &#20;*right &#20;= &#20;view.data() &#20;+ &#20;view.size() &#20;- &#20;1;<br>
 &#20; &#20; &#20; &#20;const &#20;char &#20;*end &#20;= &#20;view.data() &#20;+ &#20;view.size();<br>
<br>
 &#20; &#20; &#20; &#20;while &#20;(left &#20;!= &#20;end &#20;&amp;&amp;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;(*left &#20;== &#20;' &#20;' &#20;|| &#20;*left &#20;== &#20;'\n' &#20;|| &#20;*left &#20;== &#20;'\r' &#20;|| &#20;*left &#20;== &#20;'\t'))<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;++left;<br>
<br>
 &#20; &#20; &#20; &#20;if &#20;(left &#20;== &#20;end)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return &#20;&quot;&quot;;<br>
<br>
 &#20; &#20; &#20; &#20;while &#20;(left &#20;!= &#20;right &#20;&amp;&amp; &#20;(*right &#20;== &#20;' &#20;' &#20;|| &#20;*right &#20;== &#20;'\n' &#20;||<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;*right &#20;== &#20;'\r' &#20;|| &#20;*right &#20;== &#20;'\t'))<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;--right;<br>
<br>
 &#20; &#20; &#20; &#20;return &#20;std::string(left, &#20;(right &#20;- &#20;left) &#20;+ &#20;1);<br>
}<br>
<br>
static &#20;bool &#20;is_text_command(const &#20;std::string &#20;&amp;cmd)<br>
{<br>
 &#20; &#20; &#20; &#20;return &#20;cmd &#20;== &#20;&quot;insert-after-text&quot; &#20;|| &#20;cmd &#20;== &#20;&quot;insert-before-text&quot; &#20;||<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;cmd &#20;== &#20;&quot;replace-text&quot; &#20;|| &#20;cmd &#20;== &#20;&quot;delete-text&quot;;<br>
}<br>
<br>
static &#20;bool &#20;is_symbol_command(const &#20;std::string &#20;&amp;cmd)<br>
{<br>
 &#20; &#20; &#20; &#20;return &#20;cmd &#20;== &#20;&quot;replace-cpp-method&quot; &#20;|| &#20;cmd &#20;== &#20;&quot;replace-cpp-class&quot; &#20;||<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;cmd &#20;== &#20;&quot;replace-py-method&quot; &#20;|| &#20;cmd &#20;== &#20;&quot;replace-py-class&quot;;<br>
}<br>
<br>
static &#20;int &#20;find_subsequence(const &#20;std::vector&lt;std::string&gt; &#20;&amp;haystack,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;const &#20;std::vector&lt;std::string&gt; &#20;&amp;needle)<br>
{<br>
 &#20; &#20; &#20; &#20;if &#20;(needle.empty() &#20;|| &#20;needle.size() &#20;&gt; &#20;haystack.size())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return &#20;-1;<br>
<br>
 &#20; &#20; &#20; &#20;const &#20;std::size_t &#20;n &#20;= &#20;haystack.size();<br>
 &#20; &#20; &#20; &#20;const &#20;std::size_t &#20;m &#20;= &#20;needle.size();<br>
<br>
 &#20; &#20; &#20; &#20;for &#20;(std::size_t &#20;i &#20;= &#20;0; &#20;i &#20;+ &#20;m &#20;&lt;= &#20;n; &#20;++i)<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;bool &#20;ok &#20;= &#20;true;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;for &#20;(std::size_t &#20;j &#20;= &#20;0; &#20;j &#20;&lt; &#20;m; &#20;++j)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::string &#20;h &#20;= &#20;trim(haystack[i &#20;+ &#20;j]);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::string &#20;nn &#20;= &#20;trim(needle[j]);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(h &#20;!= &#20;nn)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;ok &#20;= &#20;false;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;break;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(ok)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return &#20;static_cast&lt;int&gt;(i);<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;return &#20;-1;<br>
}<br>
<br>
// &#20;Строгий &#20;выбор &#20;позиции &#20;маркера &#20;с &#20;учётом &#20;BEFORE/AFTER.<br>
// &#20;Никакого &#20;fuzzy, &#20;только &#20;точное &#20;позиционное &#20;совпадение.<br>
static &#20;int &#20;find_best_marker_match(const &#20;std::vector&lt;std::string&gt; &#20;&amp;lines,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;const &#20;Section &#20;*s,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;const &#20;std::vector&lt;int&gt; &#20;&amp;candidates)<br>
{<br>
 &#20; &#20; &#20; &#20;if &#20;(candidates.empty())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return &#20;-1;<br>
<br>
 &#20; &#20; &#20; &#20;// &#20;Нет &#20;дополнительного &#20;контекста &#20;— &#20;ведём &#20;себя &#20;как &#20;раньше.<br>
 &#20; &#20; &#20; &#20;if &#20;(s-&gt;before.empty() &#20;&amp;&amp; &#20;s-&gt;after.empty())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return &#20;candidates.front();<br>
<br>
 &#20; &#20; &#20; &#20;auto &#20;trim_eq &#20;= &#20;[&amp;](const &#20;std::string &#20;&amp;a, &#20;const &#20;std::string &#20;&amp;b)<br>
 &#20; &#20; &#20; &#20;{ &#20;return &#20;trim(a) &#20;== &#20;trim(b); &#20;};<br>
<br>
 &#20; &#20; &#20; &#20;std::vector&lt;int&gt; &#20;strict;<br>
<br>
 &#20; &#20; &#20; &#20;for &#20;(int &#20;pos &#20;: &#20;candidates)<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;bool &#20;ok &#20;= &#20;true;<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;BEFORE: &#20;строки &#20;сразу &#20;над &#20;маркером<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(!s-&gt;before.empty())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;int &#20;need &#20;= &#20;static_cast&lt;int&gt;(s-&gt;before.size());<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(pos &#20;&lt; &#20;need)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;ok &#20;= &#20;false;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;else<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;Последняя &#20;строка &#20;BEFORE &#20;должна &#20;быть &#20;непосредственно &#20;над<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;первой &#20;строкой &#20;маркера.<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;for &#20;(int &#20;i &#20;= &#20;0; &#20;i &#20;&lt; &#20;need; &#20;++i)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;const &#20;std::string &#20;&amp;want &#20;=<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s-&gt;before[static_cast&lt;std::size_t&gt;(need &#20;- &#20;1 &#20;- &#20;i)];<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;const &#20;std::string &#20;&amp;got &#20;=<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;lines[static_cast&lt;std::size_t&gt;(pos &#20;- &#20;1 &#20;- &#20;i)];<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(!trim_eq(got, &#20;want))<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;ok &#20;= &#20;false;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;break;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;AFTER: &#20;строки &#20;сразу &#20;под &#20;маркером<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(ok &#20;&amp;&amp; &#20;!s-&gt;after.empty())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;int &#20;start &#20;= &#20;pos &#20;+ &#20;static_cast&lt;int&gt;(s-&gt;marker.size());<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;int &#20;need &#20;= &#20;static_cast&lt;int&gt;(s-&gt;after.size());<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(start &#20;&lt; &#20;0 &#20;|| &#20;start &#20;+ &#20;need &#20;&gt; &#20;static_cast&lt;int&gt;(lines.size()))<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;ok &#20;= &#20;false;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;else<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;for &#20;(int &#20;i &#20;= &#20;0; &#20;i &#20;&lt; &#20;need; &#20;++i)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;const &#20;std::string &#20;&amp;want &#20;=<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s-&gt;after[static_cast&lt;std::size_t&gt;(i)];<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;const &#20;std::string &#20;&amp;got &#20;=<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;lines[static_cast&lt;std::size_t&gt;(start &#20;+ &#20;i)];<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(!trim_eq(got, &#20;want))<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;ok &#20;= &#20;false;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;break;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(ok)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;strict.push_back(pos);<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;if &#20;(strict.empty())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(&quot;strict &#20;marker &#20;context &#20;not &#20;found&quot;);<br>
<br>
 &#20; &#20; &#20; &#20;if &#20;(strict.size() &#20;&gt; &#20;1)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(&quot;strict &#20;marker &#20;match &#20;is &#20;ambiguous&quot;);<br>
<br>
 &#20; &#20; &#20; &#20;return &#20;strict.front();<br>
}<br>
<br>
static &#20;void &#20;apply_text_commands(const &#20;std::string &#20;&amp;filepath,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::vector&lt;std::string&gt; &#20;&amp;lines,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;const &#20;std::vector&lt;const &#20;Section &#20;*&gt; &#20;&amp;sections)<br>
{<br>
 &#20; &#20; &#20; &#20;for &#20;(const &#20;Section &#20;*s &#20;: &#20;sections)<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(s-&gt;marker.empty())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(&quot;empty &#20;marker &#20;in &#20;text &#20;command &#20;for &#20;file: &#20;&quot; &#20;+<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;filepath);<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;Собираем &#20;все &#20;вхождения &#20;маркера<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::vector&lt;int&gt; &#20;candidates;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;int &#20;base &#20;= &#20;0;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;while &#20;(base &#20;&lt; &#20;static_cast&lt;int&gt;(lines.size()))<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::vector&lt;std::string&gt; &#20;sub(lines.begin() &#20;+ &#20;base, &#20;lines.end());<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;int &#20;idx &#20;= &#20;find_subsequence(sub, &#20;s-&gt;marker);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(idx &#20;&lt; &#20;0)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;break;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;candidates.push_back(base &#20;+ &#20;idx);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;base &#20;+= &#20;idx &#20;+ &#20;1;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(candidates.empty())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;text &#20;marker &#20;not &#20;found &#20;for &#20;file: &#20;&quot; &#20;+ &#20;filepath &#20;+<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;\ncommand: &#20;&quot; &#20;+ &#20;s-&gt;command &#20;+ &#20;&quot;\n&quot;);<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;int &#20;idx &#20;= &#20;find_best_marker_match(lines, &#20;s, &#20;candidates);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(idx &#20;&lt; &#20;0)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(&quot;cannot &#20;locate &#20;marker &#20;uniquely&quot;);<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::size_t &#20;pos &#20;= &#20;static_cast&lt;std::size_t&gt;(idx);<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(s-&gt;command &#20;== &#20;&quot;insert-after-text&quot;)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;pos &#20;+= &#20;s-&gt;marker.size();<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;lines.insert(lines.begin() &#20;+ &#20;static_cast&lt;std::ptrdiff_t&gt;(pos),<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s-&gt;payload.begin(),<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s-&gt;payload.end());<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;else &#20;if &#20;(s-&gt;command &#20;== &#20;&quot;insert-before-text&quot;)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;lines.insert(lines.begin() &#20;+ &#20;static_cast&lt;std::ptrdiff_t&gt;(pos),<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s-&gt;payload.begin(),<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s-&gt;payload.end());<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;else &#20;if &#20;(s-&gt;command &#20;== &#20;&quot;replace-text&quot;)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;auto &#20;begin &#20;= &#20;lines.begin() &#20;+ &#20;static_cast&lt;std::ptrdiff_t&gt;(pos);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;auto &#20;end &#20;= &#20;begin &#20;+ &#20;static_cast&lt;std::ptrdiff_t&gt;(s-&gt;marker.size());<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;lines.erase(begin, &#20;end);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;lines.insert(lines.begin() &#20;+ &#20;static_cast&lt;std::ptrdiff_t&gt;(pos),<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s-&gt;payload.begin(),<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s-&gt;payload.end());<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;else &#20;if &#20;(s-&gt;command &#20;== &#20;&quot;delete-text&quot;)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;auto &#20;begin &#20;= &#20;lines.begin() &#20;+ &#20;static_cast&lt;std::ptrdiff_t&gt;(pos);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;auto &#20;end &#20;= &#20;begin &#20;+ &#20;static_cast&lt;std::ptrdiff_t&gt;(s-&gt;marker.size());<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;lines.erase(begin, &#20;end);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;else<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(&quot;unknown &#20;text &#20;command: &#20;&quot; &#20;+ &#20;s-&gt;command);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20;}<br>
}<br>
<br>
static &#20;std::string &#20;join_lines(const &#20;std::vector&lt;std::string&gt; &#20;&amp;lines)<br>
{<br>
 &#20; &#20; &#20; &#20;if &#20;(lines.empty())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return &#20;std::string();<br>
<br>
 &#20; &#20; &#20; &#20;std::string &#20;text;<br>
 &#20; &#20; &#20; &#20;std::size_t &#20;total &#20;= &#20;0;<br>
 &#20; &#20; &#20; &#20;for &#20;(const &#20;auto &#20;&amp;s &#20;: &#20;lines)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;total &#20;+= &#20;s.size() &#20;+ &#20;1;<br>
 &#20; &#20; &#20; &#20;text.reserve(total);<br>
<br>
 &#20; &#20; &#20; &#20;for &#20;(std::size_t &#20;i &#20;= &#20;0; &#20;i &#20;&lt; &#20;lines.size(); &#20;++i)<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;text &#20;+= &#20;lines[i];<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(i &#20;+ &#20;1 &#20;&lt; &#20;lines.size())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;text &#20;+= &#20;'\n';<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;return &#20;text;<br>
}<br>
<br>
static &#20;void &#20;apply_symbol_commands(const &#20;std::string &#20;&amp;filepath,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::vector&lt;std::string&gt; &#20;&amp;lines,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;const &#20;std::vector&lt;const &#20;Section &#20;*&gt; &#20;&amp;sections)<br>
{<br>
 &#20; &#20; &#20; &#20;for &#20;(const &#20;Section &#20;*s &#20;: &#20;sections)<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;Всегда &#20;работаем &#20;с &#20;текущей &#20;версией &#20;файла<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::string &#20;text &#20;= &#20;join_lines(lines);<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(s-&gt;command &#20;== &#20;&quot;replace-cpp-class&quot; &#20;||<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s-&gt;command &#20;== &#20;&quot;replace-cpp-method&quot;)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;CppSymbolFinder &#20;finder(text);<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(s-&gt;command &#20;== &#20;&quot;replace-cpp-class&quot;)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(s-&gt;arg1.empty())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;replace-cpp-class: &#20;missing &#20;class &#20;name &#20;for &#20;file: &#20;&quot; &#20;+<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;filepath);<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;Region &#20;r;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(!finder.find_class(s-&gt;arg1, &#20;r))<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;replace-cpp-class: &#20;class &#20;not &#20;found: &#20;&quot; &#20;+ &#20;s-&gt;arg1 &#20;+<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot; &#20;in &#20;file: &#20;&quot; &#20;+ &#20;filepath);<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(r.start_line &#20;&lt; &#20;0 &#20;|| &#20;r.end_line &#20;&lt; &#20;r.start_line &#20;||<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;r.end_line &#20;&gt;= &#20;static_cast&lt;int&gt;(lines.size()))<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;replace-cpp-class: &#20;invalid &#20;region&quot;);<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;auto &#20;begin &#20;= &#20;lines.begin() &#20;+ &#20;r.start_line;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;auto &#20;end &#20;= &#20;lines.begin() &#20;+ &#20;(r.end_line &#20;+ &#20;1);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;lines.erase(begin, &#20;end);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;lines.insert(lines.begin() &#20;+ &#20;r.start_line,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s-&gt;payload.begin(),<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s-&gt;payload.end());<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;else &#20;// &#20;replace-cpp-method<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::string &#20;cls;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::string &#20;method;<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(!s-&gt;arg2.empty())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;cls &#20;= &#20;s-&gt;arg1;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;method &#20;= &#20;s-&gt;arg2;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;else<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;auto &#20;pos &#20;= &#20;s-&gt;arg1.find(&quot;::&quot;);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(pos &#20;== &#20;std::string::npos)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;replace-cpp-method: &#20;expected &#20;'Class::method' &#20;or &#20;&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;'Class &#20;method'&quot;);<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;cls &#20;= &#20;s-&gt;arg1.substr(0, &#20;pos);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;method &#20;= &#20;s-&gt;arg1.substr(pos &#20;+ &#20;2);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(cls.empty() &#20;|| &#20;method.empty())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;replace-cpp-method: &#20;empty &#20;class &#20;or &#20;method &#20;name&quot;);<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;Region &#20;r;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(!finder.find_method(cls, &#20;method, &#20;r))<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;replace-cpp-method: &#20;method &#20;not &#20;found: &#20;&quot; &#20;+ &#20;cls &#20;+<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;::&quot; &#20;+ &#20;method &#20;+ &#20;&quot; &#20;in &#20;file: &#20;&quot; &#20;+ &#20;filepath);<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(r.start_line &#20;&lt; &#20;0 &#20;|| &#20;r.end_line &#20;&lt; &#20;r.start_line &#20;||<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;r.end_line &#20;&gt;= &#20;static_cast&lt;int&gt;(lines.size()))<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;replace-cpp-method: &#20;invalid &#20;region&quot;);<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;auto &#20;begin &#20;= &#20;lines.begin() &#20;+ &#20;r.start_line;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;auto &#20;end &#20;= &#20;lines.begin() &#20;+ &#20;(r.end_line &#20;+ &#20;1);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;lines.erase(begin, &#20;end);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;lines.insert(lines.begin() &#20;+ &#20;r.start_line,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s-&gt;payload.begin(),<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s-&gt;payload.end());<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;continue;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(s-&gt;command &#20;== &#20;&quot;replace-py-class&quot; &#20;||<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s-&gt;command &#20;== &#20;&quot;replace-py-method&quot;)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;PythonSymbolFinder &#20;finder(text);<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(s-&gt;command &#20;== &#20;&quot;replace-py-class&quot;)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(s-&gt;arg1.empty())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;replace-py-class: &#20;missing &#20;class &#20;name &#20;for &#20;file: &#20;&quot; &#20;+<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;filepath);<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;Region &#20;r;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(!finder.find_class(s-&gt;arg1, &#20;r))<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;replace-py-class: &#20;class &#20;not &#20;found: &#20;&quot; &#20;+ &#20;s-&gt;arg1 &#20;+<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot; &#20;in &#20;file: &#20;&quot; &#20;+ &#20;filepath);<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(r.start_line &#20;&lt; &#20;0 &#20;|| &#20;r.end_line &#20;&lt; &#20;r.start_line &#20;||<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;r.end_line &#20;&gt;= &#20;static_cast&lt;int&gt;(lines.size()))<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;replace-py-class: &#20;invalid &#20;region&quot;);<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;auto &#20;begin &#20;= &#20;lines.begin() &#20;+ &#20;r.start_line;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;auto &#20;end &#20;= &#20;lines.begin() &#20;+ &#20;(r.end_line &#20;+ &#20;1);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;lines.erase(begin, &#20;end);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;lines.insert(lines.begin() &#20;+ &#20;r.start_line,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s-&gt;payload.begin(),<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s-&gt;payload.end());<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;else &#20;// &#20;replace-py-method<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::string &#20;cls;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::string &#20;method;<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(!s-&gt;arg2.empty())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;cls &#20;= &#20;s-&gt;arg1;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;method &#20;= &#20;s-&gt;arg2;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;else<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;auto &#20;pos &#20;= &#20;s-&gt;arg1.find('.');<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(pos &#20;== &#20;std::string::npos)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;replace-py-method: &#20;expected &#20;'Class.method' &#20;or &#20;&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;'Class &#20;method'&quot;);<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;cls &#20;= &#20;s-&gt;arg1.substr(0, &#20;pos);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;method &#20;= &#20;s-&gt;arg1.substr(pos &#20;+ &#20;1);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(cls.empty() &#20;|| &#20;method.empty())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;replace-py-method: &#20;empty &#20;class &#20;or &#20;method &#20;name&quot;);<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;Region &#20;r;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(!finder.find_method(cls, &#20;method, &#20;r))<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;replace-py-method: &#20;method &#20;not &#20;found: &#20;&quot; &#20;+ &#20;cls &#20;+ &#20;&quot;.&quot; &#20;+<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;method &#20;+ &#20;&quot; &#20;in &#20;file: &#20;&quot; &#20;+ &#20;filepath);<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(r.start_line &#20;&lt; &#20;0 &#20;|| &#20;r.end_line &#20;&lt; &#20;r.start_line &#20;||<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;r.end_line &#20;&gt;= &#20;static_cast&lt;int&gt;(lines.size()))<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;replace-py-method: &#20;invalid &#20;region&quot;);<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;auto &#20;begin &#20;= &#20;lines.begin() &#20;+ &#20;r.start_line;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;auto &#20;end &#20;= &#20;lines.begin() &#20;+ &#20;(r.end_line &#20;+ &#20;1);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;lines.erase(begin, &#20;end);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;lines.insert(lines.begin() &#20;+ &#20;r.start_line,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s-&gt;payload.begin(),<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s-&gt;payload.end());<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;continue;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(&quot;apply_symbol_commands: &#20;unknown &#20;command: &#20;&quot; &#20;+<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s-&gt;command);<br>
 &#20; &#20; &#20; &#20;}<br>
}<br>
<br>
static &#20;Section &#20;parse_section(std::istream &#20;&amp;in, &#20;const &#20;std::string &#20;&amp;header)<br>
{<br>
 &#20; &#20; &#20; &#20;Section &#20;s;<br>
<br>
 &#20; &#20; &#20; &#20;auto &#20;pos &#20;= &#20;header.find(':');<br>
 &#20; &#20; &#20; &#20;if &#20;(pos &#20;== &#20;std::string::npos)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(&quot;bad &#20;section &#20;header: &#20;&quot; &#20;+ &#20;header);<br>
<br>
 &#20; &#20; &#20; &#20;auto &#20;pos2 &#20;= &#20;header.find(&quot;===&quot;, &#20;pos);<br>
 &#20; &#20; &#20; &#20;if &#20;(pos2 &#20;== &#20;std::string::npos)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;pos2 &#20;= &#20;header.size();<br>
<br>
 &#20; &#20; &#20; &#20;auto &#20;raw &#20;= &#20;header.substr(pos &#20;+ &#20;1, &#20;pos2 &#20;- &#20;pos &#20;- &#20;1);<br>
 &#20; &#20; &#20; &#20;s.filepath &#20;= &#20;trim(raw);<br>
 &#20; &#20; &#20; &#20;if &#20;(s.filepath.empty())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(&quot;empty &#20;filepath &#20;in &#20;header: &#20;&quot; &#20;+ &#20;header);<br>
<br>
 &#20; &#20; &#20; &#20;std::string &#20;line;<br>
 &#20; &#20; &#20; &#20;if &#20;(!std::getline(in, &#20;line))<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(&quot;unexpected &#20;end &#20;after &#20;header&quot;);<br>
<br>
 &#20; &#20; &#20; &#20;if &#20;(line.rfind(&quot;--- &#20;&quot;, &#20;0) &#20;!= &#20;0)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(&quot;expected &#20;command &#20;after &#20;header&quot;);<br>
<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::istringstream &#20;ss(line.substr(4));<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;ss &#20;&gt;&gt; &#20;s.command;<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;читаем &#20;остаток &#20;строки &#20;как &#20;аргументы &#20;команды<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::string &#20;rest;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::getline(ss, &#20;rest);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(!rest.empty())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::istringstream &#20;as(rest);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;as &#20;&gt;&gt; &#20;s.arg1;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;as &#20;&gt;&gt; &#20;s.arg2;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(is_text_command(s.command))<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;else &#20;if &#20;(s.command &#20;== &#20;&quot;create-file&quot; &#20;|| &#20;s.command &#20;== &#20;&quot;delete-file&quot;)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;else &#20;if &#20;(is_symbol_command(s.command))<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;else<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(&quot;index-based &#20;commands &#20;removed: &#20;&quot; &#20;+<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s.command);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;bool &#20;found_end &#20;= &#20;false;<br>
 &#20; &#20; &#20; &#20;while &#20;(std::getline(in, &#20;line))<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(line &#20;== &#20;&quot;=END=&quot;)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;found_end &#20;= &#20;true;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;break;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s.payload.push_back(line);<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;if &#20;(!found_end)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(&quot;missing &#20;=END=&quot;);<br>
<br>
 &#20; &#20; &#20; &#20;if &#20;(is_text_command(s.command))<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;Определяем, &#20;в &#20;YAML-режиме &#20;мы &#20;или &#20;в &#20;старом &#20;формате.<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;Если &#20;сразу &#20;после &#20;команды &#20;нет &#20;BEFORE:/MARKER:/AFTER:, &#20;используется<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;старая &#20;логика.<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;bool &#20;yaml_mode &#20;= &#20;false;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::size_t &#20;first_non_empty &#20;= &#20;0;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;while &#20;(first_non_empty &#20;&lt; &#20;s.payload.size() &#20;&amp;&amp;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;trim(s.payload[first_non_empty]).empty())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;++first_non_empty;<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(first_non_empty &#20;&lt; &#20;s.payload.size())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;const &#20;std::string &#20;t &#20;= &#20;trim(s.payload[first_non_empty]);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(t &#20;== &#20;&quot;BEFORE:&quot; &#20;|| &#20;t &#20;== &#20;&quot;MARKER:&quot; &#20;|| &#20;t &#20;== &#20;&quot;AFTER:&quot;)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;yaml_mode &#20;= &#20;true;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(!yaml_mode)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;Старый &#20;режим: &#20;всё &#20;до &#20;'---' &#20;— &#20;marker, &#20;после &#20;— &#20;payload<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;auto &#20;it &#20;= &#20;std::find(<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s.payload.begin(), &#20;s.payload.end(), &#20;std::string(&quot;---&quot;));<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(it &#20;== &#20;s.payload.end())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;text &#20;command &#20;requires &#20;'---' &#20;separator&quot;);<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s.marker.assign(s.payload.begin(), &#20;it);<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::vector&lt;std::string&gt; &#20;tail;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(std::next(it) &#20;!= &#20;s.payload.end())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;tail.assign(std::next(it), &#20;s.payload.end());<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s.payload.swap(tail);<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(s.marker.empty())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(&quot;empty &#20;text &#20;marker&quot;);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;else<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;YAML-подобный &#20;режим:<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;BEFORE:<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20; &#20; &#20;...<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;MARKER:<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20; &#20; &#20;...<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;AFTER:<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20; &#20; &#20;...<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;---<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;&lt;payload&gt;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s.before.clear();<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s.marker.clear();<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s.after.clear();<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;enum &#20;class &#20;Block<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;NONE,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;BEFORE,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;MARKER,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;AFTER<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;};<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;Block &#20;blk &#20;= &#20;Block::NONE;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::vector&lt;std::string&gt; &#20;new_payload;<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;bool &#20;seen_separator &#20;= &#20;false;<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;for &#20;(std::size_t &#20;i &#20;= &#20;first_non_empty; &#20;i &#20;&lt; &#20;s.payload.size(); &#20;++i)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;const &#20;std::string &#20;&amp;ln &#20;= &#20;s.payload[i];<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(!seen_separator &#20;&amp;&amp; &#20;ln &#20;== &#20;&quot;---&quot;)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;seen_separator &#20;= &#20;true;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;continue;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(!seen_separator)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;const &#20;std::string &#20;t &#20;= &#20;trim(ln);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(t &#20;== &#20;&quot;BEFORE:&quot;)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;blk &#20;= &#20;Block::BEFORE;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;continue;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(t &#20;== &#20;&quot;MARKER:&quot;)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;blk &#20;= &#20;Block::MARKER;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;continue;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(t &#20;== &#20;&quot;AFTER:&quot;)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;blk &#20;= &#20;Block::AFTER;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;continue;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;switch &#20;(blk)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;case &#20;Block::BEFORE:<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s.before.push_back(ln);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;break;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;case &#20;Block::MARKER:<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s.marker.push_back(ln);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;break;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;case &#20;Block::AFTER:<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s.after.push_back(ln);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;break;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;case &#20;Block::NONE:<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;unexpected &#20;content &#20;before &#20;YAML &#20;block &#20;tag&quot;);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;else<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;new_payload.push_back(ln);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s.payload.swap(new_payload);<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(s.marker.empty())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;YAML &#20;text &#20;command &#20;requires &#20;MARKER: &#20;section&quot;);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;return &#20;s;<br>
}<br>
<br>
static &#20;void &#20;apply_for_file(const &#20;std::string &#20;&amp;filepath,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;const &#20;std::vector&lt;const &#20;Section &#20;*&gt; &#20;&amp;sections)<br>
{<br>
 &#20; &#20; &#20; &#20;fs::path &#20;p &#20;= &#20;filepath;<br>
 &#20; &#20; &#20; &#20;std::vector&lt;std::string&gt; &#20;orig;<br>
 &#20; &#20; &#20; &#20;bool &#20;existed &#20;= &#20;true;<br>
<br>
 &#20; &#20; &#20; &#20;try<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;orig &#20;= &#20;read_file_lines(p);<br>
 &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20;catch &#20;(...)<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;existed &#20;= &#20;false;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;orig.clear();<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;for &#20;(const &#20;Section &#20;*s &#20;: &#20;sections)<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(!existed &#20;&amp;&amp; &#20;s-&gt;command &#20;== &#20;&quot;delete-file&quot;)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(&quot;delete-file: &#20;file &#20;does &#20;not &#20;exist&quot;);<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;for &#20;(const &#20;Section &#20;*s &#20;: &#20;sections)<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(s-&gt;command &#20;== &#20;&quot;create-file&quot;)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;write_file_lines(p, &#20;s-&gt;payload);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(s-&gt;command &#20;== &#20;&quot;delete-file&quot;)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::error_code &#20;ec;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;fs::remove(p, &#20;ec);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(ec)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(&quot;delete-file &#20;failed&quot;);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;std::vector&lt;const &#20;Section &#20;*&gt; &#20;text_sections;<br>
 &#20; &#20; &#20; &#20;std::vector&lt;const &#20;Section &#20;*&gt; &#20;symbol_sections;<br>
<br>
 &#20; &#20; &#20; &#20;for &#20;(const &#20;Section &#20;*s &#20;: &#20;sections)<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(is_text_command(s-&gt;command))<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;text_sections.push_back(s);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;else &#20;if &#20;(is_symbol_command(s-&gt;command))<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;symbol_sections.push_back(s);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;else<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(&quot;unexpected &#20;non-text &#20;command: &#20;&quot; &#20;+<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s-&gt;command);<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;if &#20;(!text_sections.empty())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;apply_text_commands(filepath, &#20;orig, &#20;text_sections);<br>
<br>
 &#20; &#20; &#20; &#20;if &#20;(!symbol_sections.empty())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;apply_symbol_commands(filepath, &#20;orig, &#20;symbol_sections);<br>
<br>
 &#20; &#20; &#20; &#20;if &#20;(!text_sections.empty() &#20;|| &#20;!symbol_sections.empty())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;write_file_lines(p, &#20;orig);<br>
}<br>
<br>
static &#20;void &#20;apply_all(const &#20;std::vector&lt;Section&gt; &#20;&amp;sections)<br>
{<br>
 &#20; &#20; &#20; &#20;namespace &#20;fs &#20;= &#20;std::filesystem;<br>
<br>
 &#20; &#20; &#20; &#20;// &#20;1. &#20;Собираем &#20;список &#20;всех &#20;файлов, &#20;которые &#20;будут &#20;затронуты<br>
 &#20; &#20; &#20; &#20;std::vector&lt;std::string&gt; &#20;files;<br>
 &#20; &#20; &#20; &#20;files.reserve(sections.size());<br>
 &#20; &#20; &#20; &#20;for &#20;(auto &#20;&amp;s &#20;: &#20;sections)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;files.push_back(s.filepath);<br>
<br>
 &#20; &#20; &#20; &#20;std::sort(files.begin(), &#20;files.end());<br>
 &#20; &#20; &#20; &#20;files.erase(std::unique(files.begin(), &#20;files.end()), &#20;files.end());<br>
<br>
 &#20; &#20; &#20; &#20;struct &#20;Backup<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;bool &#20;existed &#20;= &#20;false;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::vector&lt;std::string&gt; &#20;lines;<br>
 &#20; &#20; &#20; &#20;};<br>
<br>
 &#20; &#20; &#20; &#20;std::map&lt;std::string, &#20;Backup&gt; &#20;backup;<br>
<br>
 &#20; &#20; &#20; &#20;// &#20;2. &#20;Делаем &#20;резервную &#20;копию &#20;всех &#20;файлов<br>
 &#20; &#20; &#20; &#20;for &#20;(auto &#20;&amp;f &#20;: &#20;files)<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;Backup &#20;b;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;fs::path &#20;p &#20;= &#20;f;<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::error_code &#20;ec;<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(fs::exists(p, &#20;ec))<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;b.existed &#20;= &#20;true;<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;try<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;b.lines &#20;= &#20;read_file_lines(p);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;catch &#20;(...)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(&quot;cannot &#20;read &#20;original &#20;file: &#20;&quot; &#20;+ &#20;f);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;else<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;b.existed &#20;= &#20;false;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;backup[f] &#20;= &#20;std::move(b);<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;// &#20;3. &#20;Применяем &#20;секции &#20;с &#20;защитой &#20;(try/catch)<br>
 &#20; &#20; &#20; &#20;try<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;for &#20;(auto &#20;&amp;s &#20;: &#20;sections)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::vector&lt;const &#20;Section &#20;*&gt; &#20;single{&amp;s};<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;apply_for_file(s.filepath, &#20;single);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20;catch &#20;(...)<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;4. &#20;Откат &#20;(rollback)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;for &#20;(auto &#20;&amp;[path, &#20;b] &#20;: &#20;backup)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;fs::path &#20;p &#20;= &#20;path;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::error_code &#20;ec;<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(b.existed)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;try<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;write_file_lines(p, &#20;b.lines);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;catch &#20;(...)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;если &#20;даже &#20;откат &#20;не &#20;удался &#20;— &#20;сдаёмся<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;else<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;fs::remove(p, &#20;ec);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw;<br>
 &#20; &#20; &#20; &#20;}<br>
}<br>
<br>
int &#20;apply_chunk_main(int &#20;argc, &#20;char &#20;**argv)<br>
{<br>
 &#20; &#20; &#20; &#20;if &#20;(argc &#20;&lt; &#20;2)<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::cerr &#20;&lt;&lt; &#20;&quot;usage: &#20;apply_patch &#20;&lt;patchfile&gt;\n&quot;;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return &#20;1;<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;std::ifstream &#20;in(argv[1]);<br>
 &#20; &#20; &#20; &#20;if &#20;(!in)<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::cerr &#20;&lt;&lt; &#20;&quot;cannot &#20;open &#20;patch &#20;file: &#20;&quot; &#20;&lt;&lt; &#20;argv[1] &#20;&lt;&lt; &#20;&quot;\n&quot;;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return &#20;1;<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;std::string &#20;line;<br>
 &#20; &#20; &#20; &#20;std::vector&lt;Section&gt; &#20;sections;<br>
 &#20; &#20; &#20; &#20;int &#20;seq &#20;= &#20;0;<br>
<br>
 &#20; &#20; &#20; &#20;try<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;while &#20;(std::getline(in, &#20;line))<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(line.rfind(&quot;=== &#20;file:&quot;, &#20;0) &#20;== &#20;0)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;Section &#20;s &#20;= &#20;parse_section(in, &#20;line);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s.seq &#20;= &#20;seq++;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;sections.push_back(std::move(s));<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;apply_all(sections);<br>
 &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20;catch &#20;(const &#20;std::exception &#20;&amp;e)<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::cerr &#20;&lt;&lt; &#20;&quot;error &#20;while &#20;applying &#20;patch: &#20;&quot; &#20;&lt;&lt; &#20;e.what() &#20;&lt;&lt; &#20;&quot;\n&quot;;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return &#20;1;<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;return &#20;0;<br>
}<br>
<!-- END SCAT CODE -->
</body>
</html>
