<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>src/apply_chunk_v2.cpp</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
#include&#32;&quot;symbols.h&quot;<br>
#include&#32;&lt;algorithm&gt;<br>
#include&#32;&lt;cctype&gt;<br>
#include&#32;&lt;filesystem&gt;<br>
#include&#32;&lt;fstream&gt;<br>
#include&#32;&lt;iostream&gt;<br>
#include&#32;&lt;map&gt;<br>
#include&#32;&lt;sstream&gt;<br>
#include&#32;&lt;stdexcept&gt;<br>
#include&#32;&lt;string&gt;<br>
#include&#32;&lt;string_view&gt;<br>
#include&#32;&lt;vector&gt;<br>
<br>
namespace&#32;fs&#32;=&#32;std::filesystem;<br>
<br>
struct&#32;Section<br>
{<br>
&#32;&#32;&#32;&#32;std::string&#32;filepath;<br>
&#32;&#32;&#32;&#32;std::string&#32;command;<br>
&#32;&#32;&#32;&#32;int&#32;a&#32;=&#32;-1;<br>
&#32;&#32;&#32;&#32;int&#32;b&#32;=&#32;-1;<br>
&#32;&#32;&#32;&#32;std::vector&lt;std::string&gt;&#32;payload;<br>
&#32;&#32;&#32;&#32;std::vector&lt;std::string&gt;&#32;marker;<br>
&#32;&#32;&#32;&#32;std::vector&lt;std::string&gt;&#32;before;&#32;//&#32;контекст&#32;до&#32;маркера&#32;(BEFORE:)<br>
&#32;&#32;&#32;&#32;std::vector&lt;std::string&gt;&#32;after;&#32;//&#32;контекст&#32;после&#32;маркера&#32;(AFTER:)<br>
&#32;&#32;&#32;&#32;int&#32;seq&#32;=&#32;0;<br>
&#32;&#32;&#32;&#32;std::string&#32;arg1;&#32;//&#32;доп.&#32;аргументы&#32;команды&#32;(например,&#32;имя&#32;класса)<br>
&#32;&#32;&#32;&#32;std::string&#32;arg2;&#32;//&#32;второй&#32;аргумент&#32;(например,&#32;имя&#32;метода)<br>
};<br>
<br>
static&#32;std::vector&lt;std::string&gt;&#32;read_file_lines(const&#32;fs::path&#32;&amp;p)<br>
{<br>
&#32;&#32;&#32;&#32;std::ifstream&#32;in(p);<br>
&#32;&#32;&#32;&#32;if&#32;(!in)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(&quot;cannot&#32;open&#32;file:&#32;&quot;&#32;+&#32;p.string());<br>
<br>
&#32;&#32;&#32;&#32;std::vector&lt;std::string&gt;&#32;out;<br>
&#32;&#32;&#32;&#32;std::string&#32;line;<br>
&#32;&#32;&#32;&#32;while&#32;(std::getline(in,&#32;line))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out.push_back(line);<br>
<br>
&#32;&#32;&#32;&#32;return&#32;out;<br>
}<br>
<br>
static&#32;void&#32;write_file_lines(const&#32;fs::path&#32;&amp;p,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;const&#32;std::vector&lt;std::string&gt;&#32;&amp;lines)<br>
{<br>
&#32;&#32;&#32;&#32;std::ofstream&#32;out(p,&#32;std::ios::trunc);<br>
&#32;&#32;&#32;&#32;if&#32;(!out)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(&quot;cannot&#32;write&#32;file:&#32;&quot;&#32;+&#32;p.string());<br>
<br>
&#32;&#32;&#32;&#32;for&#32;(const&#32;auto&#32;&amp;s&#32;:&#32;lines)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out&#32;&lt;&lt;&#32;s&#32;&lt;&lt;&#32;&quot;\n&quot;;<br>
}<br>
<br>
std::string&#32;trim(const&#32;std::string_view&#32;&amp;view)<br>
{<br>
&#32;&#32;&#32;&#32;if&#32;(view.size()&#32;==&#32;0)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return&#32;&quot;&quot;;<br>
<br>
&#32;&#32;&#32;&#32;const&#32;char&#32;*left&#32;=&#32;view.data();<br>
&#32;&#32;&#32;&#32;const&#32;char&#32;*right&#32;=&#32;view.data()&#32;+&#32;view.size()&#32;-&#32;1;<br>
&#32;&#32;&#32;&#32;const&#32;char&#32;*end&#32;=&#32;view.data()&#32;+&#32;view.size();<br>
<br>
&#32;&#32;&#32;&#32;while&#32;(left&#32;!=&#32;end&#32;&amp;&amp;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;(*left&#32;==&#32;'&#32;'&#32;||&#32;*left&#32;==&#32;'\n'&#32;||&#32;*left&#32;==&#32;'\r'&#32;||&#32;*left&#32;==&#32;'\t'))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;++left;<br>
<br>
&#32;&#32;&#32;&#32;if&#32;(left&#32;==&#32;end)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return&#32;&quot;&quot;;<br>
<br>
&#32;&#32;&#32;&#32;while&#32;(left&#32;!=&#32;right&#32;&amp;&amp;&#32;(*right&#32;==&#32;'&#32;'&#32;||&#32;*right&#32;==&#32;'\n'&#32;||<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;*right&#32;==&#32;'\r'&#32;||&#32;*right&#32;==&#32;'\t'))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;--right;<br>
<br>
&#32;&#32;&#32;&#32;return&#32;std::string(left,&#32;(right&#32;-&#32;left)&#32;+&#32;1);<br>
}<br>
<br>
static&#32;bool&#32;is_text_command(const&#32;std::string&#32;&amp;cmd)<br>
{<br>
&#32;&#32;&#32;&#32;return&#32;cmd&#32;==&#32;&quot;insert-after-text&quot;&#32;||&#32;cmd&#32;==&#32;&quot;insert-before-text&quot;&#32;||<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;cmd&#32;==&#32;&quot;replace-text&quot;&#32;||&#32;cmd&#32;==&#32;&quot;delete-text&quot;;<br>
}<br>
<br>
static&#32;bool&#32;is_symbol_command(const&#32;std::string&#32;&amp;cmd)<br>
{<br>
&#32;&#32;&#32;&#32;return&#32;cmd&#32;==&#32;&quot;replace-cpp-method&quot;&#32;||&#32;cmd&#32;==&#32;&quot;replace-cpp-class&quot;&#32;||<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;cmd&#32;==&#32;&quot;replace-py-method&quot;&#32;||&#32;cmd&#32;==&#32;&quot;replace-py-class&quot;;<br>
}<br>
<br>
static&#32;int&#32;find_subsequence(const&#32;std::vector&lt;std::string&gt;&#32;&amp;haystack,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;const&#32;std::vector&lt;std::string&gt;&#32;&amp;needle)<br>
{<br>
&#32;&#32;&#32;&#32;if&#32;(needle.empty()&#32;||&#32;needle.size()&#32;&gt;&#32;haystack.size())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return&#32;-1;<br>
<br>
&#32;&#32;&#32;&#32;const&#32;std::size_t&#32;n&#32;=&#32;haystack.size();<br>
&#32;&#32;&#32;&#32;const&#32;std::size_t&#32;m&#32;=&#32;needle.size();<br>
<br>
&#32;&#32;&#32;&#32;for&#32;(std::size_t&#32;i&#32;=&#32;0;&#32;i&#32;+&#32;m&#32;&lt;=&#32;n;&#32;++i)<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;bool&#32;ok&#32;=&#32;true;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;for&#32;(std::size_t&#32;j&#32;=&#32;0;&#32;j&#32;&lt;&#32;m;&#32;++j)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::string&#32;h&#32;=&#32;trim(haystack[i&#32;+&#32;j]);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::string&#32;nn&#32;=&#32;trim(needle[j]);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(h&#32;!=&#32;nn)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;ok&#32;=&#32;false;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;break;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(ok)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return&#32;static_cast&lt;int&gt;(i);<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;return&#32;-1;<br>
}<br>
<br>
//&#32;Строгий&#32;выбор&#32;позиции&#32;маркера&#32;с&#32;учётом&#32;BEFORE/AFTER.<br>
//&#32;Никакого&#32;fuzzy,&#32;только&#32;точное&#32;позиционное&#32;совпадение.<br>
static&#32;int&#32;find_best_marker_match(const&#32;std::vector&lt;std::string&gt;&#32;&amp;lines,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;const&#32;Section&#32;*s,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;const&#32;std::vector&lt;int&gt;&#32;&amp;candidates)<br>
{<br>
&#32;&#32;&#32;&#32;if&#32;(candidates.empty())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return&#32;-1;<br>
<br>
&#32;&#32;&#32;&#32;//&#32;Нет&#32;дополнительного&#32;контекста&#32;—&#32;ведём&#32;себя&#32;как&#32;раньше.<br>
&#32;&#32;&#32;&#32;if&#32;(s-&gt;before.empty()&#32;&amp;&amp;&#32;s-&gt;after.empty())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return&#32;candidates.front();<br>
<br>
&#32;&#32;&#32;&#32;auto&#32;trim_eq&#32;=&#32;[&amp;](const&#32;std::string&#32;&amp;a,&#32;const&#32;std::string&#32;&amp;b)<br>
&#32;&#32;&#32;&#32;{&#32;return&#32;trim(a)&#32;==&#32;trim(b);&#32;};<br>
<br>
&#32;&#32;&#32;&#32;std::vector&lt;int&gt;&#32;strict;<br>
<br>
&#32;&#32;&#32;&#32;for&#32;(int&#32;pos&#32;:&#32;candidates)<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;bool&#32;ok&#32;=&#32;true;<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;BEFORE:&#32;строки&#32;сразу&#32;над&#32;маркером<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(!s-&gt;before.empty())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;int&#32;need&#32;=&#32;static_cast&lt;int&gt;(s-&gt;before.size());<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(pos&#32;&lt;&#32;need)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;ok&#32;=&#32;false;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;else<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;Последняя&#32;строка&#32;BEFORE&#32;должна&#32;быть&#32;непосредственно&#32;над<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;первой&#32;строкой&#32;маркера.<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;for&#32;(int&#32;i&#32;=&#32;0;&#32;i&#32;&lt;&#32;need;&#32;++i)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;const&#32;std::string&#32;&amp;want&#32;=<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;s-&gt;before[static_cast&lt;std::size_t&gt;(need&#32;-&#32;1&#32;-&#32;i)];<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;const&#32;std::string&#32;&amp;got&#32;=<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;lines[static_cast&lt;std::size_t&gt;(pos&#32;-&#32;1&#32;-&#32;i)];<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(!trim_eq(got,&#32;want))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;ok&#32;=&#32;false;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;break;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;AFTER:&#32;строки&#32;сразу&#32;под&#32;маркером<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(ok&#32;&amp;&amp;&#32;!s-&gt;after.empty())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;int&#32;start&#32;=&#32;pos&#32;+&#32;static_cast&lt;int&gt;(s-&gt;marker.size());<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;int&#32;need&#32;=&#32;static_cast&lt;int&gt;(s-&gt;after.size());<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(start&#32;&lt;&#32;0&#32;||&#32;start&#32;+&#32;need&#32;&gt;&#32;static_cast&lt;int&gt;(lines.size()))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;ok&#32;=&#32;false;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;else<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;for&#32;(int&#32;i&#32;=&#32;0;&#32;i&#32;&lt;&#32;need;&#32;++i)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;const&#32;std::string&#32;&amp;want&#32;=<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;s-&gt;after[static_cast&lt;std::size_t&gt;(i)];<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;const&#32;std::string&#32;&amp;got&#32;=<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;lines[static_cast&lt;std::size_t&gt;(start&#32;+&#32;i)];<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(!trim_eq(got,&#32;want))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;ok&#32;=&#32;false;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;break;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(ok)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;strict.push_back(pos);<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;if&#32;(strict.empty())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(&quot;strict&#32;marker&#32;context&#32;not&#32;found&quot;);<br>
<br>
&#32;&#32;&#32;&#32;if&#32;(strict.size()&#32;&gt;&#32;1)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(&quot;strict&#32;marker&#32;match&#32;is&#32;ambiguous&quot;);<br>
<br>
&#32;&#32;&#32;&#32;return&#32;strict.front();<br>
}<br>
<br>
static&#32;void&#32;apply_text_commands(const&#32;std::string&#32;&amp;filepath,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::vector&lt;std::string&gt;&#32;&amp;lines,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;const&#32;std::vector&lt;const&#32;Section&#32;*&gt;&#32;&amp;sections)<br>
{<br>
&#32;&#32;&#32;&#32;for&#32;(const&#32;Section&#32;*s&#32;:&#32;sections)<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(s-&gt;marker.empty())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(&quot;empty&#32;marker&#32;in&#32;text&#32;command&#32;for&#32;file:&#32;&quot;&#32;+<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;filepath);<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;Собираем&#32;все&#32;вхождения&#32;маркера<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::vector&lt;int&gt;&#32;candidates;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;int&#32;base&#32;=&#32;0;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;while&#32;(base&#32;&lt;&#32;static_cast&lt;int&gt;(lines.size()))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::vector&lt;std::string&gt;&#32;sub(lines.begin()&#32;+&#32;base,&#32;lines.end());<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;int&#32;idx&#32;=&#32;find_subsequence(sub,&#32;s-&gt;marker);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(idx&#32;&lt;&#32;0)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;break;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;candidates.push_back(base&#32;+&#32;idx);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;base&#32;+=&#32;idx&#32;+&#32;1;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(candidates.empty())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;text&#32;marker&#32;not&#32;found&#32;for&#32;file:&#32;&quot;&#32;+&#32;filepath&#32;+<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;\ncommand:&#32;&quot;&#32;+&#32;s-&gt;command&#32;+&#32;&quot;\n&quot;);<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;int&#32;idx&#32;=&#32;find_best_marker_match(lines,&#32;s,&#32;candidates);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(idx&#32;&lt;&#32;0)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(&quot;cannot&#32;locate&#32;marker&#32;uniquely&quot;);<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::size_t&#32;pos&#32;=&#32;static_cast&lt;std::size_t&gt;(idx);<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(s-&gt;command&#32;==&#32;&quot;insert-after-text&quot;)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;pos&#32;+=&#32;s-&gt;marker.size();<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;lines.insert(lines.begin()&#32;+&#32;static_cast&lt;std::ptrdiff_t&gt;(pos),<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;s-&gt;payload.begin(),<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;s-&gt;payload.end());<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;else&#32;if&#32;(s-&gt;command&#32;==&#32;&quot;insert-before-text&quot;)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;lines.insert(lines.begin()&#32;+&#32;static_cast&lt;std::ptrdiff_t&gt;(pos),<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;s-&gt;payload.begin(),<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;s-&gt;payload.end());<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;else&#32;if&#32;(s-&gt;command&#32;==&#32;&quot;replace-text&quot;)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;auto&#32;begin&#32;=&#32;lines.begin()&#32;+&#32;static_cast&lt;std::ptrdiff_t&gt;(pos);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;auto&#32;end&#32;=&#32;begin&#32;+&#32;static_cast&lt;std::ptrdiff_t&gt;(s-&gt;marker.size());<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;lines.erase(begin,&#32;end);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;lines.insert(lines.begin()&#32;+&#32;static_cast&lt;std::ptrdiff_t&gt;(pos),<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;s-&gt;payload.begin(),<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;s-&gt;payload.end());<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;else&#32;if&#32;(s-&gt;command&#32;==&#32;&quot;delete-text&quot;)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;auto&#32;begin&#32;=&#32;lines.begin()&#32;+&#32;static_cast&lt;std::ptrdiff_t&gt;(pos);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;auto&#32;end&#32;=&#32;begin&#32;+&#32;static_cast&lt;std::ptrdiff_t&gt;(s-&gt;marker.size());<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;lines.erase(begin,&#32;end);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;else<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(&quot;unknown&#32;text&#32;command:&#32;&quot;&#32;+&#32;s-&gt;command);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;}<br>
}<br>
<br>
static&#32;std::string&#32;join_lines(const&#32;std::vector&lt;std::string&gt;&#32;&amp;lines)<br>
{<br>
&#32;&#32;&#32;&#32;if&#32;(lines.empty())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return&#32;std::string();<br>
<br>
&#32;&#32;&#32;&#32;std::string&#32;text;<br>
&#32;&#32;&#32;&#32;std::size_t&#32;total&#32;=&#32;0;<br>
&#32;&#32;&#32;&#32;for&#32;(const&#32;auto&#32;&amp;s&#32;:&#32;lines)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;total&#32;+=&#32;s.size()&#32;+&#32;1;<br>
&#32;&#32;&#32;&#32;text.reserve(total);<br>
<br>
&#32;&#32;&#32;&#32;for&#32;(std::size_t&#32;i&#32;=&#32;0;&#32;i&#32;&lt;&#32;lines.size();&#32;++i)<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;text&#32;+=&#32;lines[i];<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(i&#32;+&#32;1&#32;&lt;&#32;lines.size())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;text&#32;+=&#32;'\n';<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;return&#32;text;<br>
}<br>
<br>
static&#32;void&#32;apply_symbol_commands(const&#32;std::string&#32;&amp;filepath,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::vector&lt;std::string&gt;&#32;&amp;lines,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;const&#32;std::vector&lt;const&#32;Section&#32;*&gt;&#32;&amp;sections)<br>
{<br>
&#32;&#32;&#32;&#32;for&#32;(const&#32;Section&#32;*s&#32;:&#32;sections)<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;Всегда&#32;работаем&#32;с&#32;текущей&#32;версией&#32;файла<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::string&#32;text&#32;=&#32;join_lines(lines);<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(s-&gt;command&#32;==&#32;&quot;replace-cpp-class&quot;&#32;||<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;s-&gt;command&#32;==&#32;&quot;replace-cpp-method&quot;)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;CppSymbolFinder&#32;finder(text);<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(s-&gt;command&#32;==&#32;&quot;replace-cpp-class&quot;)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(s-&gt;arg1.empty())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;replace-cpp-class:&#32;missing&#32;class&#32;name&#32;for&#32;file:&#32;&quot;&#32;+<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;filepath);<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;Region&#32;r;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(!finder.find_class(s-&gt;arg1,&#32;r))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;replace-cpp-class:&#32;class&#32;not&#32;found:&#32;&quot;&#32;+&#32;s-&gt;arg1&#32;+<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;&#32;in&#32;file:&#32;&quot;&#32;+&#32;filepath);<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(r.start_line&#32;&lt;&#32;0&#32;||&#32;r.end_line&#32;&lt;&#32;r.start_line&#32;||<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;r.end_line&#32;&gt;=&#32;static_cast&lt;int&gt;(lines.size()))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;replace-cpp-class:&#32;invalid&#32;region&quot;);<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;auto&#32;begin&#32;=&#32;lines.begin()&#32;+&#32;r.start_line;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;auto&#32;end&#32;=&#32;lines.begin()&#32;+&#32;(r.end_line&#32;+&#32;1);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;lines.erase(begin,&#32;end);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;lines.insert(lines.begin()&#32;+&#32;r.start_line,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;s-&gt;payload.begin(),<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;s-&gt;payload.end());<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;else&#32;//&#32;replace-cpp-method<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::string&#32;cls;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::string&#32;method;<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(!s-&gt;arg2.empty())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;cls&#32;=&#32;s-&gt;arg1;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;method&#32;=&#32;s-&gt;arg2;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;else<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;auto&#32;pos&#32;=&#32;s-&gt;arg1.find(&quot;::&quot;);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(pos&#32;==&#32;std::string::npos)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;replace-cpp-method:&#32;expected&#32;'Class::method'&#32;or&#32;&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;'Class&#32;method'&quot;);<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;cls&#32;=&#32;s-&gt;arg1.substr(0,&#32;pos);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;method&#32;=&#32;s-&gt;arg1.substr(pos&#32;+&#32;2);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(cls.empty()&#32;||&#32;method.empty())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;replace-cpp-method:&#32;empty&#32;class&#32;or&#32;method&#32;name&quot;);<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;Region&#32;r;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(!finder.find_method(cls,&#32;method,&#32;r))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;replace-cpp-method:&#32;method&#32;not&#32;found:&#32;&quot;&#32;+&#32;cls&#32;+<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;::&quot;&#32;+&#32;method&#32;+&#32;&quot;&#32;in&#32;file:&#32;&quot;&#32;+&#32;filepath);<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(r.start_line&#32;&lt;&#32;0&#32;||&#32;r.end_line&#32;&lt;&#32;r.start_line&#32;||<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;r.end_line&#32;&gt;=&#32;static_cast&lt;int&gt;(lines.size()))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;replace-cpp-method:&#32;invalid&#32;region&quot;);<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;auto&#32;begin&#32;=&#32;lines.begin()&#32;+&#32;r.start_line;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;auto&#32;end&#32;=&#32;lines.begin()&#32;+&#32;(r.end_line&#32;+&#32;1);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;lines.erase(begin,&#32;end);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;lines.insert(lines.begin()&#32;+&#32;r.start_line,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;s-&gt;payload.begin(),<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;s-&gt;payload.end());<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;continue;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(s-&gt;command&#32;==&#32;&quot;replace-py-class&quot;&#32;||<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;s-&gt;command&#32;==&#32;&quot;replace-py-method&quot;)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;PythonSymbolFinder&#32;finder(text);<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(s-&gt;command&#32;==&#32;&quot;replace-py-class&quot;)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(s-&gt;arg1.empty())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;replace-py-class:&#32;missing&#32;class&#32;name&#32;for&#32;file:&#32;&quot;&#32;+<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;filepath);<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;Region&#32;r;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(!finder.find_class(s-&gt;arg1,&#32;r))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;replace-py-class:&#32;class&#32;not&#32;found:&#32;&quot;&#32;+&#32;s-&gt;arg1&#32;+<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;&#32;in&#32;file:&#32;&quot;&#32;+&#32;filepath);<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(r.start_line&#32;&lt;&#32;0&#32;||&#32;r.end_line&#32;&lt;&#32;r.start_line&#32;||<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;r.end_line&#32;&gt;=&#32;static_cast&lt;int&gt;(lines.size()))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;replace-py-class:&#32;invalid&#32;region&quot;);<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;auto&#32;begin&#32;=&#32;lines.begin()&#32;+&#32;r.start_line;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;auto&#32;end&#32;=&#32;lines.begin()&#32;+&#32;(r.end_line&#32;+&#32;1);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;lines.erase(begin,&#32;end);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;lines.insert(lines.begin()&#32;+&#32;r.start_line,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;s-&gt;payload.begin(),<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;s-&gt;payload.end());<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;else&#32;//&#32;replace-py-method<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::string&#32;cls;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::string&#32;method;<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(!s-&gt;arg2.empty())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;cls&#32;=&#32;s-&gt;arg1;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;method&#32;=&#32;s-&gt;arg2;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;else<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;auto&#32;pos&#32;=&#32;s-&gt;arg1.find('.');<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(pos&#32;==&#32;std::string::npos)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;replace-py-method:&#32;expected&#32;'Class.method'&#32;or&#32;&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;'Class&#32;method'&quot;);<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;cls&#32;=&#32;s-&gt;arg1.substr(0,&#32;pos);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;method&#32;=&#32;s-&gt;arg1.substr(pos&#32;+&#32;1);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(cls.empty()&#32;||&#32;method.empty())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;replace-py-method:&#32;empty&#32;class&#32;or&#32;method&#32;name&quot;);<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;Region&#32;r;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(!finder.find_method(cls,&#32;method,&#32;r))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;replace-py-method:&#32;method&#32;not&#32;found:&#32;&quot;&#32;+&#32;cls&#32;+&#32;&quot;.&quot;&#32;+<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;method&#32;+&#32;&quot;&#32;in&#32;file:&#32;&quot;&#32;+&#32;filepath);<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(r.start_line&#32;&lt;&#32;0&#32;||&#32;r.end_line&#32;&lt;&#32;r.start_line&#32;||<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;r.end_line&#32;&gt;=&#32;static_cast&lt;int&gt;(lines.size()))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;replace-py-method:&#32;invalid&#32;region&quot;);<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;auto&#32;begin&#32;=&#32;lines.begin()&#32;+&#32;r.start_line;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;auto&#32;end&#32;=&#32;lines.begin()&#32;+&#32;(r.end_line&#32;+&#32;1);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;lines.erase(begin,&#32;end);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;lines.insert(lines.begin()&#32;+&#32;r.start_line,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;s-&gt;payload.begin(),<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;s-&gt;payload.end());<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;continue;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(&quot;apply_symbol_commands:&#32;unknown&#32;command:&#32;&quot;&#32;+<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;s-&gt;command);<br>
&#32;&#32;&#32;&#32;}<br>
}<br>
<br>
static&#32;Section&#32;parse_section(std::istream&#32;&amp;in,&#32;const&#32;std::string&#32;&amp;header)<br>
{<br>
&#32;&#32;&#32;&#32;Section&#32;s;<br>
<br>
&#32;&#32;&#32;&#32;auto&#32;pos&#32;=&#32;header.find(':');<br>
&#32;&#32;&#32;&#32;if&#32;(pos&#32;==&#32;std::string::npos)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(&quot;bad&#32;section&#32;header:&#32;&quot;&#32;+&#32;header);<br>
<br>
&#32;&#32;&#32;&#32;auto&#32;pos2&#32;=&#32;header.find(&quot;===&quot;,&#32;pos);<br>
&#32;&#32;&#32;&#32;if&#32;(pos2&#32;==&#32;std::string::npos)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;pos2&#32;=&#32;header.size();<br>
<br>
&#32;&#32;&#32;&#32;auto&#32;raw&#32;=&#32;header.substr(pos&#32;+&#32;1,&#32;pos2&#32;-&#32;pos&#32;-&#32;1);<br>
&#32;&#32;&#32;&#32;s.filepath&#32;=&#32;trim(raw);<br>
&#32;&#32;&#32;&#32;if&#32;(s.filepath.empty())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(&quot;empty&#32;filepath&#32;in&#32;header:&#32;&quot;&#32;+&#32;header);<br>
<br>
&#32;&#32;&#32;&#32;std::string&#32;line;<br>
&#32;&#32;&#32;&#32;if&#32;(!std::getline(in,&#32;line))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(&quot;unexpected&#32;end&#32;after&#32;header&quot;);<br>
<br>
&#32;&#32;&#32;&#32;if&#32;(line.rfind(&quot;---&#32;&quot;,&#32;0)&#32;!=&#32;0)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(&quot;expected&#32;command&#32;after&#32;header&quot;);<br>
<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::istringstream&#32;ss(line.substr(4));<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;ss&#32;&gt;&gt;&#32;s.command;<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;читаем&#32;остаток&#32;строки&#32;как&#32;аргументы&#32;команды<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::string&#32;rest;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::getline(ss,&#32;rest);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(!rest.empty())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::istringstream&#32;as(rest);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;as&#32;&gt;&gt;&#32;s.arg1;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;as&#32;&gt;&gt;&#32;s.arg2;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(is_text_command(s.command))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;else&#32;if&#32;(s.command&#32;==&#32;&quot;create-file&quot;&#32;||&#32;s.command&#32;==&#32;&quot;delete-file&quot;)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;else&#32;if&#32;(is_symbol_command(s.command))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;else<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(&quot;index-based&#32;commands&#32;removed:&#32;&quot;&#32;+<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;s.command);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;bool&#32;found_end&#32;=&#32;false;<br>
&#32;&#32;&#32;&#32;while&#32;(std::getline(in,&#32;line))<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(line&#32;==&#32;&quot;=END=&quot;)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;found_end&#32;=&#32;true;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;break;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;s.payload.push_back(line);<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;if&#32;(!found_end)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(&quot;missing&#32;=END=&quot;);<br>
<br>
&#32;&#32;&#32;&#32;if&#32;(is_text_command(s.command))<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;Определяем,&#32;в&#32;YAML-режиме&#32;мы&#32;или&#32;в&#32;старом&#32;формате.<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;Если&#32;сразу&#32;после&#32;команды&#32;нет&#32;BEFORE:/MARKER:/AFTER:,&#32;используется<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;старая&#32;логика.<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;bool&#32;yaml_mode&#32;=&#32;false;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::size_t&#32;first_non_empty&#32;=&#32;0;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;while&#32;(first_non_empty&#32;&lt;&#32;s.payload.size()&#32;&amp;&amp;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;trim(s.payload[first_non_empty]).empty())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;++first_non_empty;<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(first_non_empty&#32;&lt;&#32;s.payload.size())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;const&#32;std::string&#32;t&#32;=&#32;trim(s.payload[first_non_empty]);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(t&#32;==&#32;&quot;BEFORE:&quot;&#32;||&#32;t&#32;==&#32;&quot;MARKER:&quot;&#32;||&#32;t&#32;==&#32;&quot;AFTER:&quot;)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;yaml_mode&#32;=&#32;true;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(!yaml_mode)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;Старый&#32;режим:&#32;всё&#32;до&#32;'---'&#32;—&#32;marker,&#32;после&#32;—&#32;payload<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;auto&#32;it&#32;=&#32;std::find(<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;s.payload.begin(),&#32;s.payload.end(),&#32;std::string(&quot;---&quot;));<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(it&#32;==&#32;s.payload.end())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;text&#32;command&#32;requires&#32;'---'&#32;separator&quot;);<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;s.marker.assign(s.payload.begin(),&#32;it);<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::vector&lt;std::string&gt;&#32;tail;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(std::next(it)&#32;!=&#32;s.payload.end())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;tail.assign(std::next(it),&#32;s.payload.end());<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;s.payload.swap(tail);<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(s.marker.empty())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(&quot;empty&#32;text&#32;marker&quot;);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;else<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;YAML-подобный&#32;режим:<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;BEFORE:<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;&#32;&#32;...<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;MARKER:<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;&#32;&#32;...<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;AFTER:<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;&#32;&#32;...<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;---<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;&lt;payload&gt;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;s.before.clear();<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;s.marker.clear();<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;s.after.clear();<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;enum&#32;class&#32;Block<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;NONE,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;BEFORE,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;MARKER,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;AFTER<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;};<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;Block&#32;blk&#32;=&#32;Block::NONE;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::vector&lt;std::string&gt;&#32;new_payload;<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;bool&#32;seen_separator&#32;=&#32;false;<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;for&#32;(std::size_t&#32;i&#32;=&#32;first_non_empty;&#32;i&#32;&lt;&#32;s.payload.size();&#32;++i)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;const&#32;std::string&#32;&amp;ln&#32;=&#32;s.payload[i];<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(!seen_separator&#32;&amp;&amp;&#32;ln&#32;==&#32;&quot;---&quot;)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;seen_separator&#32;=&#32;true;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;continue;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(!seen_separator)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;const&#32;std::string&#32;t&#32;=&#32;trim(ln);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(t&#32;==&#32;&quot;BEFORE:&quot;)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;blk&#32;=&#32;Block::BEFORE;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;continue;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(t&#32;==&#32;&quot;MARKER:&quot;)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;blk&#32;=&#32;Block::MARKER;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;continue;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(t&#32;==&#32;&quot;AFTER:&quot;)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;blk&#32;=&#32;Block::AFTER;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;continue;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;switch&#32;(blk)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;case&#32;Block::BEFORE:<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;s.before.push_back(ln);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;break;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;case&#32;Block::MARKER:<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;s.marker.push_back(ln);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;break;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;case&#32;Block::AFTER:<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;s.after.push_back(ln);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;break;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;case&#32;Block::NONE:<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;unexpected&#32;content&#32;before&#32;YAML&#32;block&#32;tag&quot;);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;else<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;new_payload.push_back(ln);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;s.payload.swap(new_payload);<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(s.marker.empty())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;YAML&#32;text&#32;command&#32;requires&#32;MARKER:&#32;section&quot;);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;return&#32;s;<br>
}<br>
<br>
static&#32;void&#32;apply_for_file(const&#32;std::string&#32;&amp;filepath,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;const&#32;std::vector&lt;const&#32;Section&#32;*&gt;&#32;&amp;sections)<br>
{<br>
&#32;&#32;&#32;&#32;fs::path&#32;p&#32;=&#32;filepath;<br>
&#32;&#32;&#32;&#32;std::vector&lt;std::string&gt;&#32;orig;<br>
&#32;&#32;&#32;&#32;bool&#32;existed&#32;=&#32;true;<br>
<br>
&#32;&#32;&#32;&#32;try<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;orig&#32;=&#32;read_file_lines(p);<br>
&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;catch&#32;(...)<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;existed&#32;=&#32;false;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;orig.clear();<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;for&#32;(const&#32;Section&#32;*s&#32;:&#32;sections)<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(!existed&#32;&amp;&amp;&#32;s-&gt;command&#32;==&#32;&quot;delete-file&quot;)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(&quot;delete-file:&#32;file&#32;does&#32;not&#32;exist&quot;);<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;for&#32;(const&#32;Section&#32;*s&#32;:&#32;sections)<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(s-&gt;command&#32;==&#32;&quot;create-file&quot;)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;write_file_lines(p,&#32;s-&gt;payload);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(s-&gt;command&#32;==&#32;&quot;delete-file&quot;)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::error_code&#32;ec;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;fs::remove(p,&#32;ec);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(ec)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(&quot;delete-file&#32;failed&quot;);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;std::vector&lt;const&#32;Section&#32;*&gt;&#32;text_sections;<br>
&#32;&#32;&#32;&#32;std::vector&lt;const&#32;Section&#32;*&gt;&#32;symbol_sections;<br>
<br>
&#32;&#32;&#32;&#32;for&#32;(const&#32;Section&#32;*s&#32;:&#32;sections)<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(is_text_command(s-&gt;command))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;text_sections.push_back(s);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;else&#32;if&#32;(is_symbol_command(s-&gt;command))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;symbol_sections.push_back(s);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;else<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(&quot;unexpected&#32;non-text&#32;command:&#32;&quot;&#32;+<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;s-&gt;command);<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;if&#32;(!text_sections.empty())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;apply_text_commands(filepath,&#32;orig,&#32;text_sections);<br>
<br>
&#32;&#32;&#32;&#32;if&#32;(!symbol_sections.empty())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;apply_symbol_commands(filepath,&#32;orig,&#32;symbol_sections);<br>
<br>
&#32;&#32;&#32;&#32;if&#32;(!text_sections.empty()&#32;||&#32;!symbol_sections.empty())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;write_file_lines(p,&#32;orig);<br>
}<br>
<br>
static&#32;void&#32;apply_all(const&#32;std::vector&lt;Section&gt;&#32;&amp;sections)<br>
{<br>
&#32;&#32;&#32;&#32;namespace&#32;fs&#32;=&#32;std::filesystem;<br>
<br>
&#32;&#32;&#32;&#32;//&#32;1.&#32;Собираем&#32;список&#32;всех&#32;файлов,&#32;которые&#32;будут&#32;затронуты<br>
&#32;&#32;&#32;&#32;std::vector&lt;std::string&gt;&#32;files;<br>
&#32;&#32;&#32;&#32;files.reserve(sections.size());<br>
&#32;&#32;&#32;&#32;for&#32;(auto&#32;&amp;s&#32;:&#32;sections)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;files.push_back(s.filepath);<br>
<br>
&#32;&#32;&#32;&#32;std::sort(files.begin(),&#32;files.end());<br>
&#32;&#32;&#32;&#32;files.erase(std::unique(files.begin(),&#32;files.end()),&#32;files.end());<br>
<br>
&#32;&#32;&#32;&#32;struct&#32;Backup<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;bool&#32;existed&#32;=&#32;false;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::vector&lt;std::string&gt;&#32;lines;<br>
&#32;&#32;&#32;&#32;};<br>
<br>
&#32;&#32;&#32;&#32;std::map&lt;std::string,&#32;Backup&gt;&#32;backup;<br>
<br>
&#32;&#32;&#32;&#32;//&#32;2.&#32;Делаем&#32;резервную&#32;копию&#32;всех&#32;файлов<br>
&#32;&#32;&#32;&#32;for&#32;(auto&#32;&amp;f&#32;:&#32;files)<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;Backup&#32;b;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;fs::path&#32;p&#32;=&#32;f;<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::error_code&#32;ec;<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(fs::exists(p,&#32;ec))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;b.existed&#32;=&#32;true;<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;try<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;b.lines&#32;=&#32;read_file_lines(p);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;catch&#32;(...)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw&#32;std::runtime_error(&quot;cannot&#32;read&#32;original&#32;file:&#32;&quot;&#32;+&#32;f);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;else<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;b.existed&#32;=&#32;false;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;backup[f]&#32;=&#32;std::move(b);<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;//&#32;3.&#32;Применяем&#32;секции&#32;с&#32;защитой&#32;(try/catch)<br>
&#32;&#32;&#32;&#32;try<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;for&#32;(auto&#32;&amp;s&#32;:&#32;sections)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::vector&lt;const&#32;Section&#32;*&gt;&#32;single{&amp;s};<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;apply_for_file(s.filepath,&#32;single);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;catch&#32;(...)<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;4.&#32;Откат&#32;(rollback)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;for&#32;(auto&#32;&amp;[path,&#32;b]&#32;:&#32;backup)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;fs::path&#32;p&#32;=&#32;path;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::error_code&#32;ec;<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(b.existed)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;try<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;write_file_lines(p,&#32;b.lines);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;catch&#32;(...)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;если&#32;даже&#32;откат&#32;не&#32;удался&#32;—&#32;сдаёмся<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;else<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;fs::remove(p,&#32;ec);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;throw;<br>
&#32;&#32;&#32;&#32;}<br>
}<br>
<br>
int&#32;apply_chunk_main(int&#32;argc,&#32;char&#32;**argv)<br>
{<br>
&#32;&#32;&#32;&#32;if&#32;(argc&#32;&lt;&#32;2)<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::cerr&#32;&lt;&lt;&#32;&quot;usage:&#32;apply_patch&#32;&lt;patchfile&gt;\n&quot;;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return&#32;1;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;std::ifstream&#32;in(argv[1]);<br>
&#32;&#32;&#32;&#32;if&#32;(!in)<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::cerr&#32;&lt;&lt;&#32;&quot;cannot&#32;open&#32;patch&#32;file:&#32;&quot;&#32;&lt;&lt;&#32;argv[1]&#32;&lt;&lt;&#32;&quot;\n&quot;;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return&#32;1;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;std::string&#32;line;<br>
&#32;&#32;&#32;&#32;std::vector&lt;Section&gt;&#32;sections;<br>
&#32;&#32;&#32;&#32;int&#32;seq&#32;=&#32;0;<br>
<br>
&#32;&#32;&#32;&#32;try<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;while&#32;(std::getline(in,&#32;line))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(line.rfind(&quot;===&#32;file:&quot;,&#32;0)&#32;==&#32;0)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;Section&#32;s&#32;=&#32;parse_section(in,&#32;line);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;s.seq&#32;=&#32;seq++;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;sections.push_back(std::move(s));<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;apply_all(sections);<br>
&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;catch&#32;(const&#32;std::exception&#32;&amp;e)<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::cerr&#32;&lt;&lt;&#32;&quot;error&#32;while&#32;applying&#32;patch:&#32;&quot;&#32;&lt;&lt;&#32;e.what()&#32;&lt;&lt;&#32;&quot;\n&quot;;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return&#32;1;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;return&#32;0;<br>
}<br>
<!-- END SCAT CODE -->
</body>
</html>
