<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>src/parser.cpp</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
#include &#20;&quot;parser.h&quot;<br>
#include &#20;&quot;rules.h&quot;<br>
#include &#20;&lt;cctype&gt;<br>
#include &#20;&lt;fstream&gt;<br>
#include &#20;&lt;stdexcept&gt;<br>
<br>
namespace &#20;fs &#20;= &#20;std::filesystem;<br>
<br>
static &#20;inline &#20;void &#20;trim(std::string &#20;&amp;s)<br>
{<br>
 &#20; &#20; &#20; &#20;size_t &#20;b &#20;= &#20;s.find_first_not_of(&quot; &#20;\t\r\n&quot;);<br>
 &#20; &#20; &#20; &#20;if &#20;(b &#20;== &#20;std::string::npos)<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;s.clear();<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return;<br>
 &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20;size_t &#20;e &#20;= &#20;s.find_last_not_of(&quot; &#20;\t\r\n&quot;);<br>
 &#20; &#20; &#20; &#20;s &#20;= &#20;s.substr(b, &#20;e &#20;- &#20;b &#20;+ &#20;1);<br>
}<br>
<br>
Config &#20;parse_config(const &#20;fs::path &#20;&amp;path)<br>
{<br>
 &#20; &#20; &#20; &#20;Config &#20;cfg;<br>
 &#20; &#20; &#20; &#20;enum &#20;Section<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;TEXT_RULES,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;TREE_RULES,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;MAPFORMAT_TEXT<br>
 &#20; &#20; &#20; &#20;};<br>
 &#20; &#20; &#20; &#20;Section &#20;current &#20;= &#20;TEXT_RULES;<br>
<br>
 &#20; &#20; &#20; &#20;std::ifstream &#20;in(path);<br>
 &#20; &#20; &#20; &#20;if &#20;(!in.is_open())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;throw &#20;std::runtime_error(&quot;Failed &#20;to &#20;open &#20;config &#20;file: &#20;&quot; &#20;+<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;path.string());<br>
<br>
 &#20; &#20; &#20; &#20;std::string &#20;raw_line;<br>
 &#20; &#20; &#20; &#20;while &#20;(std::getline(in, &#20;raw_line))<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::string &#20;line &#20;= &#20;raw_line;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;trim(line);<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(current &#20;== &#20;MAPFORMAT_TEXT)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;Всё, &#20;что &#20;после &#20;[MAPFORMAT], &#20;идёт &#20;как &#20;есть &#20;(с &#20;сохранением &#20;пустых<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;строк &#20;и &#20;#) &#20;до &#20;конца &#20;файла &#20;(пока &#20;новых &#20;секций &#20;у &#20;нас &#20;нет).<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;cfg.map_format &#20;+= &#20;raw_line;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;cfg.map_format &#20;+= &#20;&quot;\n&quot;;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;continue;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;вне &#20;MAPFORMAT &#20;— &#20;старая &#20;логика<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(line.empty() &#20;|| &#20;line[0] &#20;== &#20;'#')<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;continue;<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(line &#20;== &#20;&quot;[TREE]&quot;)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;current &#20;= &#20;TREE_RULES;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;continue;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(line &#20;== &#20;&quot;[MAPFORMAT]&quot;)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;current &#20;= &#20;MAPFORMAT_TEXT;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;continue;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;Rule &#20;r &#20;= &#20;Rule::from_string(line);<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(current &#20;== &#20;TEXT_RULES)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;cfg.text_rules.push_back(r);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;else<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;cfg.tree_rules.push_back(r);<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;return &#20;cfg;<br>
}<br>
<!-- END SCAT CODE -->
</body>
</html>
