<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>src/git_info.cpp</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
#include&#32;&quot;git_info.h&quot;<br>
<br>
#include&#32;&lt;cstdio&gt;<br>
#include&#32;&lt;string&gt;<br>
<br>
//&#32;Runs&#32;a&#32;shell&#32;command&#32;and&#32;captures&#32;its&#32;stdout.<br>
//&#32;Returns&#32;empty&#32;string&#32;on&#32;error&#32;or&#32;if&#32;nothing&#32;was&#32;printed.<br>
static&#32;std::string&#32;run_command_capture(const&#32;char&#32;*cmd)<br>
{<br>
#ifdef&#32;_WIN32<br>
&#32;&#32;&#32;&#32;FILE&#32;*pipe&#32;=&#32;_popen(cmd,&#32;&quot;r&quot;);<br>
#else<br>
&#32;&#32;&#32;&#32;FILE&#32;*pipe&#32;=&#32;popen(cmd,&#32;&quot;r&quot;);<br>
#endif<br>
&#32;&#32;&#32;&#32;if&#32;(!pipe)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return&#32;{};<br>
<br>
&#32;&#32;&#32;&#32;std::string&#32;result;<br>
&#32;&#32;&#32;&#32;char&#32;buffer[256];<br>
<br>
&#32;&#32;&#32;&#32;while&#32;(fgets(buffer,&#32;sizeof(buffer),&#32;pipe))<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;result&#32;+=&#32;buffer;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
#ifdef&#32;_WIN32<br>
&#32;&#32;&#32;&#32;_pclose(pipe);<br>
#else<br>
&#32;&#32;&#32;&#32;pclose(pipe);<br>
#endif<br>
<br>
&#32;&#32;&#32;&#32;//&#32;strip&#32;trailing&#32;newlines<br>
&#32;&#32;&#32;&#32;while&#32;(!result.empty()&#32;&amp;&amp;&#32;(result.back()&#32;==&#32;'\n'&#32;||&#32;result.back()&#32;==&#32;'\r'))<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;result.pop_back();<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;return&#32;result;<br>
}<br>
<br>
GitInfo&#32;detect_git_info()<br>
{<br>
&#32;&#32;&#32;&#32;GitInfo&#32;info;<br>
<br>
#ifdef&#32;_WIN32<br>
&#32;&#32;&#32;&#32;std::string&#32;commit&#32;=&#32;run_command_capture(&quot;git&#32;rev-parse&#32;HEAD&#32;2&gt;nul&quot;);<br>
&#32;&#32;&#32;&#32;std::string&#32;remote&#32;=<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;run_command_capture(&quot;git&#32;config&#32;--get&#32;remote.origin.url&#32;2&gt;nul&quot;);<br>
#else<br>
&#32;&#32;&#32;&#32;std::string&#32;commit&#32;=&#32;run_command_capture(&quot;git&#32;rev-parse&#32;HEAD&#32;2&gt;/dev/null&quot;);<br>
&#32;&#32;&#32;&#32;std::string&#32;remote&#32;=<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;run_command_capture(&quot;git&#32;config&#32;--get&#32;remote.origin.url&#32;2&gt;/dev/null&quot;);<br>
#endif<br>
<br>
&#32;&#32;&#32;&#32;if&#32;(!commit.empty())<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;info.commit&#32;=&#32;commit;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;info.has_commit&#32;=&#32;true;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;if&#32;(!remote.empty())<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;info.remote&#32;=&#32;remote;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;info.has_remote&#32;=&#32;true;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;return&#32;info;<br>
}<br>
<br>
//&#32;Разбор&#32;remote&#32;вроде&#32;git@github.com:user/repo.git&#32;или<br>
//&#32;https://github.com/user/repo(.git)<br>
bool&#32;parse_github_remote(const&#32;std::string&#32;&amp;remote,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::string&#32;&amp;user,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::string&#32;&amp;repo)<br>
{<br>
&#32;&#32;&#32;&#32;const&#32;std::string&#32;host&#32;=&#32;&quot;github.com&quot;;<br>
&#32;&#32;&#32;&#32;auto&#32;pos&#32;=&#32;remote.find(host);<br>
&#32;&#32;&#32;&#32;if&#32;(pos&#32;==&#32;std::string::npos)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return&#32;false;<br>
<br>
&#32;&#32;&#32;&#32;pos&#32;+=&#32;host.size();<br>
<br>
&#32;&#32;&#32;&#32;//&#32;пропускаем&#32;':'&#32;или&#32;'/'&#32;после&#32;github.com<br>
&#32;&#32;&#32;&#32;while&#32;(pos&#32;&lt;&#32;remote.size()&#32;&amp;&amp;&#32;(remote[pos]&#32;==&#32;':'&#32;||&#32;remote[pos]&#32;==&#32;'/'))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;++pos;<br>
<br>
&#32;&#32;&#32;&#32;if&#32;(pos&#32;&gt;=&#32;remote.size())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return&#32;false;<br>
<br>
&#32;&#32;&#32;&#32;//&#32;user&#32;/&#32;repo[.git]&#32;/&#32;...<br>
&#32;&#32;&#32;&#32;auto&#32;slash1&#32;=&#32;remote.find('/',&#32;pos);<br>
&#32;&#32;&#32;&#32;if&#32;(slash1&#32;==&#32;std::string::npos)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return&#32;false;<br>
<br>
&#32;&#32;&#32;&#32;user&#32;=&#32;remote.substr(pos,&#32;slash1&#32;-&#32;pos);<br>
<br>
&#32;&#32;&#32;&#32;auto&#32;start_repo&#32;=&#32;slash1&#32;+&#32;1;<br>
&#32;&#32;&#32;&#32;if&#32;(start_repo&#32;&gt;=&#32;remote.size())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return&#32;false;<br>
<br>
&#32;&#32;&#32;&#32;auto&#32;slash2&#32;=&#32;remote.find('/',&#32;start_repo);<br>
&#32;&#32;&#32;&#32;std::string&#32;repo_part&#32;=<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;(slash2&#32;==&#32;std::string::npos)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;?&#32;remote.substr(start_repo)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;:&#32;remote.substr(start_repo,&#32;slash2&#32;-&#32;start_repo);<br>
<br>
&#32;&#32;&#32;&#32;//&#32;обрежем&#32;.git&#32;в&#32;конце,&#32;если&#32;есть<br>
&#32;&#32;&#32;&#32;const&#32;std::string&#32;dot_git&#32;=&#32;&quot;.git&quot;;<br>
&#32;&#32;&#32;&#32;if&#32;(repo_part.size()&#32;&gt;&#32;dot_git.size()&#32;&amp;&amp;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;repo_part.compare(<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;repo_part.size()&#32;-&#32;dot_git.size(),&#32;dot_git.size(),&#32;dot_git)&#32;==&#32;0)<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;repo_part.resize(repo_part.size()&#32;-&#32;dot_git.size());<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;if&#32;(user.empty()&#32;||&#32;repo_part.empty())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return&#32;false;<br>
<br>
&#32;&#32;&#32;&#32;repo&#32;=&#32;repo_part;<br>
&#32;&#32;&#32;&#32;return&#32;true;<br>
}<br>
<br>
GitHubInfo&#32;detect_github_info()<br>
{<br>
&#32;&#32;&#32;&#32;GitInfo&#32;gi&#32;=&#32;detect_git_info();<br>
&#32;&#32;&#32;&#32;GitHubInfo&#32;out;<br>
&#32;&#32;&#32;&#32;if&#32;(!gi.has_commit&#32;||&#32;!gi.has_remote)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return&#32;out;<br>
<br>
&#32;&#32;&#32;&#32;if&#32;(!parse_github_remote(gi.remote,&#32;out.user,&#32;out.repo))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return&#32;out;<br>
<br>
&#32;&#32;&#32;&#32;out.commit&#32;=&#32;gi.commit;<br>
&#32;&#32;&#32;&#32;out.ok&#32;=&#32;true;<br>
&#32;&#32;&#32;&#32;return&#32;out;<br>
}<br>
<br>
std::string&#32;detect_git_dir()<br>
{<br>
#ifdef&#32;_WIN32<br>
&#32;&#32;&#32;&#32;return&#32;run_command_capture(&quot;git&#32;rev-parse&#32;--git-dir&#32;2&gt;nul&quot;);<br>
#else<br>
&#32;&#32;&#32;&#32;return&#32;run_command_capture(&quot;git&#32;rev-parse&#32;--git-dir&#32;2&gt;/dev/null&quot;);<br>
#endif<br>
}<br>
<!-- END SCAT CODE -->
</body>
</html>
