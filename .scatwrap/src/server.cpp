<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>src/server.cpp</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
#include &#20;&quot;collector.h&quot;<br>
#include &#20;&quot;options.h&quot;<br>
#include &#20;&quot;parser.h&quot;<br>
#include &#20;&quot;util.h&quot;<br>
<br>
#include &#20;&lt;cstdint&gt;<br>
#include &#20;&lt;filesystem&gt;<br>
#include &#20;&lt;fstream&gt;<br>
#include &#20;&lt;iostream&gt;<br>
#include &#20;&lt;map&gt;<br>
#include &#20;&lt;sstream&gt;<br>
#include &#20;&lt;vector&gt;<br>
<br>
namespace &#20;fs &#20;= &#20;std::filesystem;<br>
<br>
#ifndef &#20;_WIN32<br>
#include &#20;&lt;arpa/inet.h&gt;<br>
#include &#20;&lt;netinet/in.h&gt;<br>
#include &#20;&lt;sys/socket.h&gt;<br>
#include &#20;&lt;sys/types.h&gt;<br>
#include &#20;&lt;unistd.h&gt;<br>
#endif<br>
<br>
static &#20;std::string &#20;json_escape(const &#20;std::string &#20;&amp;s)<br>
{<br>
 &#20; &#20; &#20; &#20;std::string &#20;out;<br>
 &#20; &#20; &#20; &#20;out.reserve(s.size());<br>
 &#20; &#20; &#20; &#20;for &#20;(char &#20;c &#20;: &#20;s)<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;switch &#20;(c)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;case &#20;'\\':<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;out &#20;+= &#20;&quot;\\\\&quot;;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;break;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;case &#20;'&quot;':<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;out &#20;+= &#20;&quot;\\\&quot;&quot;;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;break;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;case &#20;'\n':<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;out &#20;+= &#20;&quot;\\n&quot;;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;break;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;case &#20;'\r':<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;out &#20;+= &#20;&quot;\\r&quot;;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;break;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;case &#20;'\t':<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;out &#20;+= &#20;&quot;\\t&quot;;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;break;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;default:<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;out &#20;+= &#20;c;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;break;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20;return &#20;out;<br>
}<br>
<br>
int &#20;run_server(const &#20;Options &#20;&amp;opt)<br>
{<br>
#ifdef &#20;_WIN32<br>
 &#20; &#20; &#20; &#20;(void)opt;<br>
 &#20; &#20; &#20; &#20;std::cerr &#20;&lt;&lt; &#20;&quot;--server &#20;is &#20;not &#20;supported &#20;on &#20;Windows &#20;yet.\n&quot;;<br>
 &#20; &#20; &#20; &#20;return &#20;1;<br>
#else<br>
 &#20; &#20; &#20; &#20;if &#20;(opt.server_port &#20;&lt;= &#20;0 &#20;|| &#20;opt.server_port &#20;&gt; &#20;65535)<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::cerr &#20;&lt;&lt; &#20;&quot;Invalid &#20;port &#20;for &#20;--server: &#20;&quot; &#20;&lt;&lt; &#20;opt.server_port &#20;&lt;&lt; &#20;&quot;\n&quot;;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return &#20;1;<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;// &#20;Собираем &#20;список &#20;файлов &#20;так &#20;же, &#20;как &#20;в &#20;обычном &#20;scat:<br>
 &#20; &#20; &#20; &#20;// &#20;при &#20;наличии &#20;config_file &#20;— &#20;через &#20;scat.txt/--config,<br>
 &#20; &#20; &#20; &#20;// &#20;иначе &#20;— &#20;из &#20;paths.<br>
 &#20; &#20; &#20; &#20;std::vector&lt;fs::path&gt; &#20;files;<br>
<br>
 &#20; &#20; &#20; &#20;if &#20;(!opt.config_file.empty())<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;Config &#20;cfg &#20;= &#20;parse_config(opt.config_file);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;files &#20;= &#20;collect_from_rules(cfg.text_rules, &#20;opt);<br>
 &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20;else<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;files &#20;= &#20;collect_from_paths(opt.paths, &#20;opt);<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;if &#20;(files.empty())<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::cerr &#20;&lt;&lt; &#20;&quot;No &#20;files &#20;collected &#20;for &#20;server.\n&quot;;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return &#20;1;<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;// &#20;Ключ: &#20;строковый &#20;путь &#20;(как &#20;печатаем &#20;в &#20;scat), &#20;значение: &#20;реальный &#20;путь<br>
 &#20; &#20; &#20; &#20;std::map&lt;std::string, &#20;fs::path&gt; &#20;file_map;<br>
 &#20; &#20; &#20; &#20;for &#20;(auto &#20;&amp;f &#20;: &#20;files)<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::string &#20;key &#20;= &#20;make_display_path(f);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;file_map[key] &#20;= &#20;f;<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;int &#20;server_fd &#20;= &#20;::socket(AF_INET, &#20;SOCK_STREAM, &#20;0);<br>
 &#20; &#20; &#20; &#20;if &#20;(server_fd &#20;&lt; &#20;0)<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;perror(&quot;socket&quot;);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return &#20;1;<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;int &#20;yes &#20;= &#20;1;<br>
 &#20; &#20; &#20; &#20;::setsockopt(server_fd, &#20;SOL_SOCKET, &#20;SO_REUSEADDR, &#20;&amp;yes, &#20;sizeof(yes));<br>
<br>
 &#20; &#20; &#20; &#20;sockaddr_in &#20;addr{};<br>
 &#20; &#20; &#20; &#20;addr.sin_family &#20;= &#20;AF_INET;<br>
 &#20; &#20; &#20; &#20;addr.sin_addr.s_addr &#20;= &#20;htonl(INADDR_ANY);<br>
 &#20; &#20; &#20; &#20;addr.sin_port &#20;= &#20;htons(static_cast&lt;uint16_t&gt;(opt.server_port));<br>
<br>
 &#20; &#20; &#20; &#20;if &#20;(::bind(server_fd, &#20;reinterpret_cast&lt;sockaddr &#20;*&gt;(&amp;addr), &#20;sizeof(addr)) &#20;&lt;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;0)<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;perror(&quot;bind&quot;);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;::close(server_fd);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return &#20;1;<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;if &#20;(::listen(server_fd, &#20;16) &#20;&lt; &#20;0)<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;perror(&quot;listen&quot;);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;::close(server_fd);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return &#20;1;<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;std::cout &#20;&lt;&lt; &#20;&quot;Serving &#20;&quot; &#20;&lt;&lt; &#20;file_map.size()<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&lt;&lt; &#20;&quot; &#20;files &#20;on &#20;http://127.0.0.1:&quot; &#20;&lt;&lt; &#20;opt.server_port &#20;&lt;&lt; &#20;&quot;\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&lt;&lt; &#20;&quot;Endpoints:\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&lt;&lt; &#20;&quot; &#20; &#20;/index.json\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&lt;&lt; &#20;&quot; &#20; &#20;/&lt;path&gt;\n&quot;;<br>
<br>
 &#20; &#20; &#20; &#20;for &#20;(;;)<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;int &#20;client &#20;= &#20;::accept(server_fd, &#20;nullptr, &#20;nullptr);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(client &#20;&lt; &#20;0)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;perror(&quot;accept&quot;);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;continue;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::string &#20;request;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;char &#20;buf[4096];<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;ssize_t &#20;n &#20;= &#20;::recv(client, &#20;buf, &#20;sizeof(buf), &#20;0);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(n &#20;&lt;= &#20;0)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;::close(client);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;continue;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;request.append(buf, &#20;static_cast&lt;std::size_t&gt;(n));<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::istringstream &#20;req_stream(request);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::string &#20;method, &#20;target, &#20;version;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;req_stream &#20;&gt;&gt; &#20;method &#20;&gt;&gt; &#20;target &#20;&gt;&gt; &#20;version;<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;auto &#20;send_response &#20;= &#20;[&amp;](const &#20;std::string &#20;&amp;status_line,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;const &#20;std::string &#20;&amp;content_type,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;const &#20;std::string &#20;&amp;body)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::ostringstream &#20;out;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;out &#20;&lt;&lt; &#20;status_line &#20;&lt;&lt; &#20;&quot;\r\n&quot;;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;out &#20;&lt;&lt; &#20;&quot;Content-Type: &#20;&quot; &#20;&lt;&lt; &#20;content_type &#20;&lt;&lt; &#20;&quot;\r\n&quot;;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;out &#20;&lt;&lt; &#20;&quot;Content-Length: &#20;&quot; &#20;&lt;&lt; &#20;body.size() &#20;&lt;&lt; &#20;&quot;\r\n&quot;;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;out &#20;&lt;&lt; &#20;&quot;Connection: &#20;close\r\n&quot;;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;out &#20;&lt;&lt; &#20;&quot;\r\n&quot;;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;out &#20;&lt;&lt; &#20;body;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::string &#20;s &#20;= &#20;out.str();<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;::send(client, &#20;s.data(), &#20;s.size(), &#20;0);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;};<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(method &#20;!= &#20;&quot;GET&quot;)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;send_response(&quot;HTTP/1.0 &#20;405 &#20;Method &#20;Not &#20;Allowed&quot;,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;text/plain; &#20;charset=utf-8&quot;,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;Only &#20;GET &#20;is &#20;supported\n&quot;);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;::close(client);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;continue;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(target.empty())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;target &#20;= &#20;&quot;/&quot;;<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;Корневая &#20;страница &#20;с &#20;краткой &#20;подсказкой<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(target &#20;== &#20;&quot;/&quot;)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::ostringstream &#20;body;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;body &#20;&lt;&lt; &#20;&quot;&lt;!DOCTYPE &#20;html&gt;\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&lt;&lt; &#20;&quot;&lt;html&gt;&lt;head&gt;&lt;meta &#20;charset=\&quot;utf-8\&quot;&gt;&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&lt;&lt; &#20;&quot;&lt;title&gt;scat &#20;server&lt;/title&gt;&lt;/head&gt;&lt;body&gt;\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&lt;&lt; &#20;&quot;&lt;h1&gt;scat &#20;server&lt;/h1&gt;\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&lt;&lt; &#20;&quot;&lt;p&gt;This &#20;is &#20;a &#20;read-only &#20;file &#20;server &#20;started &#20;by &#20;&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&lt;&lt; &#20;&quot;&lt;code&gt;scat &#20;--server &#20;PORT&lt;/code&gt;.&lt;/p&gt;\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&lt;&lt; &#20;&quot;&lt;ul&gt;\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&lt;&lt; &#20;&quot; &#20; &#20;&lt;li&gt;&lt;code&gt;/index.json&lt;/code&gt; &#20;– &#20;list &#20;of &#20;files &#20;as &#20;&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;JSON.&lt;/li&gt;\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&lt;&lt; &#20;&quot; &#20; &#20;&lt;li&gt;&lt;code&gt;/{relative-path}&lt;/code&gt; &#20;– &#20;raw &#20;file &#20;contents. &#20;&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&lt;&lt; &#20;&quot;Path &#20;must &#20;match &#20;an &#20;entry &#20;from &#20;&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;&lt;code&gt;index.json&lt;/code&gt;.&lt;/li&gt;\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&lt;&lt; &#20;&quot;&lt;/ul&gt;\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&lt;&lt; &#20;&quot;&lt;/body&gt;&lt;/html&gt;\n&quot;;<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;send_response(<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;HTTP/1.0 &#20;200 &#20;OK&quot;, &#20;&quot;text/html; &#20;charset=utf-8&quot;, &#20;body.str());<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;::close(client);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;continue;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(target &#20;== &#20;&quot;/index.json&quot;)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::ostringstream &#20;body;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;body &#20;&lt;&lt; &#20;&quot;{\n &#20; &#20;\&quot;files\&quot;: &#20;[\n&quot;;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;bool &#20;first &#20;= &#20;true;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;for &#20;(const &#20;auto &#20;&amp;[name, &#20;_] &#20;: &#20;file_map)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(!first)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;body &#20;&lt;&lt; &#20;&quot;,\n&quot;;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;first &#20;= &#20;false;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;body &#20;&lt;&lt; &#20;&quot; &#20; &#20; &#20; &#20;\&quot;&quot; &#20;&lt;&lt; &#20;json_escape(name) &#20;&lt;&lt; &#20;&quot;\&quot;&quot;;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;body &#20;&lt;&lt; &#20;&quot;\n &#20; &#20;]\n}\n&quot;;<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;send_response(&quot;HTTP/1.0 &#20;200 &#20;OK&quot;,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;application/json; &#20;charset=utf-8&quot;,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;body.str());<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;::close(client);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;continue;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(!target.empty() &#20;&amp;&amp; &#20;target[0] &#20;== &#20;'/')<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;target.erase(0, &#20;1);<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;auto &#20;it &#20;= &#20;file_map.find(target);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(it &#20;== &#20;file_map.end())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;send_response(&quot;HTTP/1.0 &#20;404 &#20;Not &#20;Found&quot;,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;text/plain; &#20;charset=utf-8&quot;,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;Not &#20;found\n&quot;);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;::close(client);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;continue;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::ifstream &#20;in(it-&gt;second, &#20;std::ios::binary);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(!in)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;send_response(&quot;HTTP/1.0 &#20;500 &#20;Internal &#20;Server &#20;Error&quot;,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;text/plain; &#20;charset=utf-8&quot;,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;Cannot &#20;open &#20;file\n&quot;);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;::close(client);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;continue;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::ostringstream &#20;body;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;body &#20;&lt;&lt; &#20;in.rdbuf();<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;send_response(<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;HTTP/1.0 &#20;200 &#20;OK&quot;, &#20;&quot;text/plain; &#20;charset=utf-8&quot;, &#20;body.str());<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;::close(client);<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;// &#20;теоретически &#20;недостижимо<br>
 &#20; &#20; &#20; &#20;::close(server_fd);<br>
 &#20; &#20; &#20; &#20;return &#20;0;<br>
#endif<br>
}<br>
<!-- END SCAT CODE -->
</body>
</html>
