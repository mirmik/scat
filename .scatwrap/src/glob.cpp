<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>src/glob.cpp</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
#include &#20;&quot;glob.h&quot;<br>
#include &#20;&quot;util.h&quot;<br>
#include &#20;&lt;algorithm&gt;<br>
#include &#20;&lt;filesystem&gt;<br>
#include &#20;&lt;functional&gt;<br>
#include &#20;&lt;sstream&gt;<br>
#include &#20;&lt;string&gt;<br>
#include &#20;&lt;vector&gt;<br>
<br>
namespace &#20;fs &#20;= &#20;std::filesystem;<br>
<br>
static &#20;bool &#20;is_wildcard(const &#20;std::string &#20;&amp;s)<br>
{<br>
 &#20; &#20; &#20; &#20;return &#20;s &#20;== &#20;&quot;*&quot; &#20;|| &#20;s &#20;== &#20;&quot;**&quot; &#20;|| &#20;s.find('*') &#20;!= &#20;std::string::npos;<br>
}<br>
<br>
// &#20;matcit &#20;только &#20;filename, &#20;НЕ &#20;директорию<br>
static &#20;bool &#20;match_name(const &#20;fs::path &#20;&amp;p, &#20;const &#20;std::string &#20;&amp;seg)<br>
{<br>
 &#20; &#20; &#20; &#20;return &#20;match_simple(p, &#20;seg);<br>
}<br>
<br>
std::vector&lt;fs::path&gt; &#20;expand_glob(const &#20;std::string &#20;&amp;pattern)<br>
{<br>
 &#20; &#20; &#20; &#20;std::vector&lt;fs::path&gt; &#20;out;<br>
 &#20; &#20; &#20; &#20;std::error_code &#20;ec;<br>
<br>
 &#20; &#20; &#20; &#20;fs::path &#20;pat(pattern);<br>
 &#20; &#20; &#20; &#20;fs::path &#20;root &#20;= &#20;pat.root_path(); &#20;// &#20;&quot;/&quot; &#20;или &#20;&quot;C:&quot; &#20;или &#20;&quot;&quot;<br>
 &#20; &#20; &#20; &#20;fs::path &#20;rel &#20;= &#20;pat.relative_path();<br>
<br>
 &#20; &#20; &#20; &#20;if &#20;(root.empty())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;root &#20;= &#20;&quot;.&quot;;<br>
<br>
 &#20; &#20; &#20; &#20;// &#20;Разбиваем &#20;на &#20;части<br>
 &#20; &#20; &#20; &#20;std::vector&lt;std::string&gt; &#20;parts;<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::stringstream &#20;ss(rel.generic_string());<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::string &#20;seg;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;while &#20;(std::getline(ss, &#20;seg, &#20;'/'))<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;parts.push_back(seg);<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;// &#20;Определяем &#20;статический &#20;префикс &#20;(до &#20;первой &#20;звёздочки)<br>
 &#20; &#20; &#20; &#20;size_t &#20;start &#20;= &#20;0;<br>
 &#20; &#20; &#20; &#20;for &#20;(; &#20;start &#20;&lt; &#20;parts.size(); &#20;++start)<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;const &#20;auto &#20;&amp;seg &#20;= &#20;parts[start];<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(is_wildcard(seg))<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;break;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;root &#20;/= &#20;seg;<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;if &#20;(!fs::exists(root, &#20;ec))<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return &#20;out;<br>
<br>
 &#20; &#20; &#20; &#20;// &#20;Основной &#20;обход<br>
 &#20; &#20; &#20; &#20;std::function&lt;void(const &#20;fs::path &#20;&amp;, &#20;size_t)&gt; &#20;walk &#20;=<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;[&amp;](const &#20;fs::path &#20;&amp;base, &#20;size_t &#20;idx)<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(idx &#20;== &#20;parts.size())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(fs::is_regular_file(base, &#20;ec))<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;out.push_back(base);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;const &#20;std::string &#20;&amp;seg &#20;= &#20;parts[idx];<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;---------------------------------------------------------------------<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;&quot;**&quot; &#20;→ &#20;полный &#20;рекурсивный &#20;обход<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;---------------------------------------------------------------------<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(seg &#20;== &#20;&quot;**&quot;)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;вариант &#20;0 &#20;уровней<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;walk(base, &#20;idx &#20;+ &#20;1);<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;вариант &#20;1+ &#20;уровней<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(fs::is_directory(base, &#20;ec))<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;for &#20;(auto &#20;&amp;e &#20;: &#20;fs::directory_iterator(base, &#20;ec))<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;walk(e.path(), &#20;idx); &#20;// &#20;двигаемся &#20;дальше, &#20;idx &#20;НЕ &#20;увеличиваем<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;---------------------------------------------------------------------<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;&quot;*&quot; &#20;или &#20;&quot;ma*sk&quot; &#20;→ &#20;только &#20;ОДИН &#20;уровень, &#20;без &#20;рекурсии<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;---------------------------------------------------------------------<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(seg.find('*') &#20;!= &#20;std::string::npos)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(!fs::is_directory(base, &#20;ec))<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return;<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;for &#20;(auto &#20;&amp;e &#20;: &#20;fs::directory_iterator(base, &#20;ec))<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(!match_name(e.path(), &#20;seg))<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;continue;<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;если &#20;это &#20;последний &#20;сегмент &#20;— &#20;принимаем &#20;только &#20;файлы<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(idx &#20;+ &#20;1 &#20;== &#20;parts.size())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(e.is_regular_file())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;out.push_back(e.path());<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;else<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;walk(e.path(), &#20;idx &#20;+ &#20;1);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;---------------------------------------------------------------------<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;обычное &#20;имя &#20;→ &#20;просто &#20;переходим<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;---------------------------------------------------------------------<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;fs::path &#20;next &#20;= &#20;base &#20;/ &#20;seg;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(fs::exists(next, &#20;ec))<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;walk(next, &#20;idx &#20;+ &#20;1);<br>
 &#20; &#20; &#20; &#20;};<br>
<br>
 &#20; &#20; &#20; &#20;walk(root, &#20;start);<br>
<br>
 &#20; &#20; &#20; &#20;// &#20;удалить &#20;дубликаты<br>
 &#20; &#20; &#20; &#20;std::sort(out.begin(), &#20;out.end());<br>
 &#20; &#20; &#20; &#20;out.erase(std::unique(out.begin(), &#20;out.end()), &#20;out.end());<br>
<br>
 &#20; &#20; &#20; &#20;return &#20;out;<br>
}<br>
<!-- END SCAT CODE -->
</body>
</html>
