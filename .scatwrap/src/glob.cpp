<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>src/glob.cpp</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
#include&#32;&quot;glob.h&quot;<br>
#include&#32;&quot;util.h&quot;<br>
#include&#32;&lt;algorithm&gt;<br>
#include&#32;&lt;filesystem&gt;<br>
#include&#32;&lt;functional&gt;<br>
#include&#32;&lt;sstream&gt;<br>
#include&#32;&lt;string&gt;<br>
#include&#32;&lt;vector&gt;<br>
<br>
namespace&#32;fs&#32;=&#32;std::filesystem;<br>
<br>
static&#32;bool&#32;is_wildcard(const&#32;std::string&#32;&amp;s)<br>
{<br>
&#32;&#32;&#32;&#32;return&#32;s&#32;==&#32;&quot;*&quot;&#32;||&#32;s&#32;==&#32;&quot;**&quot;&#32;||&#32;s.find('*')&#32;!=&#32;std::string::npos;<br>
}<br>
<br>
//&#32;matcit&#32;только&#32;filename,&#32;НЕ&#32;директорию<br>
static&#32;bool&#32;match_name(const&#32;fs::path&#32;&amp;p,&#32;const&#32;std::string&#32;&amp;seg)<br>
{<br>
&#32;&#32;&#32;&#32;return&#32;match_simple(p,&#32;seg);<br>
}<br>
<br>
std::vector&lt;fs::path&gt;&#32;expand_glob(const&#32;std::string&#32;&amp;pattern)<br>
{<br>
&#32;&#32;&#32;&#32;std::vector&lt;fs::path&gt;&#32;out;<br>
&#32;&#32;&#32;&#32;std::error_code&#32;ec;<br>
<br>
&#32;&#32;&#32;&#32;fs::path&#32;pat(pattern);<br>
&#32;&#32;&#32;&#32;fs::path&#32;root&#32;=&#32;pat.root_path();&#32;//&#32;&quot;/&quot;&#32;или&#32;&quot;C:&quot;&#32;или&#32;&quot;&quot;<br>
&#32;&#32;&#32;&#32;fs::path&#32;rel&#32;=&#32;pat.relative_path();<br>
<br>
&#32;&#32;&#32;&#32;if&#32;(root.empty())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;root&#32;=&#32;&quot;.&quot;;<br>
<br>
&#32;&#32;&#32;&#32;//&#32;Разбиваем&#32;на&#32;части<br>
&#32;&#32;&#32;&#32;std::vector&lt;std::string&gt;&#32;parts;<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::stringstream&#32;ss(rel.generic_string());<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::string&#32;seg;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;while&#32;(std::getline(ss,&#32;seg,&#32;'/'))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;parts.push_back(seg);<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;//&#32;Определяем&#32;статический&#32;префикс&#32;(до&#32;первой&#32;звёздочки)<br>
&#32;&#32;&#32;&#32;size_t&#32;start&#32;=&#32;0;<br>
&#32;&#32;&#32;&#32;for&#32;(;&#32;start&#32;&lt;&#32;parts.size();&#32;++start)<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;const&#32;auto&#32;&amp;seg&#32;=&#32;parts[start];<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(is_wildcard(seg))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;break;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;root&#32;/=&#32;seg;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;if&#32;(!fs::exists(root,&#32;ec))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return&#32;out;<br>
<br>
&#32;&#32;&#32;&#32;//&#32;Основной&#32;обход<br>
&#32;&#32;&#32;&#32;std::function&lt;void(const&#32;fs::path&#32;&amp;,&#32;size_t)&gt;&#32;walk&#32;=<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;[&amp;](const&#32;fs::path&#32;&amp;base,&#32;size_t&#32;idx)<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(idx&#32;==&#32;parts.size())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(fs::is_regular_file(base,&#32;ec))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out.push_back(base);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;const&#32;std::string&#32;&amp;seg&#32;=&#32;parts[idx];<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;---------------------------------------------------------------------<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;&quot;**&quot;&#32;→&#32;полный&#32;рекурсивный&#32;обход<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;---------------------------------------------------------------------<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(seg&#32;==&#32;&quot;**&quot;)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;вариант&#32;0&#32;уровней<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;walk(base,&#32;idx&#32;+&#32;1);<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;вариант&#32;1+&#32;уровней<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(fs::is_directory(base,&#32;ec))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;for&#32;(auto&#32;&amp;e&#32;:&#32;fs::directory_iterator(base,&#32;ec))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;walk(e.path(),&#32;idx);&#32;//&#32;двигаемся&#32;дальше,&#32;idx&#32;НЕ&#32;увеличиваем<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;---------------------------------------------------------------------<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;&quot;*&quot;&#32;или&#32;&quot;ma*sk&quot;&#32;→&#32;только&#32;ОДИН&#32;уровень,&#32;без&#32;рекурсии<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;---------------------------------------------------------------------<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(seg.find('*')&#32;!=&#32;std::string::npos)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(!fs::is_directory(base,&#32;ec))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return;<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;for&#32;(auto&#32;&amp;e&#32;:&#32;fs::directory_iterator(base,&#32;ec))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(!match_name(e.path(),&#32;seg))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;continue;<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;если&#32;это&#32;последний&#32;сегмент&#32;—&#32;принимаем&#32;только&#32;файлы<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(idx&#32;+&#32;1&#32;==&#32;parts.size())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(e.is_regular_file())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out.push_back(e.path());<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;else<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;walk(e.path(),&#32;idx&#32;+&#32;1);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;---------------------------------------------------------------------<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;обычное&#32;имя&#32;→&#32;просто&#32;переходим<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;---------------------------------------------------------------------<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;fs::path&#32;next&#32;=&#32;base&#32;/&#32;seg;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(fs::exists(next,&#32;ec))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;walk(next,&#32;idx&#32;+&#32;1);<br>
&#32;&#32;&#32;&#32;};<br>
<br>
&#32;&#32;&#32;&#32;walk(root,&#32;start);<br>
<br>
&#32;&#32;&#32;&#32;//&#32;удалить&#32;дубликаты<br>
&#32;&#32;&#32;&#32;std::sort(out.begin(),&#32;out.end());<br>
&#32;&#32;&#32;&#32;out.erase(std::unique(out.begin(),&#32;out.end()),&#32;out.end());<br>
<br>
&#32;&#32;&#32;&#32;return&#32;out;<br>
}<br>
<!-- END SCAT CODE -->
</body>
</html>
