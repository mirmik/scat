<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>src/clipboard.cpp</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
#include&#32;&quot;clipboard.h&quot;<br>
#include&#32;&lt;cstdio&gt;<br>
#include&#32;&lt;iostream&gt;<br>
<br>
//&#32;Копирование&#32;текста&#32;в&#32;системный&#32;буфер&#32;обмена.<br>
//&#32;Платформы:<br>
//&#32;&#32;&#32;Linux/Unix:&#32;wl-copy,&#32;xclip,&#32;xsel&#32;(что&#32;найдётся&#32;и&#32;успешно&#32;отработает)<br>
//&#32;&#32;&#32;macOS:&#32;pbcopy<br>
//&#32;&#32;&#32;Windows:&#32;clip<br>
void&#32;copy_to_clipboard(const&#32;std::string&#32;&amp;text)<br>
{<br>
&#32;&#32;&#32;&#32;if&#32;(text.empty())<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return;<br>
<br>
#if&#32;defined(_WIN32)<br>
&#32;&#32;&#32;&#32;FILE&#32;*pipe&#32;=&#32;_popen(&quot;clip&quot;,&#32;&quot;w&quot;);<br>
&#32;&#32;&#32;&#32;if&#32;(!pipe)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return;<br>
&#32;&#32;&#32;&#32;std::fwrite(text.data(),&#32;1,&#32;text.size(),&#32;pipe);<br>
&#32;&#32;&#32;&#32;_pclose(pipe);<br>
#elif&#32;defined(__APPLE__)<br>
&#32;&#32;&#32;&#32;FILE&#32;*pipe&#32;=&#32;popen(&quot;pbcopy&quot;,&#32;&quot;w&quot;);<br>
&#32;&#32;&#32;&#32;if&#32;(!pipe)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return;<br>
&#32;&#32;&#32;&#32;std::fwrite(text.data(),&#32;1,&#32;text.size(),&#32;pipe);<br>
&#32;&#32;&#32;&#32;pclose(pipe);<br>
#else<br>
&#32;&#32;&#32;&#32;//&#32;POSIX:&#32;пытаемся&#32;по&#32;очереди&#32;несколько&#32;утилит.<br>
&#32;&#32;&#32;&#32;//&#32;stderr&#32;каждой&#32;уводим&#32;в&#32;/dev/null,&#32;чтобы&#32;они&#32;не&#32;засоряли&#32;терминал.<br>
&#32;&#32;&#32;&#32;const&#32;char&#32;*commands[]&#32;=&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;wl-copy&#32;2&gt;/dev/null&quot;,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;xclip&#32;-selection&#32;clipboard&#32;2&gt;/dev/null&quot;,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;xsel&#32;--clipboard&#32;--input&#32;2&gt;/dev/null&quot;,<br>
&#32;&#32;&#32;&#32;};<br>
<br>
&#32;&#32;&#32;&#32;for&#32;(const&#32;char&#32;*cmd&#32;:&#32;commands)<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;FILE&#32;*pipe&#32;=&#32;popen(cmd,&#32;&quot;w&quot;);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(!pipe)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;continue;<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::fwrite(text.data(),&#32;1,&#32;text.size(),&#32;pipe);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;int&#32;rc&#32;=&#32;pclose(pipe);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(rc&#32;==&#32;0)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;break;&#32;//&#32;какая-то&#32;из&#32;утилит&#32;успешно&#32;отработала<br>
&#32;&#32;&#32;&#32;}<br>
#endif<br>
}<br>
<br>
CopyGuard::CopyGuard(bool&#32;enabled)&#32;:&#32;enabled_(enabled),&#32;old_buf_(nullptr)<br>
{<br>
&#32;&#32;&#32;&#32;if&#32;(enabled_)<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;old_buf_&#32;=&#32;std::cout.rdbuf(buffer_.rdbuf());<br>
&#32;&#32;&#32;&#32;}<br>
}<br>
<br>
CopyGuard::~CopyGuard()<br>
{<br>
&#32;&#32;&#32;&#32;if&#32;(!enabled_)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return;<br>
<br>
&#32;&#32;&#32;&#32;//&#32;вернуть&#32;настоящий&#32;буфер&#32;std::cout<br>
&#32;&#32;&#32;&#32;std::cout.rdbuf(old_buf_);<br>
<br>
&#32;&#32;&#32;&#32;const&#32;std::string&#32;out&#32;=&#32;buffer_.str();<br>
&#32;&#32;&#32;&#32;if&#32;(!out.empty())<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;НИЧЕГО&#32;не&#32;печатаем&#32;в&#32;консоль!<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;Просто&#32;отправляем&#32;весь&#32;текст&#32;в&#32;буфер&#32;обмена.<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;copy_to_clipboard(out);<br>
&#32;&#32;&#32;&#32;}<br>
}<br>
<!-- END SCAT CODE -->
</body>
</html>
