<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>src/clipboard.cpp</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
#include &#20;&quot;clipboard.h&quot;<br>
#include &#20;&lt;cstdio&gt;<br>
#include &#20;&lt;iostream&gt;<br>
<br>
// &#20;Копирование &#20;текста &#20;в &#20;системный &#20;буфер &#20;обмена.<br>
// &#20;Платформы:<br>
// &#20; &#20; &#20;Linux/Unix: &#20;wl-copy, &#20;xclip, &#20;xsel &#20;(что &#20;найдётся &#20;и &#20;успешно &#20;отработает)<br>
// &#20; &#20; &#20;macOS: &#20;pbcopy<br>
// &#20; &#20; &#20;Windows: &#20;clip<br>
void &#20;copy_to_clipboard(const &#20;std::string &#20;&amp;text)<br>
{<br>
 &#20; &#20; &#20; &#20;if &#20;(text.empty())<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return;<br>
<br>
#if &#20;defined(_WIN32)<br>
 &#20; &#20; &#20; &#20;FILE &#20;*pipe &#20;= &#20;_popen(&quot;clip&quot;, &#20;&quot;w&quot;);<br>
 &#20; &#20; &#20; &#20;if &#20;(!pipe)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return;<br>
 &#20; &#20; &#20; &#20;std::fwrite(text.data(), &#20;1, &#20;text.size(), &#20;pipe);<br>
 &#20; &#20; &#20; &#20;_pclose(pipe);<br>
#elif &#20;defined(__APPLE__)<br>
 &#20; &#20; &#20; &#20;FILE &#20;*pipe &#20;= &#20;popen(&quot;pbcopy&quot;, &#20;&quot;w&quot;);<br>
 &#20; &#20; &#20; &#20;if &#20;(!pipe)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return;<br>
 &#20; &#20; &#20; &#20;std::fwrite(text.data(), &#20;1, &#20;text.size(), &#20;pipe);<br>
 &#20; &#20; &#20; &#20;pclose(pipe);<br>
#else<br>
 &#20; &#20; &#20; &#20;// &#20;POSIX: &#20;пытаемся &#20;по &#20;очереди &#20;несколько &#20;утилит.<br>
 &#20; &#20; &#20; &#20;// &#20;stderr &#20;каждой &#20;уводим &#20;в &#20;/dev/null, &#20;чтобы &#20;они &#20;не &#20;засоряли &#20;терминал.<br>
 &#20; &#20; &#20; &#20;const &#20;char &#20;*commands[] &#20;= &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;wl-copy &#20;2&gt;/dev/null&quot;,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;xclip &#20;-selection &#20;clipboard &#20;2&gt;/dev/null&quot;,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;xsel &#20;--clipboard &#20;--input &#20;2&gt;/dev/null&quot;,<br>
 &#20; &#20; &#20; &#20;};<br>
<br>
 &#20; &#20; &#20; &#20;for &#20;(const &#20;char &#20;*cmd &#20;: &#20;commands)<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;FILE &#20;*pipe &#20;= &#20;popen(cmd, &#20;&quot;w&quot;);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(!pipe)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;continue;<br>
<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::fwrite(text.data(), &#20;1, &#20;text.size(), &#20;pipe);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;int &#20;rc &#20;= &#20;pclose(pipe);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;if &#20;(rc &#20;== &#20;0)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;break; &#20;// &#20;какая-то &#20;из &#20;утилит &#20;успешно &#20;отработала<br>
 &#20; &#20; &#20; &#20;}<br>
#endif<br>
}<br>
<br>
CopyGuard::CopyGuard(bool &#20;enabled) &#20;: &#20;enabled_(enabled), &#20;old_buf_(nullptr)<br>
{<br>
 &#20; &#20; &#20; &#20;if &#20;(enabled_)<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;old_buf_ &#20;= &#20;std::cout.rdbuf(buffer_.rdbuf());<br>
 &#20; &#20; &#20; &#20;}<br>
}<br>
<br>
CopyGuard::~CopyGuard()<br>
{<br>
 &#20; &#20; &#20; &#20;if &#20;(!enabled_)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return;<br>
<br>
 &#20; &#20; &#20; &#20;// &#20;вернуть &#20;настоящий &#20;буфер &#20;std::cout<br>
 &#20; &#20; &#20; &#20;std::cout.rdbuf(old_buf_);<br>
<br>
 &#20; &#20; &#20; &#20;const &#20;std::string &#20;out &#20;= &#20;buffer_.str();<br>
 &#20; &#20; &#20; &#20;if &#20;(!out.empty())<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;НИЧЕГО &#20;не &#20;печатаем &#20;в &#20;консоль!<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;Просто &#20;отправляем &#20;весь &#20;текст &#20;в &#20;буфер &#20;обмена.<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;copy_to_clipboard(out);<br>
 &#20; &#20; &#20; &#20;}<br>
}<br>
<!-- END SCAT CODE -->
</body>
</html>
