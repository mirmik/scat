<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>src/symbols.h</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
#pragma&#32;once<br>
<br>
#include&#32;&lt;cstddef&gt;<br>
#include&#32;&lt;string&gt;<br>
#include&#32;&lt;vector&gt;<br>
<br>
//&#32;Диапазон&#32;строк&#32;в&#32;файле&#32;(0-based,&#32;включительно).<br>
struct&#32;Region<br>
{<br>
&#32;&#32;&#32;&#32;int&#32;start_line&#32;=&#32;-1;&#32;//&#32;inclusive<br>
&#32;&#32;&#32;&#32;int&#32;end_line&#32;=&#32;-1;&#32;&#32;&#32;//&#32;inclusive<br>
};<br>
<br>
//&#32;Простейший&#32;поисковик&#32;C++-символов.<br>
//&#32;Умеет:<br>
//&#32;&#32;&#32;*&#32;находить&#32;определение&#32;класса&#32;(class&#32;/&#32;struct)<br>
//&#32;&#32;&#32;*&#32;искать&#32;методы&#32;внутри&#32;класса&#32;(по&#32;имени)<br>
class&#32;CppSymbolFinder<br>
{<br>
public:<br>
&#32;&#32;&#32;&#32;//&#32;text&#32;—&#32;полный&#32;текст&#32;файла.<br>
&#32;&#32;&#32;&#32;explicit&#32;CppSymbolFinder(const&#32;std::string&#32;&amp;text);<br>
<br>
&#32;&#32;&#32;&#32;const&#32;std::vector&lt;std::string&gt;&#32;&amp;lines()&#32;const<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return&#32;m_lines;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;//&#32;Находит&#32;определение&#32;класса&#32;(НЕ&#32;forward-declaration).<br>
&#32;&#32;&#32;&#32;//&#32;Возвращает&#32;true,&#32;если&#32;класс&#32;найден.<br>
&#32;&#32;&#32;&#32;bool&#32;find_class(const&#32;std::string&#32;&amp;class_name,&#32;Region&#32;&amp;out)&#32;const;<br>
<br>
&#32;&#32;&#32;&#32;//&#32;Находит&#32;метод&#32;внутри&#32;класса&#32;(по&#32;имени).<br>
&#32;&#32;&#32;&#32;//&#32;Ищет&#32;только&#32;внутри&#32;тела&#32;class/struct&#32;class_name.<br>
&#32;&#32;&#32;&#32;//&#32;Возвращает&#32;диапазон&#32;строк&#32;от&#32;начала&#32;объявления/определения<br>
&#32;&#32;&#32;&#32;//&#32;до&#32;';'&#32;или&#32;закрывающей&#32;'}'.<br>
&#32;&#32;&#32;&#32;bool&#32;find_method(const&#32;std::string&#32;&amp;class_name,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;const&#32;std::string&#32;&amp;method_name,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;Region&#32;&amp;out)&#32;const;<br>
<br>
private:<br>
&#32;&#32;&#32;&#32;struct&#32;Token<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;enum&#32;Kind<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;Identifier,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;Keyword,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;Symbol<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}&#32;kind;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::string&#32;text;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;int&#32;line&#32;=&#32;0;&#32;//&#32;0-based<br>
&#32;&#32;&#32;&#32;};<br>
<br>
&#32;&#32;&#32;&#32;struct&#32;ClassRange<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;Region&#32;region;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::size_t&#32;body_start_token&#32;=&#32;0;&#32;//&#32;индекс&#32;'{'<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::size_t&#32;body_end_token&#32;=&#32;0;&#32;&#32;&#32;//&#32;индекс&#32;'}'&#32;(или&#32;'};')<br>
&#32;&#32;&#32;&#32;};<br>
<br>
&#32;&#32;&#32;&#32;std::vector&lt;std::string&gt;&#32;m_lines;<br>
&#32;&#32;&#32;&#32;std::vector&lt;Token&gt;&#32;m_tokens;<br>
<br>
&#32;&#32;&#32;&#32;void&#32;tokenize(const&#32;std::string&#32;&amp;text);<br>
<br>
&#32;&#32;&#32;&#32;static&#32;bool&#32;is_ident_start(char&#32;c);<br>
&#32;&#32;&#32;&#32;static&#32;bool&#32;is_ident_char(char&#32;c);<br>
<br>
&#32;&#32;&#32;&#32;bool&#32;find_class_internal(const&#32;std::string&#32;&amp;class_name,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;ClassRange&#32;&amp;out)&#32;const;<br>
};<br>
<br>
//&#32;Простейший&#32;поисковик&#32;Python-символов.<br>
//&#32;Умеет:<br>
//&#32;&#32;&#32;*&#32;находить&#32;определение&#32;класса&#32;(class&#32;Foo:)<br>
//&#32;&#32;&#32;*&#32;искать&#32;методы&#32;внутри&#32;класса&#32;(def&#32;bar(self,&#32;...))<br>
class&#32;PythonSymbolFinder<br>
{<br>
public:<br>
&#32;&#32;&#32;&#32;explicit&#32;PythonSymbolFinder(const&#32;std::string&#32;&amp;text);<br>
<br>
&#32;&#32;&#32;&#32;const&#32;std::vector&lt;std::string&gt;&#32;&amp;lines()&#32;const<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return&#32;m_lines;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;//&#32;Находит&#32;определение&#32;класса&#32;(первое&#32;вхождение&#32;с&#32;таким&#32;именем).<br>
&#32;&#32;&#32;&#32;//&#32;Region&#32;покрывает&#32;строку&#32;'class&#32;...'&#32;и&#32;всё&#32;тело&#32;класса&#32;до&#32;dedent.<br>
&#32;&#32;&#32;&#32;bool&#32;find_class(const&#32;std::string&#32;&amp;class_name,&#32;Region&#32;&amp;out)&#32;const;<br>
<br>
&#32;&#32;&#32;&#32;//&#32;Находит&#32;метод&#32;внутри&#32;класса.<br>
&#32;&#32;&#32;&#32;//&#32;Ищет&#32;def&#32;/&#32;async&#32;def&#32;с&#32;именем&#32;method_name,<br>
&#32;&#32;&#32;&#32;//&#32;являющийся&#32;&quot;первым&#32;уровнем&quot;&#32;внутри&#32;тела&#32;class_name.<br>
&#32;&#32;&#32;&#32;//&#32;Region&#32;покрывает&#32;строку&#32;def&#32;(включая&#32;декораторы&#32;над&#32;ней)&#32;и&#32;всё&#32;тело&#32;до<br>
&#32;&#32;&#32;&#32;//&#32;dedent.<br>
&#32;&#32;&#32;&#32;bool&#32;find_method(const&#32;std::string&#32;&amp;class_name,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;const&#32;std::string&#32;&amp;method_name,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;Region&#32;&amp;out)&#32;const;<br>
<br>
private:<br>
&#32;&#32;&#32;&#32;std::vector&lt;std::string&gt;&#32;m_lines;<br>
<br>
&#32;&#32;&#32;&#32;static&#32;int&#32;calc_indent(const&#32;std::string&#32;&amp;line);<br>
&#32;&#32;&#32;&#32;static&#32;std::size_t&#32;first_code_pos(const&#32;std::string&#32;&amp;line);<br>
<br>
&#32;&#32;&#32;&#32;bool&#32;find_class_internal(const&#32;std::string&#32;&amp;class_name,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;Region&#32;&amp;out,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;int&#32;&amp;class_indent)&#32;const;<br>
};<br>
<!-- END SCAT CODE -->
</body>
</html>
