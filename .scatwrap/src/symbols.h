<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>src/symbols.h</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
#pragma &#20;once<br>
<br>
#include &#20;&lt;cstddef&gt;<br>
#include &#20;&lt;string&gt;<br>
#include &#20;&lt;vector&gt;<br>
<br>
// &#20;Диапазон &#20;строк &#20;в &#20;файле &#20;(0-based, &#20;включительно).<br>
struct &#20;Region<br>
{<br>
 &#20; &#20; &#20; &#20;int &#20;start_line &#20;= &#20;-1; &#20;// &#20;inclusive<br>
 &#20; &#20; &#20; &#20;int &#20;end_line &#20;= &#20;-1; &#20; &#20; &#20;// &#20;inclusive<br>
};<br>
<br>
// &#20;Простейший &#20;поисковик &#20;C++-символов.<br>
// &#20;Умеет:<br>
// &#20; &#20; &#20;* &#20;находить &#20;определение &#20;класса &#20;(class &#20;/ &#20;struct)<br>
// &#20; &#20; &#20;* &#20;искать &#20;методы &#20;внутри &#20;класса &#20;(по &#20;имени)<br>
class &#20;CppSymbolFinder<br>
{<br>
public:<br>
 &#20; &#20; &#20; &#20;// &#20;text &#20;— &#20;полный &#20;текст &#20;файла.<br>
 &#20; &#20; &#20; &#20;explicit &#20;CppSymbolFinder(const &#20;std::string &#20;&amp;text);<br>
<br>
 &#20; &#20; &#20; &#20;const &#20;std::vector&lt;std::string&gt; &#20;&amp;lines() &#20;const<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return &#20;m_lines;<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;// &#20;Находит &#20;определение &#20;класса &#20;(НЕ &#20;forward-declaration).<br>
 &#20; &#20; &#20; &#20;// &#20;Возвращает &#20;true, &#20;если &#20;класс &#20;найден.<br>
 &#20; &#20; &#20; &#20;bool &#20;find_class(const &#20;std::string &#20;&amp;class_name, &#20;Region &#20;&amp;out) &#20;const;<br>
<br>
 &#20; &#20; &#20; &#20;// &#20;Находит &#20;метод &#20;внутри &#20;класса &#20;(по &#20;имени).<br>
 &#20; &#20; &#20; &#20;// &#20;Ищет &#20;только &#20;внутри &#20;тела &#20;class/struct &#20;class_name.<br>
 &#20; &#20; &#20; &#20;// &#20;Возвращает &#20;диапазон &#20;строк &#20;от &#20;начала &#20;объявления/определения<br>
 &#20; &#20; &#20; &#20;// &#20;до &#20;';' &#20;или &#20;закрывающей &#20;'}'.<br>
 &#20; &#20; &#20; &#20;bool &#20;find_method(const &#20;std::string &#20;&amp;class_name,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;const &#20;std::string &#20;&amp;method_name,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;Region &#20;&amp;out) &#20;const;<br>
<br>
private:<br>
 &#20; &#20; &#20; &#20;struct &#20;Token<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;enum &#20;Kind<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;Identifier,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;Keyword,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;Symbol<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;} &#20;kind;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::string &#20;text;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;int &#20;line &#20;= &#20;0; &#20;// &#20;0-based<br>
 &#20; &#20; &#20; &#20;};<br>
<br>
 &#20; &#20; &#20; &#20;struct &#20;ClassRange<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;Region &#20;region;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::size_t &#20;body_start_token &#20;= &#20;0; &#20;// &#20;индекс &#20;'{'<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::size_t &#20;body_end_token &#20;= &#20;0; &#20; &#20; &#20;// &#20;индекс &#20;'}' &#20;(или &#20;'};')<br>
 &#20; &#20; &#20; &#20;};<br>
<br>
 &#20; &#20; &#20; &#20;std::vector&lt;std::string&gt; &#20;m_lines;<br>
 &#20; &#20; &#20; &#20;std::vector&lt;Token&gt; &#20;m_tokens;<br>
<br>
 &#20; &#20; &#20; &#20;void &#20;tokenize(const &#20;std::string &#20;&amp;text);<br>
<br>
 &#20; &#20; &#20; &#20;static &#20;bool &#20;is_ident_start(char &#20;c);<br>
 &#20; &#20; &#20; &#20;static &#20;bool &#20;is_ident_char(char &#20;c);<br>
<br>
 &#20; &#20; &#20; &#20;bool &#20;find_class_internal(const &#20;std::string &#20;&amp;class_name,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;ClassRange &#20;&amp;out) &#20;const;<br>
};<br>
<br>
// &#20;Простейший &#20;поисковик &#20;Python-символов.<br>
// &#20;Умеет:<br>
// &#20; &#20; &#20;* &#20;находить &#20;определение &#20;класса &#20;(class &#20;Foo:)<br>
// &#20; &#20; &#20;* &#20;искать &#20;методы &#20;внутри &#20;класса &#20;(def &#20;bar(self, &#20;...))<br>
class &#20;PythonSymbolFinder<br>
{<br>
public:<br>
 &#20; &#20; &#20; &#20;explicit &#20;PythonSymbolFinder(const &#20;std::string &#20;&amp;text);<br>
<br>
 &#20; &#20; &#20; &#20;const &#20;std::vector&lt;std::string&gt; &#20;&amp;lines() &#20;const<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return &#20;m_lines;<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;// &#20;Находит &#20;определение &#20;класса &#20;(первое &#20;вхождение &#20;с &#20;таким &#20;именем).<br>
 &#20; &#20; &#20; &#20;// &#20;Region &#20;покрывает &#20;строку &#20;'class &#20;...' &#20;и &#20;всё &#20;тело &#20;класса &#20;до &#20;dedent.<br>
 &#20; &#20; &#20; &#20;bool &#20;find_class(const &#20;std::string &#20;&amp;class_name, &#20;Region &#20;&amp;out) &#20;const;<br>
<br>
 &#20; &#20; &#20; &#20;// &#20;Находит &#20;метод &#20;внутри &#20;класса.<br>
 &#20; &#20; &#20; &#20;// &#20;Ищет &#20;def &#20;/ &#20;async &#20;def &#20;с &#20;именем &#20;method_name,<br>
 &#20; &#20; &#20; &#20;// &#20;являющийся &#20;&quot;первым &#20;уровнем&quot; &#20;внутри &#20;тела &#20;class_name.<br>
 &#20; &#20; &#20; &#20;// &#20;Region &#20;покрывает &#20;строку &#20;def &#20;(включая &#20;декораторы &#20;над &#20;ней) &#20;и &#20;всё &#20;тело &#20;до<br>
 &#20; &#20; &#20; &#20;// &#20;dedent.<br>
 &#20; &#20; &#20; &#20;bool &#20;find_method(const &#20;std::string &#20;&amp;class_name,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;const &#20;std::string &#20;&amp;method_name,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;Region &#20;&amp;out) &#20;const;<br>
<br>
private:<br>
 &#20; &#20; &#20; &#20;std::vector&lt;std::string&gt; &#20;m_lines;<br>
<br>
 &#20; &#20; &#20; &#20;static &#20;int &#20;calc_indent(const &#20;std::string &#20;&amp;line);<br>
 &#20; &#20; &#20; &#20;static &#20;std::size_t &#20;first_code_pos(const &#20;std::string &#20;&amp;line);<br>
<br>
 &#20; &#20; &#20; &#20;bool &#20;find_class_internal(const &#20;std::string &#20;&amp;class_name,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;Region &#20;&amp;out,<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;int &#20;&amp;class_indent) &#20;const;<br>
};<br>
<!-- END SCAT CODE -->
</body>
</html>
