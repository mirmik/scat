<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>tests/apply_symbols.cpp</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
#include&#32;&quot;doctest/doctest.h&quot;<br>
#include&#32;&lt;filesystem&gt;<br>
#include&#32;&lt;fstream&gt;<br>
#include&#32;&lt;string&gt;<br>
#include&#32;&lt;vector&gt;<br>
<br>
int&#32;apply_chunk_main(int&#32;argc,&#32;char&#32;**argv);<br>
<br>
namespace&#32;fs&#32;=&#32;std::filesystem;<br>
<br>
static&#32;std::vector&lt;std::string&gt;&#32;read_lines(const&#32;fs::path&#32;&amp;p)<br>
{<br>
&#32;&#32;&#32;&#32;std::ifstream&#32;in(p);<br>
&#32;&#32;&#32;&#32;std::vector&lt;std::string&gt;&#32;v;<br>
&#32;&#32;&#32;&#32;std::string&#32;s;<br>
&#32;&#32;&#32;&#32;while&#32;(std::getline(in,&#32;s))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;v.push_back(s);<br>
&#32;&#32;&#32;&#32;return&#32;v;<br>
}<br>
<br>
static&#32;int&#32;run_apply(const&#32;fs::path&#32;&amp;patch)<br>
{<br>
&#32;&#32;&#32;&#32;std::string&#32;a0&#32;=&#32;&quot;apply&quot;;<br>
&#32;&#32;&#32;&#32;std::string&#32;a1&#32;=&#32;patch.string();<br>
<br>
&#32;&#32;&#32;&#32;std::vector&lt;std::string&gt;&#32;store&#32;=&#32;{a0,&#32;a1};<br>
&#32;&#32;&#32;&#32;std::vector&lt;char&#32;*&gt;&#32;argv;<br>
&#32;&#32;&#32;&#32;argv.reserve(store.size());<br>
&#32;&#32;&#32;&#32;for&#32;(auto&#32;&amp;s&#32;:&#32;store)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;argv.push_back(s.data());<br>
<br>
&#32;&#32;&#32;&#32;return&#32;apply_chunk_main((int)argv.size(),&#32;argv.data());<br>
}<br>
<br>
//&#32;============================================================================<br>
//&#32;C++:&#32;replace-cpp-class<br>
//&#32;============================================================================<br>
TEST_CASE(&quot;symbol&#32;API:&#32;replace-cpp-class&#32;replaces&#32;only&#32;target&#32;class&quot;)<br>
{<br>
&#32;&#32;&#32;&#32;fs::path&#32;tmp&#32;=&#32;fs::temp_directory_path()&#32;/&#32;&quot;symbol_cpp_class&quot;;<br>
&#32;&#32;&#32;&#32;fs::remove_all(tmp);<br>
&#32;&#32;&#32;&#32;fs::create_directories(tmp);<br>
<br>
&#32;&#32;&#32;&#32;fs::path&#32;f&#32;=&#32;tmp&#32;/&#32;&quot;foo.cpp&quot;;<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::ofstream&#32;out(f);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out&#32;&lt;&lt;&#32;&quot;#include&#32;&lt;string&gt;\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;class&#32;Foo&#32;{\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;public:\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;&#32;&#32;&#32;&#32;int&#32;x()&#32;const;\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;};\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;class&#32;Bar&#32;{\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;public:\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;&#32;&#32;&#32;&#32;void&#32;ping();\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;};\n&quot;;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;fs::path&#32;patch&#32;=&#32;tmp&#32;/&#32;&quot;patch_class.txt&quot;;<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::ofstream&#32;out(patch);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out&#32;&lt;&lt;&#32;&quot;===&#32;file:&#32;&quot;&#32;&lt;&lt;&#32;f.string()<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&lt;&lt;&#32;&quot;&#32;===\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;---&#32;replace-cpp-class&#32;Foo\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;class&#32;Foo&#32;{\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;public:\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;&#32;&#32;&#32;&#32;int&#32;y()&#32;const&#32;{&#32;return&#32;42;&#32;}\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;};\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;=END=\n&quot;;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;CHECK(run_apply(patch)&#32;==&#32;0);<br>
<br>
&#32;&#32;&#32;&#32;auto&#32;L&#32;=&#32;read_lines(f);<br>
&#32;&#32;&#32;&#32;REQUIRE(L.size()&#32;&gt;=&#32;8);<br>
<br>
&#32;&#32;&#32;&#32;CHECK(L[0]&#32;==&#32;&quot;#include&#32;&lt;string&gt;&quot;);<br>
&#32;&#32;&#32;&#32;CHECK(L[1]&#32;==&#32;&quot;&quot;);<br>
&#32;&#32;&#32;&#32;CHECK(L[2]&#32;==&#32;&quot;class&#32;Foo&#32;{&quot;);<br>
&#32;&#32;&#32;&#32;CHECK(L[3]&#32;==&#32;&quot;public:&quot;);<br>
&#32;&#32;&#32;&#32;CHECK(L[4]&#32;==&#32;&quot;&#32;&#32;&#32;&#32;int&#32;y()&#32;const&#32;{&#32;return&#32;42;&#32;}&quot;);<br>
&#32;&#32;&#32;&#32;CHECK(L[5]&#32;==&#32;&quot;};&quot;);<br>
&#32;&#32;&#32;&#32;CHECK(L[6]&#32;==&#32;&quot;&quot;);<br>
&#32;&#32;&#32;&#32;CHECK(L[7]&#32;==&#32;&quot;class&#32;Bar&#32;{&quot;);<br>
}<br>
<br>
//&#32;============================================================================<br>
//&#32;C++:&#32;replace-cpp-method<br>
//&#32;============================================================================<br>
TEST_CASE(&quot;symbol&#32;API:&#32;replace-cpp-method&#32;by&#32;separate&#32;class&#32;and&#32;method&#32;name&quot;)<br>
{<br>
&#32;&#32;&#32;&#32;fs::path&#32;tmp&#32;=&#32;fs::temp_directory_path()&#32;/&#32;&quot;symbol_cpp_method_1&quot;;<br>
&#32;&#32;&#32;&#32;fs::remove_all(tmp);<br>
&#32;&#32;&#32;&#32;fs::create_directories(tmp);<br>
<br>
&#32;&#32;&#32;&#32;fs::path&#32;f&#32;=&#32;tmp&#32;/&#32;&quot;foo.cpp&quot;;<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::ofstream&#32;out(f);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out&#32;&lt;&lt;&#32;&quot;class&#32;Foo&#32;{\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;public:\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;&#32;&#32;&#32;&#32;void&#32;a();\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;&#32;&#32;&#32;&#32;int&#32;value()&#32;const;\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;};\n&quot;;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;fs::path&#32;patch&#32;=&#32;tmp&#32;/&#32;&quot;patch_method1.txt&quot;;<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::ofstream&#32;out(patch);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out&#32;&lt;&lt;&#32;&quot;===&#32;file:&#32;&quot;&#32;&lt;&lt;&#32;f.string()<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&lt;&lt;&#32;&quot;&#32;===\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;---&#32;replace-cpp-method&#32;Foo&#32;value\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;&#32;&#32;&#32;&#32;int&#32;value()&#32;const&#32;{&#32;return&#32;10;&#32;}\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;=END=\n&quot;;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;CHECK(run_apply(patch)&#32;==&#32;0);<br>
<br>
&#32;&#32;&#32;&#32;auto&#32;L&#32;=&#32;read_lines(f);<br>
&#32;&#32;&#32;&#32;REQUIRE(L.size()&#32;==&#32;5);<br>
&#32;&#32;&#32;&#32;CHECK(L[0]&#32;==&#32;&quot;class&#32;Foo&#32;{&quot;);<br>
&#32;&#32;&#32;&#32;CHECK(L[1]&#32;==&#32;&quot;public:&quot;);<br>
&#32;&#32;&#32;&#32;CHECK(L[2]&#32;==&#32;&quot;&#32;&#32;&#32;&#32;void&#32;a();&quot;);<br>
&#32;&#32;&#32;&#32;CHECK(L[3]&#32;==&#32;&quot;&#32;&#32;&#32;&#32;int&#32;value()&#32;const&#32;{&#32;return&#32;10;&#32;}&quot;);<br>
&#32;&#32;&#32;&#32;CHECK(L[4]&#32;==&#32;&quot;};&quot;);<br>
}<br>
<br>
TEST_CASE(&quot;symbol&#32;API:&#32;replace-cpp-method&#32;with&#32;Class::method&#32;syntax&quot;)<br>
{<br>
&#32;&#32;&#32;&#32;fs::path&#32;tmp&#32;=&#32;fs::temp_directory_path()&#32;/&#32;&quot;symbol_cpp_method_2&quot;;<br>
&#32;&#32;&#32;&#32;fs::remove_all(tmp);<br>
&#32;&#32;&#32;&#32;fs::create_directories(tmp);<br>
<br>
&#32;&#32;&#32;&#32;fs::path&#32;f&#32;=&#32;tmp&#32;/&#32;&quot;bar.cpp&quot;;<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::ofstream&#32;out(f);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out&#32;&lt;&lt;&#32;&quot;class&#32;Bar&#32;{\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;public:\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;&#32;&#32;&#32;&#32;int&#32;calc(int&#32;x)&#32;const;\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;&#32;&#32;&#32;&#32;int&#32;other()&#32;const;\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;};\n&quot;;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;fs::path&#32;patch&#32;=&#32;tmp&#32;/&#32;&quot;patch_method2.txt&quot;;<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::ofstream&#32;out(patch);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out&#32;&lt;&lt;&#32;&quot;===&#32;file:&#32;&quot;&#32;&lt;&lt;&#32;f.string()<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&lt;&lt;&#32;&quot;&#32;===\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;---&#32;replace-cpp-method&#32;Bar::calc\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;&#32;&#32;&#32;&#32;int&#32;calc(int&#32;x)&#32;const&#32;{&#32;return&#32;x&#32;*&#32;2;&#32;}\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;=END=\n&quot;;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;CHECK(run_apply(patch)&#32;==&#32;0);<br>
<br>
&#32;&#32;&#32;&#32;auto&#32;L&#32;=&#32;read_lines(f);<br>
&#32;&#32;&#32;&#32;REQUIRE(L.size()&#32;==&#32;5);<br>
&#32;&#32;&#32;&#32;CHECK(L[2]&#32;==&#32;&quot;&#32;&#32;&#32;&#32;int&#32;calc(int&#32;x)&#32;const&#32;{&#32;return&#32;x&#32;*&#32;2;&#32;}&quot;);<br>
&#32;&#32;&#32;&#32;CHECK(L[3]&#32;==&#32;&quot;&#32;&#32;&#32;&#32;int&#32;other()&#32;const;&quot;);<br>
}<br>
<br>
//&#32;============================================================================<br>
//&#32;Python:&#32;replace-py-class<br>
//&#32;============================================================================<br>
TEST_CASE(&quot;symbol&#32;API:&#32;replace-py-class&#32;replaces&#32;whole&#32;class&#32;body&quot;)<br>
{<br>
&#32;&#32;&#32;&#32;fs::path&#32;tmp&#32;=&#32;fs::temp_directory_path()&#32;/&#32;&quot;symbol_py_class&quot;;<br>
&#32;&#32;&#32;&#32;fs::remove_all(tmp);<br>
&#32;&#32;&#32;&#32;fs::create_directories(tmp);<br>
<br>
&#32;&#32;&#32;&#32;fs::path&#32;f&#32;=&#32;tmp&#32;/&#32;&quot;foo.py&quot;;<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::ofstream&#32;out(f);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out&#32;&lt;&lt;&#32;&quot;class&#32;Foo:\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;&#32;&#32;&#32;&#32;def&#32;__init__(self):\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;self.x&#32;=&#32;1\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;class&#32;Bar:\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;&#32;&#32;&#32;&#32;pass\n&quot;;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;fs::path&#32;patch&#32;=&#32;tmp&#32;/&#32;&quot;patch_py_class.txt&quot;;<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::ofstream&#32;out(patch);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out&#32;&lt;&lt;&#32;&quot;===&#32;file:&#32;&quot;&#32;&lt;&lt;&#32;f.string()<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&lt;&lt;&#32;&quot;&#32;===\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;---&#32;replace-py-class&#32;Foo\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;class&#32;Foo:\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;&#32;&#32;&#32;&#32;def&#32;__init__(self):\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;self.x&#32;=&#32;2\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;&#32;&#32;&#32;&#32;def&#32;answer(self):\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return&#32;42\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;=END=\n&quot;;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;CHECK(run_apply(patch)&#32;==&#32;0);<br>
<br>
&#32;&#32;&#32;&#32;auto&#32;L&#32;=&#32;read_lines(f);<br>
&#32;&#32;&#32;&#32;REQUIRE(L.size()&#32;&gt;=&#32;5);<br>
<br>
&#32;&#32;&#32;&#32;//&#32;Проверяем,&#32;что&#32;новый&#32;класс&#32;Foo&#32;на&#32;месте<br>
&#32;&#32;&#32;&#32;CHECK(L[0]&#32;==&#32;&quot;class&#32;Foo:&quot;);<br>
<br>
&#32;&#32;&#32;&#32;bool&#32;found_init&#32;=&#32;false;<br>
&#32;&#32;&#32;&#32;bool&#32;found_x2&#32;=&#32;false;<br>
&#32;&#32;&#32;&#32;bool&#32;found_answer&#32;=&#32;false;<br>
&#32;&#32;&#32;&#32;bool&#32;found_ret42&#32;=&#32;false;<br>
&#32;&#32;&#32;&#32;bool&#32;found_bar&#32;=&#32;false;<br>
<br>
&#32;&#32;&#32;&#32;for&#32;(const&#32;auto&#32;&amp;line&#32;:&#32;L)<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(line.find(&quot;def&#32;__init__&quot;)&#32;!=&#32;std::string::npos)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;found_init&#32;=&#32;true;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(line.find(&quot;self.x&#32;=&#32;2&quot;)&#32;!=&#32;std::string::npos)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;found_x2&#32;=&#32;true;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(line.find(&quot;def&#32;answer&quot;)&#32;!=&#32;std::string::npos)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;found_answer&#32;=&#32;true;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(line.find(&quot;return&#32;42&quot;)&#32;!=&#32;std::string::npos)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;found_ret42&#32;=&#32;true;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(line&#32;==&#32;&quot;class&#32;Bar:&quot;)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;found_bar&#32;=&#32;true;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;CHECK(found_init);<br>
&#32;&#32;&#32;&#32;CHECK(found_x2);<br>
&#32;&#32;&#32;&#32;CHECK(found_answer);<br>
&#32;&#32;&#32;&#32;CHECK(found_ret42);<br>
&#32;&#32;&#32;&#32;CHECK(found_bar);<br>
}<br>
<br>
//&#32;============================================================================<br>
//&#32;Python:&#32;replace-py-method<br>
//&#32;============================================================================<br>
TEST_CASE(&quot;symbol&#32;API:&#32;replace-py-method&#32;with&#32;separate&#32;class&#32;and&#32;method&#32;name&quot;)<br>
{<br>
&#32;&#32;&#32;&#32;fs::path&#32;tmp&#32;=&#32;fs::temp_directory_path()&#32;/&#32;&quot;symbol_py_method_1&quot;;<br>
&#32;&#32;&#32;&#32;fs::remove_all(tmp);<br>
&#32;&#32;&#32;&#32;fs::create_directories(tmp);<br>
<br>
&#32;&#32;&#32;&#32;fs::path&#32;f&#32;=&#32;tmp&#32;/&#32;&quot;weird.py&quot;;<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::ofstream&#32;out(f);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out&#32;&lt;&lt;&#32;&quot;class&#32;Weird:\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;&#32;&#32;&#32;&#32;def&#32;run(self):\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return&#32;1\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;&#32;&#32;&#32;&#32;def&#32;other(self):\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return&#32;2\n&quot;;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;fs::path&#32;patch&#32;=&#32;tmp&#32;/&#32;&quot;patch_py_method1.txt&quot;;<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::ofstream&#32;out(patch);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out&#32;&lt;&lt;&#32;&quot;===&#32;file:&#32;&quot;&#32;&lt;&lt;&#32;f.string()<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&lt;&lt;&#32;&quot;&#32;===\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;---&#32;replace-py-method&#32;Weird&#32;run\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;&#32;&#32;&#32;&#32;def&#32;run(self):\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return&#32;100\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;=END=\n&quot;;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;CHECK(run_apply(patch)&#32;==&#32;0);<br>
<br>
&#32;&#32;&#32;&#32;auto&#32;L&#32;=&#32;read_lines(f);<br>
&#32;&#32;&#32;&#32;REQUIRE(L.size()&#32;&gt;=&#32;5);<br>
<br>
&#32;&#32;&#32;&#32;bool&#32;found_run_100&#32;=&#32;false;<br>
&#32;&#32;&#32;&#32;bool&#32;found_other_2&#32;=&#32;false;<br>
&#32;&#32;&#32;&#32;bool&#32;seen_def_run&#32;=&#32;false;<br>
&#32;&#32;&#32;&#32;bool&#32;seen_return_100&#32;=&#32;false;<br>
<br>
&#32;&#32;&#32;&#32;for&#32;(const&#32;auto&#32;&amp;line&#32;:&#32;L)<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(line.find(&quot;def&#32;run&quot;)&#32;!=&#32;std::string::npos)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;seen_def_run&#32;=&#32;true;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(line.find(&quot;return&#32;100&quot;)&#32;!=&#32;std::string::npos)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;seen_return_100&#32;=&#32;true;<br>
<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(line.find(&quot;def&#32;other&quot;)&#32;!=&#32;std::string::npos&#32;||<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;line.find(&quot;return&#32;2&quot;)&#32;!=&#32;std::string::npos)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;Очень&#32;грубо:&#32;убеждаемся,&#32;что&#32;следы&#32;second&#32;метода&#32;остались<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;found_other_2&#32;=&#32;true;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;found_run_100&#32;=&#32;seen_def_run&#32;&amp;&amp;&#32;seen_return_100;<br>
<br>
&#32;&#32;&#32;&#32;CHECK(found_run_100);<br>
&#32;&#32;&#32;&#32;CHECK(found_other_2);<br>
}<br>
<br>
TEST_CASE(&quot;symbol&#32;API:&#32;replace-py-method&#32;with&#32;Class.method&#32;syntax&quot;)<br>
{<br>
&#32;&#32;&#32;&#32;fs::path&#32;tmp&#32;=&#32;fs::temp_directory_path()&#32;/&#32;&quot;symbol_py_method_2&quot;;<br>
&#32;&#32;&#32;&#32;fs::remove_all(tmp);<br>
&#32;&#32;&#32;&#32;fs::create_directories(tmp);<br>
<br>
&#32;&#32;&#32;&#32;fs::path&#32;f&#32;=&#32;tmp&#32;/&#32;&quot;async_foo.py&quot;;<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::ofstream&#32;out(f);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out&#32;&lt;&lt;&#32;&quot;class&#32;Foo:\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;&#32;&#32;&#32;&#32;async&#32;def&#32;bar(self):\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return&#32;1\n&quot;;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;fs::path&#32;patch&#32;=&#32;tmp&#32;/&#32;&quot;patch_py_method2.txt&quot;;<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::ofstream&#32;out(patch);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out&#32;&lt;&lt;&#32;&quot;===&#32;file:&#32;&quot;&#32;&lt;&lt;&#32;f.string()<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&lt;&lt;&#32;&quot;&#32;===\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;---&#32;replace-py-method&#32;Foo.bar\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;&#32;&#32;&#32;&#32;async&#32;def&#32;bar(self):\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;return&#32;2\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;=END=\n&quot;;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;CHECK(run_apply(patch)&#32;==&#32;0);<br>
<br>
&#32;&#32;&#32;&#32;auto&#32;L&#32;=&#32;read_lines(f);<br>
&#32;&#32;&#32;&#32;REQUIRE(L.size()&#32;&gt;=&#32;2);<br>
<br>
&#32;&#32;&#32;&#32;CHECK(L[0]&#32;==&#32;&quot;class&#32;Foo:&quot;);<br>
<br>
&#32;&#32;&#32;&#32;bool&#32;found_bar_2&#32;=&#32;false;<br>
&#32;&#32;&#32;&#32;for&#32;(const&#32;auto&#32;&amp;line&#32;:&#32;L)<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(line.find(&quot;async&#32;def&#32;bar&quot;)&#32;!=&#32;std::string::npos)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;found_bar_2&#32;=&#32;true;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;if&#32;(line.find(&quot;return&#32;2&quot;)&#32;!=&#32;std::string::npos)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;found_bar_2&#32;=&#32;true;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;CHECK(found_bar_2);<br>
}<br>
<!-- END SCAT CODE -->
</body>
</html>
