<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>tests/apply.cpp</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
#include&#32;&quot;doctest/doctest.h&quot;<br>
#include&#32;&lt;filesystem&gt;<br>
#include&#32;&lt;fstream&gt;<br>
#include&#32;&lt;iostream&gt;<br>
#include&#32;&lt;scat.h&gt;<br>
#include&#32;&lt;sstream&gt;<br>
#include&#32;&lt;string&gt;<br>
#include&#32;&lt;vector&gt;<br>
<br>
int&#32;apply_chunk_main(int&#32;argc,&#32;char&#32;**argv);<br>
<br>
namespace&#32;fs&#32;=&#32;std::filesystem;<br>
<br>
std::vector&lt;std::string&gt;&#32;read_lines(const&#32;fs::path&#32;&amp;p)<br>
{<br>
&#32;&#32;&#32;&#32;std::ifstream&#32;in(p);<br>
&#32;&#32;&#32;&#32;std::vector&lt;std::string&gt;&#32;v;<br>
&#32;&#32;&#32;&#32;std::string&#32;s;<br>
&#32;&#32;&#32;&#32;while&#32;(std::getline(in,&#32;s))<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;v.push_back(s);<br>
&#32;&#32;&#32;&#32;return&#32;v;<br>
}<br>
<br>
int&#32;run_apply(const&#32;fs::path&#32;&amp;patch)<br>
{<br>
&#32;&#32;&#32;&#32;std::string&#32;arg0&#32;=&#32;&quot;apply&quot;;<br>
&#32;&#32;&#32;&#32;std::string&#32;arg1&#32;=&#32;patch.string();<br>
<br>
&#32;&#32;&#32;&#32;//&#32;храним&#32;строки&#32;в&#32;живом&#32;виде<br>
&#32;&#32;&#32;&#32;std::vector&lt;std::string&gt;&#32;args&#32;=&#32;{arg0,&#32;arg1};<br>
<br>
&#32;&#32;&#32;&#32;//&#32;формируем&#32;argv&#32;как&#32;указатели&#32;НА&#32;ЖИВЫЕ&#32;строки<br>
&#32;&#32;&#32;&#32;std::vector&lt;char&#32;*&gt;&#32;argv_real;<br>
&#32;&#32;&#32;&#32;argv_real.reserve(args.size());<br>
&#32;&#32;&#32;&#32;for&#32;(auto&#32;&amp;s&#32;:&#32;args)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;argv_real.push_back(s.data());<br>
<br>
&#32;&#32;&#32;&#32;return&#32;apply_chunk_main((int)argv_real.size(),&#32;argv_real.data());<br>
}<br>
<br>
TEST_CASE(&quot;apply_chunk_main:&#32;insert-after-text&quot;)<br>
{<br>
&#32;&#32;&#32;&#32;fs::path&#32;tmp&#32;=&#32;fs::temp_directory_path()&#32;/&#32;&quot;chunk_test_insert_after_text&quot;;<br>
&#32;&#32;&#32;&#32;fs::remove_all(tmp);<br>
&#32;&#32;&#32;&#32;fs::create_directories(tmp);<br>
<br>
&#32;&#32;&#32;&#32;fs::path&#32;f&#32;=&#32;tmp&#32;/&#32;&quot;a.txt&quot;;<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::ofstream&#32;out(f);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out&#32;&lt;&lt;&#32;&quot;LINE1\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;LINE2\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;LINE3\n&quot;;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;fs::path&#32;patch&#32;=&#32;tmp&#32;/&#32;&quot;patch.txt&quot;;<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::ofstream&#32;out(patch);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out&#32;&lt;&lt;&#32;&quot;===&#32;file:&#32;&quot;&#32;&lt;&lt;&#32;f.string()<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&lt;&lt;&#32;&quot;&#32;===\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;---&#32;insert-after-text\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;LINE2\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;---\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;AFTER\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;TEXT\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;=END=\n&quot;;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;int&#32;r&#32;=&#32;run_apply(patch);<br>
&#32;&#32;&#32;&#32;CHECK(r&#32;==&#32;0);<br>
<br>
&#32;&#32;&#32;&#32;auto&#32;lines&#32;=&#32;read_lines(f);<br>
&#32;&#32;&#32;&#32;REQUIRE(lines.size()&#32;==&#32;5);<br>
&#32;&#32;&#32;&#32;CHECK(lines[0]&#32;==&#32;&quot;LINE1&quot;);<br>
&#32;&#32;&#32;&#32;CHECK(lines[1]&#32;==&#32;&quot;LINE2&quot;);<br>
&#32;&#32;&#32;&#32;CHECK(lines[2]&#32;==&#32;&quot;AFTER&quot;);<br>
&#32;&#32;&#32;&#32;CHECK(lines[3]&#32;==&#32;&quot;TEXT&quot;);<br>
&#32;&#32;&#32;&#32;CHECK(lines[4]&#32;==&#32;&quot;LINE3&quot;);<br>
}<br>
<br>
TEST_CASE(&quot;apply_chunk_main:&#32;insert-before-text&quot;)<br>
{<br>
&#32;&#32;&#32;&#32;fs::path&#32;tmp&#32;=&#32;fs::temp_directory_path()&#32;/&#32;&quot;chunk_test_insert_before_text&quot;;<br>
&#32;&#32;&#32;&#32;fs::remove_all(tmp);<br>
&#32;&#32;&#32;&#32;fs::create_directories(tmp);<br>
<br>
&#32;&#32;&#32;&#32;fs::path&#32;f&#32;=&#32;tmp&#32;/&#32;&quot;b.txt&quot;;<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::ofstream&#32;out(f);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out&#32;&lt;&lt;&#32;&quot;AAA\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;BBB\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;CCC\n&quot;;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;fs::path&#32;patch&#32;=&#32;tmp&#32;/&#32;&quot;patch.txt&quot;;<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::ofstream&#32;out(patch);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out&#32;&lt;&lt;&#32;&quot;===&#32;file:&#32;&quot;&#32;&lt;&lt;&#32;f.string()<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&lt;&lt;&#32;&quot;&#32;===\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;---&#32;insert-before-text\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;BBB\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;---\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;X\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;Y\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;=END=\n&quot;;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;int&#32;r&#32;=&#32;run_apply(patch);<br>
&#32;&#32;&#32;&#32;CHECK(r&#32;==&#32;0);<br>
<br>
&#32;&#32;&#32;&#32;auto&#32;lines&#32;=&#32;read_lines(f);<br>
&#32;&#32;&#32;&#32;REQUIRE(lines.size()&#32;==&#32;5);<br>
&#32;&#32;&#32;&#32;CHECK(lines[0]&#32;==&#32;&quot;AAA&quot;);<br>
&#32;&#32;&#32;&#32;CHECK(lines[1]&#32;==&#32;&quot;X&quot;);<br>
&#32;&#32;&#32;&#32;CHECK(lines[2]&#32;==&#32;&quot;Y&quot;);<br>
&#32;&#32;&#32;&#32;CHECK(lines[3]&#32;==&#32;&quot;BBB&quot;);<br>
&#32;&#32;&#32;&#32;CHECK(lines[4]&#32;==&#32;&quot;CCC&quot;);<br>
}<br>
<br>
TEST_CASE(&quot;apply_chunk_main:&#32;replace-text&quot;)<br>
{<br>
&#32;&#32;&#32;&#32;fs::path&#32;tmp&#32;=&#32;fs::temp_directory_path()&#32;/&#32;&quot;chunk_test_replace_text&quot;;<br>
&#32;&#32;&#32;&#32;fs::remove_all(tmp);<br>
&#32;&#32;&#32;&#32;fs::create_directories(tmp);<br>
<br>
&#32;&#32;&#32;&#32;fs::path&#32;f&#32;=&#32;tmp&#32;/&#32;&quot;c.txt&quot;;<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::ofstream&#32;out(f);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out&#32;&lt;&lt;&#32;&quot;alpha\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;beta\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;gamma\n&quot;;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;fs::path&#32;patch&#32;=&#32;tmp&#32;/&#32;&quot;patch.txt&quot;;<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::ofstream&#32;out(patch);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out&#32;&lt;&lt;&#32;&quot;===&#32;file:&#32;&quot;&#32;&lt;&lt;&#32;f.string()<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&lt;&lt;&#32;&quot;&#32;===\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;---&#32;replace-text\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;beta\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;---\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;BETA1\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;BETA2\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;=END=\n&quot;;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;int&#32;r&#32;=&#32;run_apply(patch);<br>
&#32;&#32;&#32;&#32;CHECK(r&#32;==&#32;0);<br>
<br>
&#32;&#32;&#32;&#32;auto&#32;lines&#32;=&#32;read_lines(f);<br>
&#32;&#32;&#32;&#32;REQUIRE(lines.size()&#32;==&#32;4);<br>
&#32;&#32;&#32;&#32;CHECK(lines[0]&#32;==&#32;&quot;alpha&quot;);<br>
&#32;&#32;&#32;&#32;CHECK(lines[1]&#32;==&#32;&quot;BETA1&quot;);<br>
&#32;&#32;&#32;&#32;CHECK(lines[2]&#32;==&#32;&quot;BETA2&quot;);<br>
&#32;&#32;&#32;&#32;CHECK(lines[3]&#32;==&#32;&quot;gamma&quot;);<br>
}<br>
<br>
TEST_CASE(&quot;apply_chunk_main:&#32;delete-text&quot;)<br>
{<br>
&#32;&#32;&#32;&#32;fs::path&#32;tmp&#32;=&#32;fs::temp_directory_path()&#32;/&#32;&quot;chunk_test_delete_text&quot;;<br>
&#32;&#32;&#32;&#32;fs::remove_all(tmp);<br>
&#32;&#32;&#32;&#32;fs::create_directories(tmp);<br>
<br>
&#32;&#32;&#32;&#32;fs::path&#32;f&#32;=&#32;tmp&#32;/&#32;&quot;d.txt&quot;;<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::ofstream&#32;out(f);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out&#32;&lt;&lt;&#32;&quot;one\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;two\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;three\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;four\n&quot;;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;fs::path&#32;patch&#32;=&#32;tmp&#32;/&#32;&quot;patch.txt&quot;;<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::ofstream&#32;out(patch);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out&#32;&lt;&lt;&#32;&quot;===&#32;file:&#32;&quot;&#32;&lt;&lt;&#32;f.string()<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&lt;&lt;&#32;&quot;&#32;===\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;---&#32;delete-text\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;two\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;three\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;---\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;=END=\n&quot;;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;int&#32;r&#32;=&#32;run_apply(patch);<br>
&#32;&#32;&#32;&#32;CHECK(r&#32;==&#32;0);<br>
<br>
&#32;&#32;&#32;&#32;auto&#32;lines&#32;=&#32;read_lines(f);<br>
&#32;&#32;&#32;&#32;REQUIRE(lines.size()&#32;==&#32;2);<br>
&#32;&#32;&#32;&#32;CHECK(lines[0]&#32;==&#32;&quot;one&quot;);<br>
&#32;&#32;&#32;&#32;CHECK(lines[1]&#32;==&#32;&quot;four&quot;);<br>
}<br>
<br>
TEST_CASE(&quot;apply_chunk_main:&#32;apply-stdin&quot;)<br>
{<br>
&#32;&#32;&#32;&#32;namespace&#32;fs&#32;=&#32;std::filesystem;<br>
<br>
&#32;&#32;&#32;&#32;fs::path&#32;tmp&#32;=&#32;fs::temp_directory_path()&#32;/&#32;&quot;chunk_test_stdin&quot;;<br>
&#32;&#32;&#32;&#32;fs::remove_all(tmp);<br>
&#32;&#32;&#32;&#32;fs::create_directories(tmp);<br>
<br>
&#32;&#32;&#32;&#32;fs::path&#32;f&#32;=&#32;tmp&#32;/&#32;&quot;stdin.txt&quot;;<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::ofstream&#32;out(f);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out&#32;&lt;&lt;&#32;&quot;A\nB\nC\n&quot;;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;std::string&#32;patch&#32;=&#32;&quot;===&#32;file:&#32;&quot;&#32;+&#32;f.string()&#32;+<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;&#32;===\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;---&#32;replace-text\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;B\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;---\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;XXX\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;=END=\n&quot;;<br>
<br>
&#32;&#32;&#32;&#32;std::istringstream&#32;fake_stdin(patch);<br>
&#32;&#32;&#32;&#32;auto&#32;*old_stdin&#32;=&#32;std::cin.rdbuf(fake_stdin.rdbuf());<br>
<br>
&#32;&#32;&#32;&#32;const&#32;char&#32;*argv[]&#32;=&#32;{&quot;scat&quot;,&#32;&quot;--apply-stdin&quot;};<br>
&#32;&#32;&#32;&#32;int&#32;r&#32;=&#32;scat_main(2,&#32;(char&#32;**)argv);<br>
<br>
&#32;&#32;&#32;&#32;std::cin.rdbuf(old_stdin);<br>
<br>
&#32;&#32;&#32;&#32;CHECK(r&#32;==&#32;0);<br>
<br>
&#32;&#32;&#32;&#32;auto&#32;lines&#32;=&#32;read_lines(f);<br>
&#32;&#32;&#32;&#32;REQUIRE(lines.size()&#32;==&#32;3);<br>
&#32;&#32;&#32;&#32;CHECK(lines[0]&#32;==&#32;&quot;A&quot;);<br>
&#32;&#32;&#32;&#32;CHECK(lines[1]&#32;==&#32;&quot;XXX&quot;);<br>
&#32;&#32;&#32;&#32;CHECK(lines[2]&#32;==&#32;&quot;C&quot;);<br>
}<br>
TEST_CASE(&quot;apply_chunk_main:&#32;delete-file&#32;then&#32;create-file&quot;)<br>
{<br>
&#32;&#32;&#32;&#32;namespace&#32;fs&#32;=&#32;std::filesystem;<br>
<br>
&#32;&#32;&#32;&#32;fs::path&#32;tmp&#32;=&#32;fs::temp_directory_path()&#32;/&#32;&quot;chunk_test_del_create&quot;;<br>
&#32;&#32;&#32;&#32;fs::remove_all(tmp);<br>
&#32;&#32;&#32;&#32;fs::create_directories(tmp);<br>
<br>
&#32;&#32;&#32;&#32;fs::path&#32;f&#32;=&#32;tmp&#32;/&#32;&quot;x.txt&quot;;<br>
<br>
&#32;&#32;&#32;&#32;//&#32;Исходный&#32;файл<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::ofstream&#32;out(f);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out&#32;&lt;&lt;&#32;&quot;OLD&quot;;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;//&#32;Патч:&#32;удалить&#32;→&#32;создать&#32;заново<br>
&#32;&#32;&#32;&#32;fs::path&#32;patch&#32;=&#32;tmp&#32;/&#32;&quot;patch.txt&quot;;<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::ofstream&#32;out(patch);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out&#32;&lt;&lt;&#32;&quot;===&#32;file:&#32;&quot;&#32;&lt;&lt;&#32;f.string()<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&lt;&lt;&#32;&quot;&#32;===\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;---&#32;delete-file\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;=END=\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;===&#32;file:&#32;&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&lt;&lt;&#32;f.string()<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&lt;&lt;&#32;&quot;&#32;===\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;---&#32;create-file\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;NEW1\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;NEW2\n&quot;<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;=END=\n&quot;;<br>
&#32;&#32;&#32;&#32;}<br>
<br>
&#32;&#32;&#32;&#32;int&#32;r&#32;=&#32;run_apply(patch);<br>
&#32;&#32;&#32;&#32;CHECK(r&#32;==&#32;0);<br>
<br>
&#32;&#32;&#32;&#32;REQUIRE(fs::exists(f));<br>
<br>
&#32;&#32;&#32;&#32;auto&#32;lines&#32;=&#32;read_lines(f);<br>
&#32;&#32;&#32;&#32;REQUIRE(lines.size()&#32;==&#32;2);<br>
&#32;&#32;&#32;&#32;CHECK(lines[0]&#32;==&#32;&quot;NEW1&quot;);<br>
&#32;&#32;&#32;&#32;CHECK(lines[1]&#32;==&#32;&quot;NEW2&quot;);<br>
}<br>
<!-- END SCAT CODE -->
</body>
</html>
