<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>tests/apply.cpp</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
#include &#20;&quot;doctest/doctest.h&quot;<br>
#include &#20;&lt;filesystem&gt;<br>
#include &#20;&lt;fstream&gt;<br>
#include &#20;&lt;iostream&gt;<br>
#include &#20;&lt;scat.h&gt;<br>
#include &#20;&lt;sstream&gt;<br>
#include &#20;&lt;string&gt;<br>
#include &#20;&lt;vector&gt;<br>
<br>
int &#20;apply_chunk_main(int &#20;argc, &#20;char &#20;**argv);<br>
<br>
namespace &#20;fs &#20;= &#20;std::filesystem;<br>
<br>
std::vector&lt;std::string&gt; &#20;read_lines(const &#20;fs::path &#20;&amp;p)<br>
{<br>
 &#20; &#20; &#20; &#20;std::ifstream &#20;in(p);<br>
 &#20; &#20; &#20; &#20;std::vector&lt;std::string&gt; &#20;v;<br>
 &#20; &#20; &#20; &#20;std::string &#20;s;<br>
 &#20; &#20; &#20; &#20;while &#20;(std::getline(in, &#20;s))<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;v.push_back(s);<br>
 &#20; &#20; &#20; &#20;return &#20;v;<br>
}<br>
<br>
int &#20;run_apply(const &#20;fs::path &#20;&amp;patch)<br>
{<br>
 &#20; &#20; &#20; &#20;std::string &#20;arg0 &#20;= &#20;&quot;apply&quot;;<br>
 &#20; &#20; &#20; &#20;std::string &#20;arg1 &#20;= &#20;patch.string();<br>
<br>
 &#20; &#20; &#20; &#20;// &#20;храним &#20;строки &#20;в &#20;живом &#20;виде<br>
 &#20; &#20; &#20; &#20;std::vector&lt;std::string&gt; &#20;args &#20;= &#20;{arg0, &#20;arg1};<br>
<br>
 &#20; &#20; &#20; &#20;// &#20;формируем &#20;argv &#20;как &#20;указатели &#20;НА &#20;ЖИВЫЕ &#20;строки<br>
 &#20; &#20; &#20; &#20;std::vector&lt;char &#20;*&gt; &#20;argv_real;<br>
 &#20; &#20; &#20; &#20;argv_real.reserve(args.size());<br>
 &#20; &#20; &#20; &#20;for &#20;(auto &#20;&amp;s &#20;: &#20;args)<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;argv_real.push_back(s.data());<br>
<br>
 &#20; &#20; &#20; &#20;return &#20;apply_chunk_main((int)argv_real.size(), &#20;argv_real.data());<br>
}<br>
<br>
TEST_CASE(&quot;apply_chunk_main: &#20;insert-after-text&quot;)<br>
{<br>
 &#20; &#20; &#20; &#20;fs::path &#20;tmp &#20;= &#20;fs::temp_directory_path() &#20;/ &#20;&quot;chunk_test_insert_after_text&quot;;<br>
 &#20; &#20; &#20; &#20;fs::remove_all(tmp);<br>
 &#20; &#20; &#20; &#20;fs::create_directories(tmp);<br>
<br>
 &#20; &#20; &#20; &#20;fs::path &#20;f &#20;= &#20;tmp &#20;/ &#20;&quot;a.txt&quot;;<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::ofstream &#20;out(f);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;out &#20;&lt;&lt; &#20;&quot;LINE1\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;LINE2\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;LINE3\n&quot;;<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;fs::path &#20;patch &#20;= &#20;tmp &#20;/ &#20;&quot;patch.txt&quot;;<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::ofstream &#20;out(patch);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;out &#20;&lt;&lt; &#20;&quot;=== &#20;file: &#20;&quot; &#20;&lt;&lt; &#20;f.string()<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&lt;&lt; &#20;&quot; &#20;===\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;--- &#20;insert-after-text\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;LINE2\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;---\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;AFTER\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;TEXT\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;=END=\n&quot;;<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;int &#20;r &#20;= &#20;run_apply(patch);<br>
 &#20; &#20; &#20; &#20;CHECK(r &#20;== &#20;0);<br>
<br>
 &#20; &#20; &#20; &#20;auto &#20;lines &#20;= &#20;read_lines(f);<br>
 &#20; &#20; &#20; &#20;REQUIRE(lines.size() &#20;== &#20;5);<br>
 &#20; &#20; &#20; &#20;CHECK(lines[0] &#20;== &#20;&quot;LINE1&quot;);<br>
 &#20; &#20; &#20; &#20;CHECK(lines[1] &#20;== &#20;&quot;LINE2&quot;);<br>
 &#20; &#20; &#20; &#20;CHECK(lines[2] &#20;== &#20;&quot;AFTER&quot;);<br>
 &#20; &#20; &#20; &#20;CHECK(lines[3] &#20;== &#20;&quot;TEXT&quot;);<br>
 &#20; &#20; &#20; &#20;CHECK(lines[4] &#20;== &#20;&quot;LINE3&quot;);<br>
}<br>
<br>
TEST_CASE(&quot;apply_chunk_main: &#20;insert-before-text&quot;)<br>
{<br>
 &#20; &#20; &#20; &#20;fs::path &#20;tmp &#20;= &#20;fs::temp_directory_path() &#20;/ &#20;&quot;chunk_test_insert_before_text&quot;;<br>
 &#20; &#20; &#20; &#20;fs::remove_all(tmp);<br>
 &#20; &#20; &#20; &#20;fs::create_directories(tmp);<br>
<br>
 &#20; &#20; &#20; &#20;fs::path &#20;f &#20;= &#20;tmp &#20;/ &#20;&quot;b.txt&quot;;<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::ofstream &#20;out(f);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;out &#20;&lt;&lt; &#20;&quot;AAA\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;BBB\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;CCC\n&quot;;<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;fs::path &#20;patch &#20;= &#20;tmp &#20;/ &#20;&quot;patch.txt&quot;;<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::ofstream &#20;out(patch);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;out &#20;&lt;&lt; &#20;&quot;=== &#20;file: &#20;&quot; &#20;&lt;&lt; &#20;f.string()<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&lt;&lt; &#20;&quot; &#20;===\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;--- &#20;insert-before-text\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;BBB\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;---\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;X\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;Y\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;=END=\n&quot;;<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;int &#20;r &#20;= &#20;run_apply(patch);<br>
 &#20; &#20; &#20; &#20;CHECK(r &#20;== &#20;0);<br>
<br>
 &#20; &#20; &#20; &#20;auto &#20;lines &#20;= &#20;read_lines(f);<br>
 &#20; &#20; &#20; &#20;REQUIRE(lines.size() &#20;== &#20;5);<br>
 &#20; &#20; &#20; &#20;CHECK(lines[0] &#20;== &#20;&quot;AAA&quot;);<br>
 &#20; &#20; &#20; &#20;CHECK(lines[1] &#20;== &#20;&quot;X&quot;);<br>
 &#20; &#20; &#20; &#20;CHECK(lines[2] &#20;== &#20;&quot;Y&quot;);<br>
 &#20; &#20; &#20; &#20;CHECK(lines[3] &#20;== &#20;&quot;BBB&quot;);<br>
 &#20; &#20; &#20; &#20;CHECK(lines[4] &#20;== &#20;&quot;CCC&quot;);<br>
}<br>
<br>
TEST_CASE(&quot;apply_chunk_main: &#20;replace-text&quot;)<br>
{<br>
 &#20; &#20; &#20; &#20;fs::path &#20;tmp &#20;= &#20;fs::temp_directory_path() &#20;/ &#20;&quot;chunk_test_replace_text&quot;;<br>
 &#20; &#20; &#20; &#20;fs::remove_all(tmp);<br>
 &#20; &#20; &#20; &#20;fs::create_directories(tmp);<br>
<br>
 &#20; &#20; &#20; &#20;fs::path &#20;f &#20;= &#20;tmp &#20;/ &#20;&quot;c.txt&quot;;<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::ofstream &#20;out(f);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;out &#20;&lt;&lt; &#20;&quot;alpha\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;beta\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;gamma\n&quot;;<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;fs::path &#20;patch &#20;= &#20;tmp &#20;/ &#20;&quot;patch.txt&quot;;<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::ofstream &#20;out(patch);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;out &#20;&lt;&lt; &#20;&quot;=== &#20;file: &#20;&quot; &#20;&lt;&lt; &#20;f.string()<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&lt;&lt; &#20;&quot; &#20;===\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;--- &#20;replace-text\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;beta\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;---\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;BETA1\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;BETA2\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;=END=\n&quot;;<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;int &#20;r &#20;= &#20;run_apply(patch);<br>
 &#20; &#20; &#20; &#20;CHECK(r &#20;== &#20;0);<br>
<br>
 &#20; &#20; &#20; &#20;auto &#20;lines &#20;= &#20;read_lines(f);<br>
 &#20; &#20; &#20; &#20;REQUIRE(lines.size() &#20;== &#20;4);<br>
 &#20; &#20; &#20; &#20;CHECK(lines[0] &#20;== &#20;&quot;alpha&quot;);<br>
 &#20; &#20; &#20; &#20;CHECK(lines[1] &#20;== &#20;&quot;BETA1&quot;);<br>
 &#20; &#20; &#20; &#20;CHECK(lines[2] &#20;== &#20;&quot;BETA2&quot;);<br>
 &#20; &#20; &#20; &#20;CHECK(lines[3] &#20;== &#20;&quot;gamma&quot;);<br>
}<br>
<br>
TEST_CASE(&quot;apply_chunk_main: &#20;delete-text&quot;)<br>
{<br>
 &#20; &#20; &#20; &#20;fs::path &#20;tmp &#20;= &#20;fs::temp_directory_path() &#20;/ &#20;&quot;chunk_test_delete_text&quot;;<br>
 &#20; &#20; &#20; &#20;fs::remove_all(tmp);<br>
 &#20; &#20; &#20; &#20;fs::create_directories(tmp);<br>
<br>
 &#20; &#20; &#20; &#20;fs::path &#20;f &#20;= &#20;tmp &#20;/ &#20;&quot;d.txt&quot;;<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::ofstream &#20;out(f);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;out &#20;&lt;&lt; &#20;&quot;one\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;two\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;three\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;four\n&quot;;<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;fs::path &#20;patch &#20;= &#20;tmp &#20;/ &#20;&quot;patch.txt&quot;;<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::ofstream &#20;out(patch);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;out &#20;&lt;&lt; &#20;&quot;=== &#20;file: &#20;&quot; &#20;&lt;&lt; &#20;f.string()<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&lt;&lt; &#20;&quot; &#20;===\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;--- &#20;delete-text\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;two\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;three\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;---\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;=END=\n&quot;;<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;int &#20;r &#20;= &#20;run_apply(patch);<br>
 &#20; &#20; &#20; &#20;CHECK(r &#20;== &#20;0);<br>
<br>
 &#20; &#20; &#20; &#20;auto &#20;lines &#20;= &#20;read_lines(f);<br>
 &#20; &#20; &#20; &#20;REQUIRE(lines.size() &#20;== &#20;2);<br>
 &#20; &#20; &#20; &#20;CHECK(lines[0] &#20;== &#20;&quot;one&quot;);<br>
 &#20; &#20; &#20; &#20;CHECK(lines[1] &#20;== &#20;&quot;four&quot;);<br>
}<br>
<br>
TEST_CASE(&quot;apply_chunk_main: &#20;apply-stdin&quot;)<br>
{<br>
 &#20; &#20; &#20; &#20;namespace &#20;fs &#20;= &#20;std::filesystem;<br>
<br>
 &#20; &#20; &#20; &#20;fs::path &#20;tmp &#20;= &#20;fs::temp_directory_path() &#20;/ &#20;&quot;chunk_test_stdin&quot;;<br>
 &#20; &#20; &#20; &#20;fs::remove_all(tmp);<br>
 &#20; &#20; &#20; &#20;fs::create_directories(tmp);<br>
<br>
 &#20; &#20; &#20; &#20;fs::path &#20;f &#20;= &#20;tmp &#20;/ &#20;&quot;stdin.txt&quot;;<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::ofstream &#20;out(f);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;out &#20;&lt;&lt; &#20;&quot;A\nB\nC\n&quot;;<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;std::string &#20;patch &#20;= &#20;&quot;=== &#20;file: &#20;&quot; &#20;+ &#20;f.string() &#20;+<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot; &#20;===\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;--- &#20;replace-text\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;B\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;---\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;XXX\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;=END=\n&quot;;<br>
<br>
 &#20; &#20; &#20; &#20;std::istringstream &#20;fake_stdin(patch);<br>
 &#20; &#20; &#20; &#20;auto &#20;*old_stdin &#20;= &#20;std::cin.rdbuf(fake_stdin.rdbuf());<br>
<br>
 &#20; &#20; &#20; &#20;const &#20;char &#20;*argv[] &#20;= &#20;{&quot;scat&quot;, &#20;&quot;--apply-stdin&quot;};<br>
 &#20; &#20; &#20; &#20;int &#20;r &#20;= &#20;scat_main(2, &#20;(char &#20;**)argv);<br>
<br>
 &#20; &#20; &#20; &#20;std::cin.rdbuf(old_stdin);<br>
<br>
 &#20; &#20; &#20; &#20;CHECK(r &#20;== &#20;0);<br>
<br>
 &#20; &#20; &#20; &#20;auto &#20;lines &#20;= &#20;read_lines(f);<br>
 &#20; &#20; &#20; &#20;REQUIRE(lines.size() &#20;== &#20;3);<br>
 &#20; &#20; &#20; &#20;CHECK(lines[0] &#20;== &#20;&quot;A&quot;);<br>
 &#20; &#20; &#20; &#20;CHECK(lines[1] &#20;== &#20;&quot;XXX&quot;);<br>
 &#20; &#20; &#20; &#20;CHECK(lines[2] &#20;== &#20;&quot;C&quot;);<br>
}<br>
TEST_CASE(&quot;apply_chunk_main: &#20;delete-file &#20;then &#20;create-file&quot;)<br>
{<br>
 &#20; &#20; &#20; &#20;namespace &#20;fs &#20;= &#20;std::filesystem;<br>
<br>
 &#20; &#20; &#20; &#20;fs::path &#20;tmp &#20;= &#20;fs::temp_directory_path() &#20;/ &#20;&quot;chunk_test_del_create&quot;;<br>
 &#20; &#20; &#20; &#20;fs::remove_all(tmp);<br>
 &#20; &#20; &#20; &#20;fs::create_directories(tmp);<br>
<br>
 &#20; &#20; &#20; &#20;fs::path &#20;f &#20;= &#20;tmp &#20;/ &#20;&quot;x.txt&quot;;<br>
<br>
 &#20; &#20; &#20; &#20;// &#20;Исходный &#20;файл<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::ofstream &#20;out(f);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;out &#20;&lt;&lt; &#20;&quot;OLD&quot;;<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;// &#20;Патч: &#20;удалить &#20;→ &#20;создать &#20;заново<br>
 &#20; &#20; &#20; &#20;fs::path &#20;patch &#20;= &#20;tmp &#20;/ &#20;&quot;patch.txt&quot;;<br>
 &#20; &#20; &#20; &#20;{<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;std::ofstream &#20;out(patch);<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;out &#20;&lt;&lt; &#20;&quot;=== &#20;file: &#20;&quot; &#20;&lt;&lt; &#20;f.string()<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&lt;&lt; &#20;&quot; &#20;===\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;--- &#20;delete-file\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;=END=\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;=== &#20;file: &#20;&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&lt;&lt; &#20;f.string()<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&lt;&lt; &#20;&quot; &#20;===\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;--- &#20;create-file\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;NEW1\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;NEW2\n&quot;<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;=END=\n&quot;;<br>
 &#20; &#20; &#20; &#20;}<br>
<br>
 &#20; &#20; &#20; &#20;int &#20;r &#20;= &#20;run_apply(patch);<br>
 &#20; &#20; &#20; &#20;CHECK(r &#20;== &#20;0);<br>
<br>
 &#20; &#20; &#20; &#20;REQUIRE(fs::exists(f));<br>
<br>
 &#20; &#20; &#20; &#20;auto &#20;lines &#20;= &#20;read_lines(f);<br>
 &#20; &#20; &#20; &#20;REQUIRE(lines.size() &#20;== &#20;2);<br>
 &#20; &#20; &#20; &#20;CHECK(lines[0] &#20;== &#20;&quot;NEW1&quot;);<br>
 &#20; &#20; &#20; &#20;CHECK(lines[1] &#20;== &#20;&quot;NEW2&quot;);<br>
}<br>
<!-- END SCAT CODE -->
</body>
</html>
