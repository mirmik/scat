<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>tests/symbols_py.cpp</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
#include &#20;&quot;doctest/doctest.h&quot;<br>
#include &#20;&quot;symbols.h&quot;<br>
<br>
#include &#20;&lt;string&gt;<br>
<br>
TEST_CASE(&quot;PythonSymbolFinder: &#20;simple &#20;class &#20;and &#20;methods&quot;)<br>
{<br>
 &#20; &#20; &#20; &#20;std::string &#20;src &#20;= &#20;&quot;class &#20;Foo:\n&quot; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;0<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot; &#20; &#20; &#20; &#20;def &#20;bar(self):\n&quot; &#20; &#20; &#20; &#20;// &#20;1<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;pass\n&quot; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;2<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;\n&quot; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;3<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot; &#20; &#20; &#20; &#20;def &#20;baz(self, &#20;x):\n&quot; &#20;// &#20;4<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return &#20;x &#20;+ &#20;1\n&quot;; &#20;// &#20;5<br>
<br>
 &#20; &#20; &#20; &#20;PythonSymbolFinder &#20;finder(src);<br>
 &#20; &#20; &#20; &#20;Region &#20;r_class;<br>
<br>
 &#20; &#20; &#20; &#20;CHECK(finder.find_class(&quot;Foo&quot;, &#20;r_class));<br>
 &#20; &#20; &#20; &#20;CHECK(r_class.start_line &#20;== &#20;0);<br>
 &#20; &#20; &#20; &#20;CHECK(r_class.end_line &#20;== &#20;5);<br>
<br>
 &#20; &#20; &#20; &#20;Region &#20;r_bar;<br>
 &#20; &#20; &#20; &#20;CHECK(finder.find_method(&quot;Foo&quot;, &#20;&quot;bar&quot;, &#20;r_bar));<br>
 &#20; &#20; &#20; &#20;CHECK(r_bar.start_line &#20;== &#20;1);<br>
 &#20; &#20; &#20; &#20;CHECK(r_bar.end_line &#20;== &#20;2);<br>
<br>
 &#20; &#20; &#20; &#20;Region &#20;r_baz;<br>
 &#20; &#20; &#20; &#20;CHECK(finder.find_method(&quot;Foo&quot;, &#20;&quot;baz&quot;, &#20;r_baz));<br>
 &#20; &#20; &#20; &#20;CHECK(r_baz.start_line &#20;== &#20;4);<br>
 &#20; &#20; &#20; &#20;CHECK(r_baz.end_line &#20;== &#20;5);<br>
}<br>
<br>
TEST_CASE(&quot;PythonSymbolFinder: &#20;ignores &#20;top-level &#20;functions&quot;)<br>
{<br>
 &#20; &#20; &#20; &#20;std::string &#20;src &#20;= &#20;&quot;def &#20;foo():\n&quot; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;0<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot; &#20; &#20; &#20; &#20;pass\n&quot; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;1<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;\n&quot; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;2<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;class &#20;Foo:\n&quot; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;3<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot; &#20; &#20; &#20; &#20;def &#20;foo(self):\n&quot; &#20;// &#20;4<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;pass\n&quot;; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;5<br>
<br>
 &#20; &#20; &#20; &#20;PythonSymbolFinder &#20;finder(src);<br>
 &#20; &#20; &#20; &#20;Region &#20;r_class;<br>
<br>
 &#20; &#20; &#20; &#20;CHECK(finder.find_class(&quot;Foo&quot;, &#20;r_class));<br>
 &#20; &#20; &#20; &#20;CHECK(r_class.start_line &#20;== &#20;3);<br>
 &#20; &#20; &#20; &#20;CHECK(r_class.end_line &#20;== &#20;5);<br>
<br>
 &#20; &#20; &#20; &#20;Region &#20;r_method;<br>
 &#20; &#20; &#20; &#20;CHECK(finder.find_method(&quot;Foo&quot;, &#20;&quot;foo&quot;, &#20;r_method));<br>
 &#20; &#20; &#20; &#20;CHECK(r_method.start_line &#20;== &#20;4);<br>
 &#20; &#20; &#20; &#20;CHECK(r_method.end_line &#20;== &#20;5);<br>
}<br>
<br>
TEST_CASE(&quot;PythonSymbolFinder: &#20;decorated &#20;methods&quot;)<br>
{<br>
 &#20; &#20; &#20; &#20;std::string &#20;src &#20;= &#20;&quot;class &#20;Foo:\n&quot; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;0<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot; &#20; &#20; &#20; &#20;@decorator\n&quot; &#20; &#20; &#20; &#20; &#20;// &#20;1<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot; &#20; &#20; &#20; &#20;def &#20;bar(self):\n&quot; &#20;// &#20;2<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;pass\n&quot;; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;3<br>
<br>
 &#20; &#20; &#20; &#20;PythonSymbolFinder &#20;finder(src);<br>
 &#20; &#20; &#20; &#20;Region &#20;r_method;<br>
<br>
 &#20; &#20; &#20; &#20;CHECK(finder.find_method(&quot;Foo&quot;, &#20;&quot;bar&quot;, &#20;r_method));<br>
 &#20; &#20; &#20; &#20;CHECK(r_method.start_line &#20;== &#20;1); &#20;// &#20;вместе &#20;с &#20;декоратором<br>
 &#20; &#20; &#20; &#20;CHECK(r_method.end_line &#20;== &#20;3);<br>
}<br>
<br>
TEST_CASE(&quot;PythonSymbolFinder: &#20;nested &#20;class &#20;and &#20;methods&quot;)<br>
{<br>
 &#20; &#20; &#20; &#20;std::string &#20;src &#20;= &#20;&quot;class &#20;Outer:\n&quot; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;0<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot; &#20; &#20; &#20; &#20;def &#20;a(self):\n&quot; &#20; &#20; &#20; &#20; &#20;// &#20;1<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;pass\n&quot; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;2<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot; &#20; &#20; &#20; &#20;class &#20;Inner:\n&quot; &#20; &#20; &#20; &#20; &#20;// &#20;3<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;def &#20;b(self):\n&quot; &#20;// &#20;4<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;pass\n&quot;; &#20; &#20; &#20; &#20;// &#20;5<br>
<br>
 &#20; &#20; &#20; &#20;PythonSymbolFinder &#20;finder(src);<br>
<br>
 &#20; &#20; &#20; &#20;Region &#20;r_outer;<br>
 &#20; &#20; &#20; &#20;CHECK(finder.find_class(&quot;Outer&quot;, &#20;r_outer));<br>
 &#20; &#20; &#20; &#20;CHECK(r_outer.start_line &#20;== &#20;0);<br>
 &#20; &#20; &#20; &#20;CHECK(r_outer.end_line &#20;== &#20;5);<br>
<br>
 &#20; &#20; &#20; &#20;Region &#20;r_a;<br>
 &#20; &#20; &#20; &#20;CHECK(finder.find_method(&quot;Outer&quot;, &#20;&quot;a&quot;, &#20;r_a));<br>
 &#20; &#20; &#20; &#20;CHECK(r_a.start_line &#20;== &#20;1);<br>
 &#20; &#20; &#20; &#20;CHECK(r_a.end_line &#20;== &#20;2);<br>
<br>
 &#20; &#20; &#20; &#20;Region &#20;r_inner_class;<br>
 &#20; &#20; &#20; &#20;CHECK(finder.find_class(&quot;Inner&quot;, &#20;r_inner_class));<br>
 &#20; &#20; &#20; &#20;CHECK(r_inner_class.start_line &#20;== &#20;3);<br>
 &#20; &#20; &#20; &#20;CHECK(r_inner_class.end_line &#20;== &#20;5);<br>
<br>
 &#20; &#20; &#20; &#20;Region &#20;r_b;<br>
 &#20; &#20; &#20; &#20;CHECK(finder.find_method(&quot;Inner&quot;, &#20;&quot;b&quot;, &#20;r_b));<br>
 &#20; &#20; &#20; &#20;CHECK(r_b.start_line &#20;== &#20;4);<br>
 &#20; &#20; &#20; &#20;CHECK(r_b.end_line &#20;== &#20;5);<br>
}<br>
<br>
TEST_CASE(&quot;PythonSymbolFinder: &#20;async &#20;methods&quot;)<br>
{<br>
 &#20; &#20; &#20; &#20;std::string &#20;src &#20;= &#20;&quot;class &#20;Foo:\n&quot; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;0<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot; &#20; &#20; &#20; &#20;async &#20;def &#20;bar(self):\n&quot; &#20; &#20; &#20;// &#20;1<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;await &#20;something()\n&quot;; &#20;// &#20;2<br>
<br>
 &#20; &#20; &#20; &#20;PythonSymbolFinder &#20;finder(src);<br>
<br>
 &#20; &#20; &#20; &#20;Region &#20;r_class;<br>
 &#20; &#20; &#20; &#20;CHECK(finder.find_class(&quot;Foo&quot;, &#20;r_class));<br>
 &#20; &#20; &#20; &#20;CHECK(r_class.start_line &#20;== &#20;0);<br>
 &#20; &#20; &#20; &#20;CHECK(r_class.end_line &#20;== &#20;2);<br>
<br>
 &#20; &#20; &#20; &#20;Region &#20;r_bar;<br>
 &#20; &#20; &#20; &#20;CHECK(finder.find_method(&quot;Foo&quot;, &#20;&quot;bar&quot;, &#20;r_bar));<br>
 &#20; &#20; &#20; &#20;CHECK(r_bar.start_line &#20;== &#20;1);<br>
 &#20; &#20; &#20; &#20;CHECK(r_bar.end_line &#20;== &#20;2);<br>
}<br>
<br>
TEST_CASE(&quot;PythonSymbolFinder: &#20;whitespace, &#20;comments &#20;and &#20;docstrings&quot;)<br>
{<br>
 &#20; &#20; &#20; &#20;std::string &#20;src &#20;= &#20;&quot;#!/usr/bin/env &#20;python3\n&quot; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;0<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;\n&quot; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;1<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;class &#20; &#20; &#20;Weird &#20; &#20;( &#20; &#20;Base &#20; &#20;):\n&quot; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;2<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot; &#20; &#20; &#20; &#20;\\\&quot;\\\&quot;\\\&quot;docstring\\\&quot;\\\&quot;\\\&quot;\n&quot; &#20;// &#20;3<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot; &#20; &#20; &#20; &#20;# &#20;comment &#20;inside &#20;class\n&quot; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;4<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot; &#20; &#20; &#20; &#20;def &#20; &#20; &#20;run &#20;( &#20;self, &#20; &#20;x &#20;):\n&quot; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;5<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;# &#20;inner &#20;comment\n&quot; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;6<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;return &#20;x &#20;+ &#20;1\n&quot; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;7<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;\n&quot; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;8<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot;def &#20;run(x):\n&quot; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;9<br>
 &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;&quot; &#20; &#20; &#20; &#20;return &#20;x\n&quot;; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20; &#20;// &#20;10<br>
<br>
 &#20; &#20; &#20; &#20;PythonSymbolFinder &#20;finder(src);<br>
<br>
 &#20; &#20; &#20; &#20;Region &#20;r_class;<br>
 &#20; &#20; &#20; &#20;CHECK(finder.find_class(&quot;Weird&quot;, &#20;r_class));<br>
 &#20; &#20; &#20; &#20;CHECK(r_class.start_line &#20;== &#20;2);<br>
 &#20; &#20; &#20; &#20;CHECK(r_class.end_line &#20;== &#20;7);<br>
<br>
 &#20; &#20; &#20; &#20;Region &#20;r_run;<br>
 &#20; &#20; &#20; &#20;CHECK(finder.find_method(&quot;Weird&quot;, &#20;&quot;run&quot;, &#20;r_run));<br>
 &#20; &#20; &#20; &#20;CHECK(r_run.start_line &#20;== &#20;5);<br>
 &#20; &#20; &#20; &#20;CHECK(r_run.end_line &#20;== &#20;7);<br>
}<br>
<!-- END SCAT CODE -->
</body>
</html>
