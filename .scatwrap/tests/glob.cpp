<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>tests/glob.cpp</title>
</head>
<body>
<!-- BEGIN SCAT CODE -->
#include&#32;&quot;glob.h&quot;<br>
#include&#32;&quot;doctest/doctest.h&quot;<br>
#include&#32;&lt;algorithm&gt;<br>
#include&#32;&lt;filesystem&gt;<br>
#include&#32;&lt;fstream&gt;<br>
#include&#32;&lt;vector&gt;<br>
<br>
namespace&#32;fs&#32;=&#32;std::filesystem;<br>
<br>
static&#32;void&#32;write_file(const&#32;fs::path&#32;&amp;p,&#32;const&#32;std::string&#32;&amp;text)<br>
{<br>
&#32;&#32;&#32;&#32;fs::create_directories(p.parent_path());<br>
&#32;&#32;&#32;&#32;std::ofstream&#32;out(p);<br>
&#32;&#32;&#32;&#32;out&#32;&lt;&lt;&#32;text;<br>
}<br>
<br>
static&#32;std::vector&lt;std::string&gt;&#32;to_rel(const&#32;std::vector&lt;fs::path&gt;&#32;&amp;v,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;const&#32;fs::path&#32;&amp;root)<br>
{<br>
&#32;&#32;&#32;&#32;std::vector&lt;std::string&gt;&#32;out;<br>
&#32;&#32;&#32;&#32;for&#32;(auto&#32;&amp;p&#32;:&#32;v)<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;out.push_back(fs::relative(p,&#32;root).generic_string());<br>
&#32;&#32;&#32;&#32;std::sort(out.begin(),&#32;out.end());<br>
&#32;&#32;&#32;&#32;return&#32;out;<br>
}<br>
<br>
static&#32;void&#32;check_paths(const&#32;std::vector&lt;std::string&gt;&#32;&amp;actual,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;std::initializer_list&lt;const&#32;char&#32;*&gt;&#32;expected)<br>
{<br>
&#32;&#32;&#32;&#32;CHECK(actual.size()&#32;==&#32;expected.size());<br>
<br>
&#32;&#32;&#32;&#32;size_t&#32;i&#32;=&#32;0;<br>
&#32;&#32;&#32;&#32;for&#32;(auto&#32;*e&#32;:&#32;expected)<br>
&#32;&#32;&#32;&#32;{<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;CHECK(actual[i]&#32;==&#32;e);<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;++i;<br>
&#32;&#32;&#32;&#32;}<br>
}<br>
<br>
TEST_CASE(&quot;glob:&#32;basic&#32;*&quot;)<br>
{<br>
&#32;&#32;&#32;&#32;fs::path&#32;tmp&#32;=&#32;fs::temp_directory_path()&#32;/&#32;&quot;glob_test_a&quot;;<br>
&#32;&#32;&#32;&#32;fs::remove_all(tmp);<br>
<br>
&#32;&#32;&#32;&#32;write_file(tmp&#32;/&#32;&quot;a.txt&quot;,&#32;&quot;A&quot;);<br>
&#32;&#32;&#32;&#32;write_file(tmp&#32;/&#32;&quot;b.cpp&quot;,&#32;&quot;B&quot;);<br>
&#32;&#32;&#32;&#32;write_file(tmp&#32;/&#32;&quot;c.txt&quot;,&#32;&quot;C&quot;);<br>
<br>
&#32;&#32;&#32;&#32;auto&#32;out&#32;=&#32;expand_glob((tmp&#32;/&#32;&quot;*.txt&quot;).generic_string());<br>
&#32;&#32;&#32;&#32;auto&#32;rel&#32;=&#32;to_rel(out,&#32;tmp);<br>
<br>
&#32;&#32;&#32;&#32;check_paths(rel,&#32;{&quot;a.txt&quot;,&#32;&quot;c.txt&quot;});<br>
}<br>
<br>
TEST_CASE(&quot;glob:&#32;recursive&#32;**&quot;)<br>
{<br>
&#32;&#32;&#32;&#32;fs::path&#32;tmp&#32;=&#32;fs::temp_directory_path()&#32;/&#32;&quot;glob_test_b&quot;;<br>
&#32;&#32;&#32;&#32;fs::remove_all(tmp);<br>
<br>
&#32;&#32;&#32;&#32;write_file(tmp&#32;/&#32;&quot;1.txt&quot;,&#32;&quot;A&quot;);<br>
&#32;&#32;&#32;&#32;write_file(tmp&#32;/&#32;&quot;x/2.txt&quot;,&#32;&quot;B&quot;);<br>
&#32;&#32;&#32;&#32;write_file(tmp&#32;/&#32;&quot;x/y/3.txt&quot;,&#32;&quot;C&quot;);<br>
<br>
&#32;&#32;&#32;&#32;auto&#32;out&#32;=&#32;expand_glob((tmp&#32;/&#32;&quot;**&quot;).generic_string());<br>
&#32;&#32;&#32;&#32;auto&#32;rel&#32;=&#32;to_rel(out,&#32;tmp);<br>
<br>
&#32;&#32;&#32;&#32;check_paths(rel,&#32;{&quot;1.txt&quot;,&#32;&quot;x/2.txt&quot;,&#32;&quot;x/y/3.txt&quot;});<br>
}<br>
<br>
TEST_CASE(&quot;glob:&#32;**/*.cpp&quot;)<br>
{<br>
&#32;&#32;&#32;&#32;fs::path&#32;tmp&#32;=&#32;fs::temp_directory_path()&#32;/&#32;&quot;glob_test_c&quot;;<br>
&#32;&#32;&#32;&#32;fs::remove_all(tmp);<br>
<br>
&#32;&#32;&#32;&#32;write_file(tmp&#32;/&#32;&quot;a.cpp&quot;,&#32;&quot;A&quot;);<br>
&#32;&#32;&#32;&#32;write_file(tmp&#32;/&#32;&quot;b.h&quot;,&#32;&quot;B&quot;);<br>
&#32;&#32;&#32;&#32;write_file(tmp&#32;/&#32;&quot;x/c.cpp&quot;,&#32;&quot;C&quot;);<br>
&#32;&#32;&#32;&#32;write_file(tmp&#32;/&#32;&quot;x/y/z.cpp&quot;,&#32;&quot;Z&quot;);<br>
<br>
&#32;&#32;&#32;&#32;auto&#32;out&#32;=&#32;expand_glob((tmp&#32;/&#32;&quot;**/*.cpp&quot;).generic_string());<br>
&#32;&#32;&#32;&#32;auto&#32;rel&#32;=&#32;to_rel(out,&#32;tmp);<br>
<br>
&#32;&#32;&#32;&#32;check_paths(rel,&#32;{&quot;a.cpp&quot;,&#32;&quot;x/c.cpp&quot;,&#32;&quot;x/y/z.cpp&quot;});<br>
}<br>
<br>
TEST_CASE(&quot;glob:&#32;foo/*/bar/**/*.txt&quot;)<br>
{<br>
&#32;&#32;&#32;&#32;fs::path&#32;tmp&#32;=&#32;fs::temp_directory_path()&#32;/&#32;&quot;glob_test_d&quot;;<br>
&#32;&#32;&#32;&#32;fs::remove_all(tmp);<br>
<br>
&#32;&#32;&#32;&#32;write_file(tmp&#32;/&#32;&quot;foo/K/bar/a.txt&quot;,&#32;&quot;A&quot;);<br>
&#32;&#32;&#32;&#32;write_file(tmp&#32;/&#32;&quot;foo/K/bar/x/b.txt&quot;,&#32;&quot;B&quot;);<br>
&#32;&#32;&#32;&#32;write_file(tmp&#32;/&#32;&quot;foo/X/bar/c.bin&quot;,&#32;&quot;C&quot;);<br>
&#32;&#32;&#32;&#32;write_file(tmp&#32;/&#32;&quot;foo/Z/bar/y/z.txt&quot;,&#32;&quot;Z&quot;);<br>
<br>
&#32;&#32;&#32;&#32;auto&#32;pat&#32;=&#32;(tmp&#32;/&#32;&quot;foo/*/bar/**/*.txt&quot;).generic_string();<br>
&#32;&#32;&#32;&#32;auto&#32;out&#32;=&#32;expand_glob(pat);<br>
&#32;&#32;&#32;&#32;auto&#32;rel&#32;=&#32;to_rel(out,&#32;tmp);<br>
<br>
&#32;&#32;&#32;&#32;check_paths(rel,<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{&quot;foo/K/bar/a.txt&quot;,&#32;&quot;foo/K/bar/x/b.txt&quot;,&#32;&quot;foo/Z/bar/y/z.txt&quot;});<br>
}<br>
<br>
TEST_CASE(&quot;glob:&#32;no&#32;matches&#32;returns&#32;empty&quot;)<br>
{<br>
&#32;&#32;&#32;&#32;fs::path&#32;tmp&#32;=&#32;fs::temp_directory_path()&#32;/&#32;&quot;glob_test_e&quot;;<br>
&#32;&#32;&#32;&#32;fs::remove_all(tmp);<br>
<br>
&#32;&#32;&#32;&#32;write_file(tmp&#32;/&#32;&quot;file.cpp&quot;,&#32;&quot;A&quot;);<br>
<br>
&#32;&#32;&#32;&#32;auto&#32;out&#32;=&#32;expand_glob((tmp&#32;/&#32;&quot;**/*.txt&quot;).generic_string());<br>
&#32;&#32;&#32;&#32;CHECK(out.empty());<br>
}<br>
<br>
TEST_CASE(&quot;glob:&#32;duplicates&#32;removed&quot;)<br>
{<br>
&#32;&#32;&#32;&#32;fs::path&#32;tmp&#32;=&#32;fs::temp_directory_path()&#32;/&#32;&quot;glob_test_f&quot;;<br>
&#32;&#32;&#32;&#32;fs::remove_all(tmp);<br>
<br>
&#32;&#32;&#32;&#32;write_file(tmp&#32;/&#32;&quot;a.txt&quot;,&#32;&quot;A&quot;);<br>
&#32;&#32;&#32;&#32;write_file(tmp&#32;/&#32;&quot;d/a.txt&quot;,&#32;&quot;A2&quot;);<br>
<br>
&#32;&#32;&#32;&#32;//&#32;отработает&#32;и&#32;*&#32;и&#32;**<br>
&#32;&#32;&#32;&#32;auto&#32;pat1&#32;=&#32;(tmp&#32;/&#32;&quot;*.txt&quot;).generic_string();<br>
&#32;&#32;&#32;&#32;auto&#32;pat2&#32;=&#32;(tmp&#32;/&#32;&quot;**/*.txt&quot;).generic_string();<br>
<br>
&#32;&#32;&#32;&#32;auto&#32;out1&#32;=&#32;expand_glob(pat1);<br>
&#32;&#32;&#32;&#32;auto&#32;out2&#32;=&#32;expand_glob(pat2);<br>
<br>
&#32;&#32;&#32;&#32;std::vector&lt;fs::path&gt;&#32;combined;<br>
&#32;&#32;&#32;&#32;combined.insert(combined.end(),&#32;out1.begin(),&#32;out1.end());<br>
&#32;&#32;&#32;&#32;combined.insert(combined.end(),&#32;out2.begin(),&#32;out2.end());<br>
<br>
&#32;&#32;&#32;&#32;//&#32;удаляем&#32;дубликаты&#32;вручную,&#32;как&#32;collector&#32;делает<br>
&#32;&#32;&#32;&#32;std::sort(combined.begin(),&#32;combined.end());<br>
&#32;&#32;&#32;&#32;combined.erase(std::unique(combined.begin(),&#32;combined.end()),<br>
&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;combined.end());<br>
<br>
&#32;&#32;&#32;&#32;auto&#32;rel&#32;=&#32;to_rel(combined,&#32;tmp);<br>
&#32;&#32;&#32;&#32;check_paths(rel,&#32;{&quot;a.txt&quot;,&#32;&quot;d/a.txt&quot;});<br>
}<br>
<!-- END SCAT CODE -->
</body>
</html>
