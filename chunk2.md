# Chunk v2 — Формат описания изменений

**Chunk v2** — текстовый формат, предназначенный для описания изменений в исходных файлах.
Патч состоит из набора секций; каждая секция относится к одному файлу и содержит одну операцию: замену, вставку или удаление строк либо работу с текстовым фрагментом.

---

## 1. Структура секции

```text
=== file: <путь> ===
<команда>
<контент...>
=END=
```

* `<путь>` — относительный путь к файлу.
* Между секциями допускается пустая строка.
* В секции должна быть ровно одна команда.
* `<контент>` может содержать любые строки, включая пустые.

---

## 2. Команды, основанные на номерах строк

Эти команды работают с нумерацией строк, начиная с нуля.

### Замена диапазона строк

```text
--- replace <start>:<end>
<новые строки...>
=END=
```

### Вставка после строки

```text
--- insert-after <line>
<вставляемые строки...>
=END=
```

### Удаление диапазона строк

```text
--- delete <start>:<end>
=END=
```

---

## 3. Команды, основанные на тексте

Помимо индексных операций, Chunk v2 поддерживает команды, которые ищут **точный текстовый фрагмент** в файле и выполняют действие относительно него.
Это особенно полезно, если патчи генерируются автоматически или если содержимое файла может смещаться.

### Общая схема

```text
=== file: <путь> ===
--- <команда>
<маркер...>
---
<контент...>
=END=
```

* Всё **до строки `---`** трактуется как **маркер** — фрагмент текста, который должен быть найден в файле.
* Всё **после строки `---`** — это **контент**, который будет вставлен/заменён (может быть пустым).
* Маркер сравнивается полностью, включая несколько строк подряд.
* Маркер обязателен.

### Вставка после фрагмента

```text
--- insert-after-text
<маркер...>
---
<вставляемые строки...>
=END=
```

Вставляет строки **сразу после** найденного маркера.

### Вставка перед фрагментом

```text
--- insert-before-text
<маркер...>
---
<вставляемые строки...>
=END=
```

Вставляет строки **перед** найденным маркером.

### Замена фрагмента

```text
--- replace-text
<маркер...>
---
<новые строки...>
=END=
```

Заменяет маркер указанным содержимым.

### Удаление фрагмента

```text
--- delete-text
<маркер...>
---
=END=
```

Удаляет найденный маркер.

---

## 4. Ограничения

* Команды `*-text` и индексные команды (`replace`, `insert-after`, `delete`) нельзя смешивать в одной секции, относящейся к одному файлу.
* Маркер должен совпасть **в точности** — регистр, пробелы, пустые строки.
* Маркер может быть **многострочным**.
* Поведение строго детерминировано: никаких частичных совпадений или fuzzy-поиска.

---

## 5. Нумерация строк

(Актуально только для индексных команд.)

* Нумерация начинается с **0**.
* Диапазоны включают обе границы.

---

## 6. Примеры

### Замена диапазона строк

```text
=== file: src/a.cpp ===
--- replace 3:4
int value = 42;
std::cout << value << "\n";
=END=
```

### Вставка по индексу

```text
=== file: src/b.cpp ===
--- insert-after 12
log_debug("checkpoint reached");
=END=
```

### Удаление по индексу

```text
=== file: src/c.cpp ===
--- delete 20:25
=END=
```

---

## Примеры text-based команд

### Вставка после маркера

```text
=== file: src/log.cpp ===
--- insert-after-text
LOG_BEGIN
---
std::cout << "Checkpoint\n";
=END=
```

### Вставка перед маркером

```text
=== file: src/log.cpp ===
--- insert-before-text
int main()
---
#include "myprelude.h"
=END=
```

### Замена фрагмента

```text
=== file: src/calc.cpp ===
--- replace-text
return x + y;
---
return safe_add(x, y);
=END=
```

### Удаление фрагмента

```text
=== file: src/debug.cpp ===
--- delete-text
std::cout << "DEBUG\n";
---
=END=
```
