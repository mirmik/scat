# Chunk v2 — Формат описания изменений

**Chunk v2** — текстовый формат, предназначенный для описания изменений в исходных файлах.
Патч состоит из набора секций; каждая секция относится к одному файлу и содержит одну операцию: замену, вставку или удаление строк либо работу с текстовым фрагментом.

---

## 1. Структура секции

```text
=== file: <путь> ===
<команда>
<контент...>
=END=
```

* `<путь>` — относительный путь к файлу.
* Между секциями допускается пустая строка.
* В секции должна быть ровно одна команда.
* `<контент>` может содержать любые строки, включая пустые.

---

## 3. Команды, основанные на тексте

Помимо индексных операций, Chunk v2 поддерживает команды, которые ищут **точный текстовый фрагмент** в файле и выполняют действие относительно него.

### Общая схема

```text
=== file: <путь> ===
--- <команда>
<маркер...>
---
<контент...>
=END=
```

* Всё **до строки `---`** трактуется как **маркер**.
* Всё **после строки `---`** — контент, который будет вставлен или заменён.
* Маркер может быть многострочным.
* Маркер обязателен.

### Вставка после фрагмента

```text
--- insert-after-text
<маркер...>
---
<вставляемые строки...>
=END=
```

### Вставка перед фрагментом

```text
--- insert-before-text
<маркер...>
---
<вставляемые строки...>
=END=
```

### Замена фрагмента

```text
--- replace-text
<маркер...>
---
<новые строки...>
=END=
```

### Удаление фрагмента

```text
--- delete-text
<маркер...>
---
=END=
```

---

## 4. Команды управления файлами

Chunk v2 поддерживает операции, которые работают **не со строками внутри файла**, а с самим файлом целиком.

### Создание файла

Создаёт новый файл с указанным содержимым.
Если файл уже существует — он перезаписывается.

```text
--- create-file
<содержимое нового файла...>
=END=
```

### Удаление файла

Удаляет файл целиком.

```text
--- delete-file
=END=
```

---

## 5. Ограничения

* Нельзя смешивать `*-text` и индексные команды для одного и того же файла в одном патче.
* Команды `create-file` и `delete-file` также являются одиночными операциями для файла:

  * если секция использует одну из них — никакие другие операции к этому же файлу в рамках секции не разрешены;
  * они не смешиваются с другими типами команд.
* Маркер должен совпасть **точно**.
* Диапазоны включают обе границы.

---

## 6. Нумерация строк

(Актуально только для индексных команд.)

* Нумерация начинается с **0**.
* Диапазоны включают обе границы.

---

## 7. Примеры

### Замена диапазона строк

```text
=== file: src/a.cpp ===
--- replace 3:4
int value = 42;
std::cout << value << "\n";
=END=
```

### Вставка по индексу

```text
=== file: src/b.cpp ===
--- insert-after 12
log_debug("checkpoint reached");
=END=
```

### Удаление по индексу

```text
=== file: src/c.cpp ===
--- delete 20:25
=END=
```

---

## Примеры text-based команд

### Вставка после маркера

```text
=== file: src/log.cpp ===
--- insert-after-text
LOG_BEGIN
---
std::cout << "Checkpoint\n";
=END=
```

### Вставка перед маркером

```text
=== file: src/log.cpp ===
--- insert-before-text
int main()
---
#include "myprelude.h"
=END=
```

### Замена фрагмента

```text
=== file: src/calc.cpp ===
--- replace-text
return x + y;
---
return safe_add(x, y);
=END=
```

### Удаление фрагмента

```text
=== file: src/debug.cpp ===
--- delete-text
std::cout << "DEBUG\n";
---
=END=
```

---

## Примеры file-level команд

### Создание файла

```text
=== file: assets/config.json ===
--- create-file
{
    "version": 1,
    "mode": "default"
}
=END=
```

### Удаление файла

```text
=== file: old/unused.tmp ===
--- delete-file
=END=
```
